{% extends 'seller_base.html' %}

{% block title %}My Property | OTL Platform{% endblock %}

{% block content %}
<!-- Add Property Modal -->
<div id="add-property-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm transition-opacity" onclick="closeAddPropertyModal()">
    </div>
    <div
        class="relative bg-[var(--card)] rounded-xl border border-[var(--border)] w-full max-w-4xl shadow-2xl flex flex-col max-h-[90vh]">
        <div
            class="p-6 border-b border-[var(--border)] flex justify-between items-center sticky top-0 bg-[var(--card)] z-10 shrink-0">
            <div>
                <h2 class="text-xl font-bold text-[var(--foreground)]">List Your Property</h2>
                <p class="text-sm text-[var(--muted-foreground)]">Step <span id="wizard-step-num">1</span> of 4</p>
            </div>
            <button onclick="closeAddPropertyModal()"
                class="p-2 hover:bg-[var(--muted)] rounded-full transition-colors text-[var(--foreground)]">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="p-6 space-y-6 overflow-y-auto flex-1 custom-scrollbar">
            <form id="add-property-form">
                <!-- Step 1: Location & Type -->
                <div id="step-1" class="wizard-step space-y-4">
                    <h3 class="text-lg font-semibold text-[var(--foreground)] mb-4">Location and Type</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Property Type</label>
                            <select name="property_type"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none">
                                <option value="SINGLE_FAMILY">Single Family</option>
                                <option value="CONDO">Condo</option>
                                <option value="TOWNHOME">Townhome</option>
                                <option value="APARTMENT_UNIT">Apartment Unit</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Street Address</label>
                            <input type="text" name="street_address"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none"
                                required>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">State</label>
                            <select name="state"
                                class="state-select w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none"
                                required>
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">City</label>
                            <select name="city"
                                class="city-select w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none"
                                required disabled>
                                <option value="">Select State First</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Zip Code</label>
                            <input type="text" name="zip_code"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none"
                                required>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Details -->
                <div id="step-2" class="wizard-step hidden space-y-4">
                    <h3 class="text-lg font-semibold text-[var(--foreground)] mb-4">Property Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Bedrooms</label>
                            <input type="number" name="bedrooms"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Bathrooms</label>
                            <input type="number" step="0.5" name="bathrooms"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Square Feet</label>
                            <input type="text" name="sqft"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none">
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Garage Spaces</label>
                            <input type="number" name="garage_spaces"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none">
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Listing Price ($)</label>
                            <input type="text" name="estimated_value"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none">
                        </div>
                        <div class="md:col-span-2 space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Description</label>
                            <textarea name="property_description" rows="3"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] focus:ring-1 focus:ring-[var(--accent)] outline-none"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Features -->
                <div id="step-3" class="wizard-step hidden space-y-4">
                    <h3 class="text-lg font-semibold text-[var(--foreground)] mb-4">Features</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Flooring</label>
                            <select name="feature_flooring"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] outline-none">
                                <option value="">Select...</option>
                                <option value="Hardwood">Hardwood</option>
                                <option value="Carpet">Carpet</option>
                                <option value="Tile">Tile</option>
                                <option value="Vinyl">Vinyl</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Kitchen Countertop</label>
                            <select name="feature_countertop"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] outline-none">
                                <option value="">Select...</option>
                                <option value="Granite">Granite</option>
                                <option value="Wood">Wood</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Foundation</label>
                            <select name="feature_foundation"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] outline-none">
                                <option value="">Select...</option>
                                <option value="Slab">Slab</option>
                                <option value="Pier & Beam">Pier & Beam</option>
                                <option value="Post">Post</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Cooling</label>
                            <select name="feature_cooling"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] outline-none">
                                <option value="">Select...</option>
                                <option value="Central">Central</option>
                                <option value="Window Units">Window Units</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Heating</label>
                            <select name="feature_heating"
                                class="w-full p-2 rounded-md bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] outline-none">
                                <option value="">Select...</option>
                                <option value="Gas">Gas</option>
                                <option value="Electric">Electric</option>
                                <option value="Heat Pump">Heat Pump</option>
                            </select>
                        </div>
                        <div class="space-y-2 pt-6">
                            <label class="flex items-center space-x-2 cursor-pointer text-[var(--foreground)]">
                                <input type="checkbox" name="feature_fireplace"
                                    class="rounded border-[var(--border)] text-[var(--accent)] focus:ring-[var(--accent)]">
                                <span>Has Fireplace</span>
                            </label>
                        </div>
                        <div class="col-span-1 md:col-span-2 space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Community Amenities</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="feature_amenities" value="Golf course community"
                                        class="rounded border-[var(--border)] text-[var(--accent)]">
                                    <span class="text-sm text-[var(--foreground)]">Golf course community</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="feature_amenities" value="Swimming pool"
                                        class="rounded border-[var(--border)] text-[var(--accent)]">
                                    <span class="text-sm text-[var(--foreground)]">Swimming pool</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="feature_amenities" value="Study room"
                                        class="rounded border-[var(--border)] text-[var(--accent)]">
                                    <span class="text-sm text-[var(--foreground)]">Study room</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="feature_amenities" value="Shed"
                                        class="rounded border-[var(--border)] text-[var(--accent)]">
                                    <span class="text-sm text-[var(--foreground)]">Shed</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-span-1 md:col-span-2 space-y-2">
                            <label class="text-sm font-medium text-[var(--foreground)]">Appliances</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="feature_appliances" value="Dishwasher"
                                        class="rounded border-[var(--border)] text-[var(--accent)]">
                                    <span class="text-sm text-[var(--foreground)]">Dishwasher</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="feature_appliances" value="Gas cooktop"
                                        class="rounded border-[var(--border)] text-[var(--accent)]">
                                    <span class="text-sm text-[var(--foreground)]">Gas cooktop</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="feature_appliances" value="Disposal"
                                        class="rounded border-[var(--border)] text-[var(--accent)]">
                                    <span class="text-sm text-[var(--foreground)]">Disposal</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="feature_appliances" value="Electric cooktop"
                                        class="rounded border-[var(--border)] text-[var(--accent)]">
                                    <span class="text-sm text-[var(--foreground)]">Electric cooktop</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="feature_appliances" value="Built-in oven"
                                        class="rounded border-[var(--border)] text-[var(--accent)]">
                                    <span class="text-sm text-[var(--foreground)]">Built-in oven</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Images -->
                <div id="step-4" class="wizard-step hidden space-y-4">
                    <h3 class="text-lg font-semibold text-[var(--foreground)] mb-4">Property Images (Max 6)</h3>
                    <div class="border-2 border-dashed border-[var(--border)] rounded-lg p-8 text-center hover:bg-[var(--muted)]/20 transition-colors cursor-pointer"
                        onclick="document.getElementById('img-upload').click()">
                        <i data-lucide="image-plus" class="w-12 h-12 mx-auto mb-2 text-[var(--muted-foreground)]"></i>
                        <p class="text-[var(--muted-foreground)]">Click to upload images</p>
                        <p class="text-xs text-[var(--muted-foreground)] mt-1">(JPG, PNG only. Max 5MB each)</p>
                        <input type="file" id="img-upload" multiple accept="image/*" class="hidden"
                            onchange="handleImagePreview(this)">
                    </div>
                    <div id="image-preview-grid" class="grid grid-cols-3 md:grid-cols-4 gap-4 mt-4">
                        <!-- Previews go here -->
                    </div>
                    <p id="image-error" class="text-red-500 text-sm hidden"></p>
                </div>
            </form>
        </div>

        <div
            class="p-6 border-t border-[var(--border)] flex justify-between bg-[var(--card)] sticky bottom-0 z-10 shrink-0">
            <button id="btn-prev" onclick="changeStep(-1)"
                class="px-4 py-2 border border-[var(--border)] rounded-md hover:bg-[var(--muted)] text-[var(--foreground)] hidden">Previous</button>
            <div class="flex-1"></div>
            <button id="btn-next" onclick="changeStep(1)"
                class="px-6 py-2 bg-[var(--accent)] text-[var(--bg)] font-semibold rounded-md hover:bg-[var(--accent-hover)] transition-colors">Next</button>
            <button id="btn-submit" onclick="submitProperty()"
                class="hidden px-6 py-2 bg-[var(--accent)] text-[var(--bg)] font-semibold rounded-md hover:bg-[var(--accent-hover)] transition-colors">List
                Property</button>
        </div>
    </div>
</div>

{% if seller_profile.has_active_listing %}
<div class="flex items-center justify-between">
    <div>
        <h1 class="text-3xl font-bold text-[var(--foreground)]">My Property Listing</h1>
        <p class="text-[var(--muted-foreground)]">Preview and manage your property listing</p>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
    <div class="bg-[var(--card)] rounded-lg border border-[var(--border)] p-6">
        <div class="flex items-center space-x-3">
            <div class="p-2 bg-green-100 rounded-lg">
                <i data-lucide="check-circle" class="h-5 w-5 text-green-600"></i>
            </div>
            <div>
                <p class="text-sm text-[var(--muted-foreground)]">Status</p>
                <p id="stat-status" class="text-2xl font-bold text-[var(--foreground)] capitalize">Active</p>
            </div>
        </div>
    </div>

    <div class="bg-[var(--card)] rounded-lg border border-[var(--border)] p-6">
        <div class="flex items-center space-x-3">
            <div class="p-2 bg-purple-100 rounded-lg">
                <i data-lucide="eye" class="h-5 w-5 text-purple-600"></i>
            </div>
            <div>
                <p class="text-sm text-[var(--muted-foreground)]">Total Views</p>
                <p id="stat-views" class="text-2xl font-bold text-[var(--foreground)]">234</p>
            </div>
        </div>
    </div>

    <div class="bg-[var(--card)] rounded-lg border border-[var(--border)] p-6">
        <div class="flex items-center space-x-3">
            <div class="p-2 bg-blue-100 rounded-lg">
                <i data-lucide="message-square" class="h-5 w-5 text-blue-600"></i>
            </div>
            <div>
                <p class="text-sm text-[var(--muted-foreground)]">Offers Received</p>
                <p id="stat-offers" class="text-2xl font-bold text-[var(--foreground)]">3</p>
            </div>
        </div>
    </div>
</div>

<div class="bg-[var(--card)] rounded-lg border border-[var(--border)] shadow-lg mt-6">
    <div class="p-6 pb-0">
        <div class="relative max-w-4xl mx-auto">
            <div id="prop-hero-image"
                class="group aspect-video bg-gray-700 relative w-full rounded-xl overflow-hidden shadow-sm">
                <div
                    class="absolute inset-0 bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
                    <i data-lucide="home" class="w-16 h-16 text-gray-500"></i>
                </div>

                <div class="absolute top-4 left-4 flex items-center space-x-2 z-10">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="px-3 py-1 text-sm font-medium rounded capitalize bg-green-100 text-green-800">
                        active
                    </span>
                </div>
                <div class="absolute top-4 right-4 z-10">
                    <button onclick="openEditPropertyModal(4)"
                        class="p-2 bg-white/80 hover:bg-white rounded-md transition-colors text-black">
                        <i data-lucide="edit" class="h-4 w-4"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="p-6 space-y-6">
        <div>
            <p id="prop-title" class="text-[var(--muted-foreground)] leading-relaxed text-lg mb-2">Beautiful Family Home
            </p>
            <div class="flex items-center text-[var(--muted-foreground)]">
                <i data-lucide="map-pin" class="h-4 w-4 mr-2"></i>
                <span id="prop-location">Springfield, IL</span>
            </div>
        </div>

        <div class="flex flex-wrap items-center justify-between gap-4 pb-6 border-b border-[var(--border)]">
            <div>
                <p class="text-sm text-[var(--muted-foreground)] mb-1">Listing Price</p>
                <p id="prop-price" class="text-3xl font-bold text-[var(--foreground)]">$425,000</p>
            </div>
            <div class="flex items-center space-x-6 text-[var(--muted-foreground)]">
                <div class="text-center">
                    <p id="prop-beds" class="text-2xl font-bold text-[var(--foreground)]">4</p>
                    <p class="text-sm">Bedrooms</p>
                </div>
                <div class="text-center">
                    <p id="prop-baths" class="text-2xl font-bold text-[var(--foreground)]">3</p>
                    <p class="text-sm">Bathrooms</p>
                </div>
                <div class="text-center">
                    <p id="prop-sqft" class="text-2xl font-bold text-[var(--foreground)]">2,800</p>
                    <p class="text-sm">Sqft</p>
                </div>
                <div class="text-center">
                    <p id="prop-garage" class="text-2xl font-bold text-[var(--foreground)]">2</p>
                    <p class="text-sm">Garage</p>
                </div>
            </div>
        </div>

        <div>
            <h3 class="text-lg font-semibold text-[var(--foreground)] mb-3">Key Features</h3>
            <div id="prop-features-list" class="flex flex-wrap gap-2">
            </div>
        </div>

        <div class="p-4 bg-[var(--muted)]/30 rounded-lg">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-[var(--muted-foreground)] mb-1">Your Realtor</p>
                    <p id="realtor-name" class="text-lg font-semibold text-[var(--foreground)]">Jennifer Martinez</p>
                    <p class="text-sm text-[var(--muted-foreground)] mt-1">
                        <span id="realtor-phone">(555) 123-4567</span> â€¢ <span
                            id="realtor-email">jennifer@premierrealty.com</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="flex space-x-3">
            <button onclick="openEditPropertyModal(1)"
                class="flex-1 flex items-center justify-center px-4 py-3 bg-[var(--accent)] text-[var(--bg)] font-semibold rounded-md hover:bg-[var(--accent-hover)] transition-colors">
                <i data-lucide="edit" class="h-4 w-4 mr-2"></i> Edit Listing
            </button>
        </div>
    </div>
</div>

<div class="bg-[var(--card)] rounded-lg border border-[var(--border)] p-6 mt-6">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-bold text-[var(--foreground)]">Property Features</h2>
            <p class="text-[var(--muted-foreground)]">Select the features that best describe your property</p>
        </div>
        <div id="features-actions">
        </div>
    </div>

    <div id="features-view-container" class="space-y-6">
    </div>

    <div id="features-edit-container" class="hidden bg-[var(--muted)]/10 rounded-lg p-6 space-y-8">
    </div>
</div>
{% else %}
<!-- Empty State -->
<div
    class="flex flex-col items-center justify-center min-h-[60vh] text-center space-y-6 animate-in fade-in duration-500">
    <div class="p-6 bg-[var(--muted)]/30 rounded-full ring-1 ring-[var(--border)]">
        <i data-lucide="home" class="w-16 h-16 text-[var(--muted-foreground)]"></i>
    </div>
    <div class="max-w-md space-y-2">
        <h2 class="text-3xl font-bold text-[var(--foreground)]">Property Not Listed</h2>
        <p class="text-[var(--muted-foreground)] text-lg">You haven't listed your property yet. Add your property
            details to get started with selling.</p>
    </div>
    <button onclick="openAddPropertyModal()"
        class="group flex items-center px-8 py-4 bg-[var(--accent)] text-[var(--bg)] font-bold text-lg rounded-lg hover:bg-[var(--accent-hover)] transition-all transform hover:scale-105 shadow-lg shadow-[var(--accent)]/20">
        <i data-lucide="plus-circle" class="w-6 h-6 mr-2 transition-transform group-hover:rotate-90"></i>
        List My Property
    </button>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    // --- API CONFIG ---
    const CSC_API_KEY = 'WnVWTGlEejlKbzMyOXd4c2VmdVQzZzFWTVJTb0xXWk1pNExvWVFzZQ==';
    const CSC_BASE_URL = 'https://api.countrystatecity.in/v1';
    let cachedStates = null;
    let cachedCities = {};

    async function fetchUSStates() {
        if (cachedStates) return cachedStates;
        try {
            const res = await fetch(`${CSC_BASE_URL}/countries/US/states`, {
                headers: { 'X-CSCAPI-KEY': CSC_API_KEY }
            });
            if (!res.ok) throw new Error('Failed to fetch states');
            const data = await res.json();
            data.sort((a, b) => a.name.localeCompare(b.name));
            cachedStates = data;
            return data;
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function fetchCities(stateIso) {
        if (cachedCities[stateIso]) return cachedCities[stateIso];
        try {
            const res = await fetch(`${CSC_BASE_URL}/countries/US/states/${stateIso}/cities`, {
                headers: { 'X-CSCAPI-KEY': CSC_API_KEY }
            });
            if (!res.ok) throw new Error('Failed to fetch cities');
            const data = await res.json();
            data.sort((a, b) => a.name.localeCompare(b.name));
            cachedCities[stateIso] = data;
            return data;
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function initLocationSelectors(container) {
        const stateSels = container.querySelectorAll('.state-select');

        if (stateSels.length === 0) return;

        // Load States
        const states = await fetchUSStates();
        const stateOptions = '<option value="">Select State</option>' +
            states.map(s => `<option value="${s.iso2}">${s.name}</option>`).join('');

        stateSels.forEach(stateSel => {
            stateSel.innerHTML = stateOptions;

            // Find corresponding city select
            const citySel = container.querySelector('.city-select');

            if (!citySel) return;

            stateSel.addEventListener('change', async () => {
                const stateCode = stateSel.value;
                citySel.disabled = true;
                citySel.innerHTML = '<option value="">Loading...</option>';

                if (stateCode) {
                    const cities = await fetchCities(stateCode);
                    if (cities.length === 0) {
                        citySel.innerHTML = '<option value="">No cities found</option>';
                    } else {
                        citySel.innerHTML = '<option value="">Select City</option>' +
                            cities.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                        citySel.disabled = false;
                    }
                } else {
                    citySel.innerHTML = '<option value="">Select City</option>';
                    citySel.disabled = true;
                }
            });
        });
    }

    // --- MOCKED DATA OR FROM BACKEND ---
    const propertyData = JSON.parse('{{ seller_profile_json| escapejs |default:"{ }" }}');

    // Default or existing data
    let property = {
        id: 1,
        title: propertyData.property_description || "My Property", // Fallback
        location: `${propertyData.city || ''}, ${propertyData.state || ''}`,
        price: parseFloat(propertyData.estimated_value) || 0,
        status: "active",
        views: 0, // Mocked
        offers: 0, // Mocked
        bedrooms: propertyData.bedrooms || 0,
        bathrooms: propertyData.bathrooms || 0,
        sqft: propertyData.sqft || 0,
        garage: propertyData.garage_spaces || 0,
        listingDate: "2024-01-15",
        features: [],
        structuredFeatures: {
            ...(propertyData.property_features || {}),
            propertyType: [propertyData.property_type],
        },
        images: propertyData.images || [],
        realtorName: "Unassigned", // To be implemented
        realtorPhone: "",
        realtorEmail: ""
    };

    // --- WIZARD LOGIC ---
    let currentStep = 1;
    const totalSteps = 4;
    let selectedImages = [];

    async function openEditPropertyModal(step = 1) {
        const form = document.getElementById('add-property-form');
        form.setAttribute('data-editing', 'true'); // Flag to prevent reset

        // Populate Step 1
        // Note: Using propertyData which comes from backend serialization
        // We use propertyData.property_type_val (raw) for the select value if available, 
        // fallback to propertyData.property_type (display) might not match select options if they differ.
        if (form.property_type) form.property_type.value = propertyData.property_type_val || propertyData.property_type || "";
        if (form.street_address) form.street_address.value = propertyData.street_address || "";

        // Async population for State/City
        if (form.state) {
            form.state.value = propertyData.state || "";
            // Trigger city load
            if (form.state.value) {
                const cities = await fetchCities(form.state.value);
                const citySel = form.city;
                if (citySel) {
                    citySel.innerHTML = '<option value="">Select City</option>' +
                        cities.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                    citySel.disabled = false;
                    if (propertyData.city) citySel.value = propertyData.city;
                }
            }
        }

        if (form.zip_code) form.zip_code.value = propertyData.zip_code || "";

        // Populate Step 2
        if (form.bedrooms) form.bedrooms.value = propertyData.bedrooms || "";
        if (form.bathrooms) form.bathrooms.value = propertyData.bathrooms || "";
        if (form.sqft) form.sqft.value = propertyData.sqft ? Number(propertyData.sqft).toLocaleString() : "";
        if (form.garage_spaces) form.garage_spaces.value = propertyData.garage_spaces || "";
        if (form.estimated_value) form.estimated_value.value = propertyData.estimated_value ? Number(propertyData.estimated_value).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 }) : "";
        if (form.property_description) form.property_description.value = propertyData.property_description || "";

        // Populate Step 3 (Features)
        const feats = propertyData.property_features || {};
        if (form.feature_flooring) form.feature_flooring.value = feats.flooring || "";
        if (form.feature_countertop) form.feature_countertop.value = feats.kitchenCountertop || "";
        if (form.feature_foundation) form.feature_foundation.value = feats.foundation || "";
        if (form.feature_cooling) form.feature_cooling.value = feats.cooling || "";
        if (form.feature_heating) form.feature_heating.value = feats.heating || "";
        if (form.feature_fireplace) form.feature_fireplace.checked = feats.fireplace || false;

        // Multi-checkboxes population
        if (feats.communityAmenities) {
            const amenities = Array.isArray(feats.communityAmenities) ? feats.communityAmenities : [feats.communityAmenities];
            const checkboxes = document.getElementsByName('feature_amenities');
            for (let cb of checkboxes) {
                cb.checked = amenities.includes(cb.value);
            }
        }
        if (feats.appliances) {
            const appliances = Array.isArray(feats.appliances) ? feats.appliances : [feats.appliances];
            const checkboxes = document.getElementsByName('feature_appliances');
            for (let cb of checkboxes) {
                cb.checked = appliances.includes(cb.value);
            }
        }

        // Reset Image Upload
        const grid = document.getElementById('image-preview-grid');
        grid.innerHTML = '';
        selectedImages = [];

        // Populate Existing Images
        if (propertyData.images && propertyData.images.length > 0) {
            propertyData.images.forEach(img => {
                const div = document.createElement('div');
                div.className = "relative aspect-square rounded-lg overflow-hidden border border-[var(--border)] h-32 w-full";
                div.innerHTML = `
                    <img src="${img.image}" class="w-full h-full object-cover">
                    <button type="button" class="absolute top-1 right-1 bg-black/50 hover:bg-red-500 text-white p-1 rounded-full transition-colors" onclick="deleteExistingImage(${img.id}, this)">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                `;
                grid.appendChild(div);
            });
        }

        if (window.lucide) lucide.createIcons();

        // Update Modal Title & Button
        document.querySelector('#add-property-modal h2').textContent = "Edit Your Property";
        document.getElementById('btn-submit').textContent = "Update Listing";

        openAddPropertyModal(false); // Don't reset
        currentStep = step;
        updateWizardUI();
    }

    function openAddPropertyModal(reset = true) {
        document.getElementById('add-property-modal').classList.remove('hidden');
        if (reset) {
            currentStep = 1;
            updateWizardUI();
            // Reset form if it's a fresh add
            const form = document.getElementById('add-property-form');
            if (!form.getAttribute('data-editing')) {
                form.reset();
                document.getElementById('image-preview-grid').innerHTML = '';
                selectedImages = [];
            }
        }
    }

    function closeAddPropertyModal() {
        document.getElementById('add-property-modal').classList.add('hidden');
        // Optional: clear data attribute if needed, but usually we keep it until re-open/reset
    }

    function updateWizardUI() {
        // Update UI
        document.getElementById('wizard-step-num').textContent = currentStep;

        // Toggle Steps
        document.querySelectorAll('.wizard-step').forEach((el, index) => {
            el.classList.toggle('hidden', index + 1 !== currentStep);
        });

        // Toggle Buttons
        document.getElementById('btn-prev').classList.toggle('hidden', currentStep === 1);

        if (currentStep === totalSteps) {
            document.getElementById('btn-next').classList.add('hidden');
            document.getElementById('btn-submit').classList.remove('hidden');
        } else {
            document.getElementById('btn-next').classList.remove('hidden');
            document.getElementById('btn-submit').classList.add('hidden');
        }
    }

    function changeStep(direction) {
        // Validate current step
        if (direction === 1 && !validateStep(currentStep)) return;

        currentStep += direction;
        updateWizardUI();
    }

    // --- FORMATTING LOGIC ---
    function formatNumberInput(input) {
        let val = input.value.replace(/,/g, '').replace(/[^0-9.]/g, '');
        const parts = val.split('.');
        if (parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
        if (val === '') {
            input.value = '';
            return;
        }
        const sides = val.split('.');
        sides[0] = sides[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = sides.join('.');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const estInput = document.querySelector('input[name="estimated_value"]');
        const sqftInput = document.querySelector('input[name="sqft"]');

        if (estInput) {
            estInput.addEventListener('input', (e) => formatNumberInput(e.target));
        }
        if (sqftInput) {
            sqftInput.addEventListener('input', (e) => formatNumberInput(e.target));
        }

        initLocationSelectors(document.getElementById('add-property-form'));
    });

    function validateStep(step) {
        // Basic validation
        if (step === 1) {
            const form = document.getElementById('add-property-form');
            if (!form.street_address.value || !form.city.value || !form.state.value || !form.zip_code.value) {
                alert('Please fill in all address fields');
                return false;
            }
        }
        return true;
    }

    function handleImagePreview(input) {
        const grid = document.getElementById('image-preview-grid');
        const error = document.getElementById('image-error');

        if (input.files.length + selectedImages.length > 6) {
            error.textContent = "Maximum 6 images allowed";
            error.classList.remove('hidden');
            return;
        }

        error.classList.add('hidden');

        Array.from(input.files).forEach(file => {
            selectedImages.push(file);

            const reader = new FileReader();
            reader.onload = (e) => {
                const div = document.createElement('div');
                div.className = "relative aspect-square rounded-lg overflow-hidden border border-[var(--border)] h-32 w-full";
                div.innerHTML = `
        <img src="${e.target.result}" class="w-full h-full object-cover">
            <button type="button" class="absolute top-1 right-1 bg-black/50 hover:bg-red-500 text-white p-1 rounded-full transition-colors" onclick="removeImage(this)">
                <i data-lucide="x" class="w-3 h-3"></i>
            </button>
            `;
                grid.appendChild(div);
                if (window.lucide) lucide.createIcons();
            };
            reader.readAsDataURL(file);
        });
    }

    function removeImage(btn) {
        // For new uploads: find in selectedImages and remove
        // This is a bit tricky since we just pushed to array. 
        // For simplicity in this demo, we'll just remove from DOM and clear array if needed or implement better tracking
        // But since user asked for "seeing previous images", we focused on that.
        // Ideally, we'd track index. For now, removing from DOM.

        // If we want to strictly sync with selectedImages, we need to store index on the element.
        // Let's assume for now user won't remove new uploads in complex ways or we clear all if they re-upload.
        btn.closest('div').remove();

        // Re-sync logic would go here (filtering selectedImages)
        // For now, let's just assume we need to re-validate count on submit
    }

    async function deleteExistingImage(imageId, btn) {
        if (!confirm("Are you sure you want to delete this image?")) return;

        try {
            const response = await fetch(`/api/v1/seller/property-image/${imageId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });

            if (response.ok) {
                btn.closest('div').remove();
                // Update local property data to reflect removal so if we re-open modal it's gone
                propertyData.images = propertyData.images.filter(img => img.id !== imageId);
                // Also update the main view images if we are in "view" mode (re-render)
                property.images = propertyData.images;
                renderPropertyImages();
            } else {
                alert("Failed to delete image.");
            }
        } catch (e) {
            console.error(e);
            alert("Error deleting image.");
        }
    }

    async function submitProperty() {
        const form = document.getElementById('add-property-form');
        const formData = new FormData(form);

        // Sanitize numeric fields (remove commas)
        const estValue = formData.get('estimated_value');
        if (estValue) formData.set('estimated_value', estValue.replace(/,/g, ''));

        const sqft = formData.get('sqft');
        if (sqft) formData.set('sqft', sqft.replace(/,/g, ''));

        // Add structured features
        const features = {
            flooring: formData.get('feature_flooring'),
            kitchenCountertop: formData.get('feature_countertop'),
            foundation: formData.get('feature_foundation'),
            cooling: formData.get('feature_cooling'),
            heating: formData.get('feature_heating'),
            fireplace: !!formData.get('feature_fireplace'),
            communityAmenities: formData.getAll('feature_amenities'),
            appliances: formData.getAll('feature_appliances')
        };
        formData.append('property_features', JSON.stringify(features));
        formData.append('has_active_listing', 'true');

        // Add images
        selectedImages.forEach((file) => {
            formData.append('upload_images', file);
        });

        try {
            const response = await fetch('/api/v1/seller/profile/', {
                method: 'PATCH',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    // Content-Type not set for FormData, browser sets it with boundary
                },
                body: formData
            });

            if (response.ok) {
                // Success
                window.location.reload();
            } else {
                const data = await response.json();
                console.error(data);
                alert('Error updating property: ' + JSON.stringify(data));
            }
        } catch (error) {
            console.error(error);
            alert('An error occurred');
        }
    }

    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- EXISTING DASHBOARD LOGIC ---
    // Note: I will only enable these if we have a listing

    // {% if seller_profile.has_active_listing %}
    // --- CONSTANTS & OPTIONS ---
    const PROPERTY_TYPE_OPTIONS = ["Single Family", "Condo", "Townhome", "Apartment unit"];
    const FLOORING_OPTIONS = ["Hardwood", "Carpet", "Tile", "Vinyl"];
    const KITCHEN_COUNTERTOP_OPTIONS = ["Granite", "Wood"];
    const COMMUNITY_AMENITIES_OPTIONS = ["Golf course community", "Swimming pool", "Study room", "Shed"];
    const FOUNDATION_OPTIONS = ["Slab", "Pier & Beam", "Post"];
    const HEATING_OPTIONS = ["Gas", "Electric"];
    const COOLING_OPTIONS = ["Central", "Electric"];
    const APPLIANCES_OPTIONS = ["Dishwasher", "Gas cooktop", "Disposal", "Electric cooktop", "Built-in oven"];

    let isEditingFeatures = false;
    let editedFeatures = JSON.parse(JSON.stringify(property.structuredFeatures)); // Deep copy

    const dom = {
        // Stats & Info
        statStatus: document.getElementById('stat-status'),
        statViews: document.getElementById('stat-views'),
        statOffers: document.getElementById('stat-offers'),
        propTitle: document.getElementById('prop-title'),
        propLocation: document.getElementById('prop-location'),
        propPrice: document.getElementById('prop-price'),
        propBeds: document.getElementById('prop-beds'),
        propBaths: document.getElementById('prop-baths'),
        propSqft: document.getElementById('prop-sqft'),
        propGarage: document.getElementById('prop-garage'),
        propFeaturesList: document.getElementById('prop-features-list'),
        realtorName: document.getElementById('realtor-name'),
        realtorPhone: document.getElementById('realtor-phone'),
        realtorEmail: document.getElementById('realtor-email'),
        propHeroImage: document.getElementById('prop-hero-image'),

        // Features Section
        featuresActions: document.getElementById('features-actions'),
        featuresViewContainer: document.getElementById('features-view-container'),
        featuresEditContainer: document.getElementById('features-edit-container')
    };

    function init() {
        if (window.lucide) lucide.createIcons();
        renderHeaderInfo();
        renderFeaturesSection();
        renderPropertyImages();
    }

    function renderHeaderInfo() {
        if (!dom.propTitle) return; // Guard

        // Description Logic (Replacing Title)
        const desc = property.title || "No description provided.";
        const charLimit = 250;

        if (desc.length > charLimit) {
            const shortText = desc.substring(0, charLimit);

            // Initial render
            dom.propTitle.innerHTML = `
                <span id="desc-content">${shortText}...</span>
                <button id="desc-toggle" class="text-[var(--accent)] font-bold cursor-pointer hover:underline ml-1 text-base">Show more</button>
            `;

            const toggleBtn = document.getElementById('desc-toggle');
            const contentSpan = document.getElementById('desc-content');
            let isExpanded = false;

            toggleBtn.addEventListener('click', function () {
                isExpanded = !isExpanded;
                if (isExpanded) {
                    contentSpan.textContent = desc;
                    this.textContent = "Show less";
                } else {
                    contentSpan.textContent = shortText + "...";
                    this.textContent = "Show more";
                }
            });
        } else {
            dom.propTitle.textContent = desc;
        }

        dom.propLocation.textContent = property.location;
        dom.propPrice.textContent = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(property.price);

        dom.propBeds.textContent = property.bedrooms;
        dom.propBaths.textContent = property.bathrooms;
        dom.propSqft.textContent = (property.sqft || 0).toLocaleString();
        dom.propGarage.textContent = property.garage;
    }

    function renderPropertyImages() {
        if (property.images && property.images.length > 0) {
            // Clear existing placeholder content except the absolute positioned controls
            const controls = Array.from(dom.propHeroImage.children).filter(el =>
                el.classList.contains('absolute') && !el.classList.contains('inset-0')
            );

            dom.propHeroImage.innerHTML = '';

            // Create scroll container
            const container = document.createElement('div');
            container.className = "flex overflow-x-auto snap-x snap-mandatory w-full h-full scrollbar-hide no-scrollbar scroll-smooth";

            property.images.forEach(img => {
                const wrapper = document.createElement('div');
                wrapper.className = "flex-shrink-0 w-full h-full snap-center relative";

                const imageEl = document.createElement('img');
                imageEl.src = img.image;
                imageEl.className = "w-full h-full object-cover";

                wrapper.appendChild(imageEl);
                container.appendChild(wrapper);
            });

            dom.propHeroImage.appendChild(container);

            // Add Scroll Buttons if multiple images
            if (property.images.length > 1) {
                const btnClass = "absolute top-1/2 -translate-y-1/2 p-2 bg-black/50 hover:bg-black/70 text-white rounded-full transition-all duration-300 z-20 cursor-pointer opacity-0 group-hover:opacity-100";

                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '<i data-lucide="chevron-left" class="w-6 h-6"></i>';
                prevBtn.className = `${btnClass} left-4`;
                prevBtn.onclick = (e) => {
                    e.preventDefault();
                    container.scrollBy({ left: -container.offsetWidth, behavior: 'smooth' });
                };

                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = '<i data-lucide="chevron-right" class="w-6 h-6"></i>';
                nextBtn.className = `${btnClass} right-4`;
                nextBtn.onclick = (e) => {
                    e.preventDefault();
                    container.scrollBy({ left: container.offsetWidth, behavior: 'smooth' });
                };

                dom.propHeroImage.appendChild(prevBtn);
                dom.propHeroImage.appendChild(nextBtn);
            }

            // Edit Button (Top Right)
            const editBtnContainer = document.createElement('div');
            editBtnContainer.className = "absolute top-4 right-4 z-10";
            editBtnContainer.innerHTML = `
            <button onclick="openEditPropertyModal(4)" class="p-2 bg-white/80 hover:bg-white rounded-md transition-colors text-black">
                <i data-lucide="edit" class="h-4 w-4"></i>
            </button>
            `;
            dom.propHeroImage.appendChild(editBtnContainer);

            // Re-append other controls (like status badge)
            const otherControls = controls.filter(c => !c.querySelector('button i[data-lucide="edit"]'));
            otherControls.forEach(c => dom.propHeroImage.appendChild(c));

            if (window.lucide) lucide.createIcons();
        }
    }

    function renderFeaturesSection() {
        // Render Actions (Edit vs Save/Cancel)
        if (isEditingFeatures) {
            dom.featuresActions.innerHTML = `
                <div class="flex space-x-2">
                    <button id="btn-cancel-features" class="px-4 py-2 border border-[var(--border)] rounded-md text-[var(--foreground)] hover:bg-[var(--muted)]">Cancel</button>
                    <button id="btn-save-features" class="px-4 py-2 bg-[var(--accent)] text-[var(--bg)] rounded-md hover:bg-[var(--accent-hover)]">Save Features</button>
                </div>
            `;
        } else {
            dom.featuresActions.innerHTML = `
                <button id="btn-edit-features" class="flex items-center px-4 py-2 bg-[var(--card)] border border-[var(--border)] text-[var(--foreground)] rounded-md hover:bg-[var(--muted)]">
                    <i data-lucide="edit" class="h-4 w-4 mr-2"></i> Edit Features
                </button>
            `;
        }

        // Toggle Containers
        dom.featuresViewContainer.classList.toggle('hidden', isEditingFeatures);
        dom.featuresEditContainer.classList.toggle('hidden', !isEditingFeatures);

        if (isEditingFeatures) {
            renderEditForm();
        } else {
            renderViewMode();
        }

        // Re-bind listeners for dynamic buttons
        bindFeatureActionListeners();
        if (window.lucide) lucide.createIcons();
    }

    function renderViewMode() {
        const sf = property.structuredFeatures;
        let html = '';

        const createSection = (title, items) => {
            if (!items || (Array.isArray(items) && items.length === 0)) return '';
            const badges = Array.isArray(items)
                ? items.map(i => `<span class="px-3 py-1 bg-[var(--muted)]/30 text-[var(--foreground)] text-sm rounded-full">${i}</span>`).join('')
                : `<span class="px-3 py-1 bg-[var(--muted)]/30 text-[var(--foreground)] text-sm rounded-full">${items}</span>`;

            return `
            <div>
                <h3 class="text-lg font-semibold text-[var(--foreground)] mb-3">${title}</h3>
                <div class="flex flex-wrap gap-2">${badges}</div>
            </div>
            `;
        };

        html += createSection('Property Type', sf.propertyType);
        html += createSection('Flooring', sf.flooring);
        html += createSection('Kitchen Countertop', sf.kitchenCountertop);
        html += createSection('Community and Amenities', sf.communityAmenities);
        html += createSection('Foundation', sf.foundation);

        // Heating & Cooling Combined
        const hvacItems = [];
        if (sf.fireplace) hvacItems.push('Fireplace');
        if (sf.heating) hvacItems.push(`Heating: ${sf.heating}`);
        if (sf.cooling) hvacItems.push(`Cooling: ${sf.cooling}`);

        if (hvacItems.length > 0) {
            html += `
                <div>
                    <h3 class="text-lg font-semibold text-[var(--foreground)] mb-3">Heating and Cooling</h3>
                    <div class="flex flex-wrap gap-2">
                        ${hvacItems.map(i => `<span class="px-3 py-1 bg-[var(--muted)]/30 text-[var(--foreground)] text-sm rounded-full">${i}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        html += createSection('Appliances', sf.appliances);

        dom.featuresViewContainer.innerHTML = html || '<p class="text-[var(--muted-foreground)]">No features listed.</p>';
    }

    function renderEditForm() {
        // Helper for Selects
        const createSelect = (id, label, options, value) => `
            <div class="space-y-2">
                <label class="text-sm font-medium text-[var(--foreground)]">${label}</label>
                <select id="${id}" class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    <option value="">Select ${label}</option>
                    ${options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>
            </div>
            `;

        // Helper for Checkboxes (Single)
        const createCheckbox = (id, label, checked) => `
            <div class="flex items-center space-x-2">
                <input type="checkbox" id="${id}" class="rounded border-[var(--border)] text-[var(--accent)] focus:ring-[var(--accent)]" ${checked ? 'checked' : ''}>
                    <label for="${id}" class="text-sm font-normal text-[var(--foreground)] cursor-pointer">${label}</label>
            </div>
            `;

        // Helper for Group Checkboxes
        const createCheckboxGroup = (groupId, title, options, selectedValues) => `
            <div>
                <h3 class="text-lg font-semibold text-[var(--foreground)] mb-4">${title}</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    ${options.map(opt => `
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" data-group="${groupId}" value="${opt}" id="${groupId}-${opt.replace(/\s+/g, '-')}" 
                                class="rounded border-[var(--border)] text-[var(--accent)] focus:ring-[var(--accent)]" 
                                ${selectedValues && selectedValues.includes(opt) ? 'checked' : ''}>
                            <label for="${groupId}-${opt.replace(/\s+/g, '-')}" class="text-sm font-normal text-[var(--foreground)] cursor-pointer">${opt}</label>
                        </div>
                    `).join('')}
                </div>
            </div>
            `;

        let html = '';

        html += createCheckboxGroup('propType', 'Property Type', PROPERTY_TYPE_OPTIONS, editedFeatures.propertyType || []);
        html += `<div class="pt-4 border-t border-[var(--border)]">` + createSelect('input-flooring', 'Flooring', FLOORING_OPTIONS, editedFeatures.flooring) + `</div>`;
        html += `<div class="pt-4 border-t border-[var(--border)]">` + createSelect('input-counter', 'Kitchen Countertop', KITCHEN_COUNTERTOP_OPTIONS, editedFeatures.kitchenCountertop) + `</div>`;
        html += `<div class="pt-4 border-t border-[var(--border)]">` + createCheckboxGroup('amenities', 'Community and Amenities', COMMUNITY_AMENITIES_OPTIONS, editedFeatures.communityAmenities || []) + `</div>`;
        html += `<div class="pt-4 border-t border-[var(--border)]">` + createSelect('input-foundation', 'Foundation', FOUNDATION_OPTIONS, editedFeatures.foundation) + `</div>`;

        // Heating & Cooling
        html += `
            <div class="pt-4 border-t border-[var(--border)]">
                <h3 class="text-lg font-semibold text-[var(--foreground)] mb-4">Heating and Cooling</h3>
                <div class="space-y-4">
                    ${createCheckbox('input-fireplace', 'Fireplace', editedFeatures.fireplace)}
                    ${createSelect('input-heating', 'Heating', HEATING_OPTIONS, editedFeatures.heating)}
                    ${createSelect('input-cooling', 'Cooling', COOLING_OPTIONS, editedFeatures.cooling)}
                </div>
            </div>
            `;

        html += `<div class="pt-4 border-t border-[var(--border)]">` + createCheckboxGroup('appliances', 'Appliances', APPLIANCES_OPTIONS, editedFeatures.appliances || []) + `</div>`;

        dom.featuresEditContainer.innerHTML = html;
    }

    function bindFeatureActionListeners() {
        const btnEdit = document.getElementById('btn-edit-features');
        const btnCancel = document.getElementById('btn-cancel-features');
        const btnSave = document.getElementById('btn-save-features');

        if (btnEdit) {
            btnEdit.addEventListener('click', () => {
                isEditingFeatures = true;
                editedFeatures = JSON.parse(JSON.stringify(property.structuredFeatures)); // Reset edit state to current props
                renderFeaturesSection();
            });
        }

        if (btnCancel) {
            btnCancel.addEventListener('click', () => {
                isEditingFeatures = false;
                renderFeaturesSection();
            });
        }

        if (btnSave) {
            btnSave.addEventListener('click', () => {
                saveFeatures();
            });
        }
    }

    async function saveFeatures() {
        // Harvest data from inputs

        // 1. Single Selects
        editedFeatures.flooring = document.getElementById('input-flooring').value;
        editedFeatures.kitchenCountertop = document.getElementById('input-counter').value;
        editedFeatures.foundation = document.getElementById('input-foundation').value;
        editedFeatures.heating = document.getElementById('input-heating').value;
        editedFeatures.cooling = document.getElementById('input-cooling').value;

        // 2. Single Checkboxes
        editedFeatures.fireplace = document.getElementById('input-fireplace').checked;

        // 3. Group Checkboxes
        const getGroupValues = (groupId) => {
            return Array.from(document.querySelectorAll(`input[data-group="${groupId}"]:checked`)).map(cb => cb.value);
        };

        editedFeatures.propertyType = getGroupValues('propType');
        editedFeatures.communityAmenities = getGroupValues('amenities');
        editedFeatures.appliances = getGroupValues('appliances');

        // Save to main property object (Optimistic update)
        property.structuredFeatures = JSON.parse(JSON.stringify(editedFeatures));

        // Backend Update
        const formData = new FormData();
        formData.append('property_features', JSON.stringify(editedFeatures));
        // Note: For property type, the backend expects a single string value for the main field, 
        // but our UI allows multiple checkboxes. We'll just sync the first one if available or ignore for now
        // as property_type is a specific field in the model.
        if (editedFeatures.propertyType && editedFeatures.propertyType.length > 0) {
            // Mapping readable values back to keys if necessary, strictly simplest case:
            // formData.append('property_type', ...); 
        }

        try {
            const response = await fetch('/api/v1/seller/profile/', {
                method: 'PATCH',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            });

            if (!response.ok) {
                console.error("Failed to save features");
                // Revert optimistic update?
            }
        } catch (e) {
            console.error(e);
        }

        // Switch mode
        isEditingFeatures = false;
        renderFeaturesSection();
    }

    // Run Init
    init();
    // {% endif %}

    if (window.lucide) lucide.createIcons();
</script>
{% endblock %}