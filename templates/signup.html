{% extends 'base.html' %}

{% block title %}Sign Up | OTL Platform{% endblock %}

{% block content %}
<div class="min-h-screen bg-[var(--bg)] flex items-center justify-center p-4 sm:p-6">
    <div class="w-full max-w-7xl space-y-8">

        <div class="text-center space-y-2 mt-4 sm:mt-0">
            <h1 class="font-heading text-2xl sm:text-3xl text-[var(--foreground)]">
                Join OTL Platform
            </h1>
            <p class="font-body text-sm sm:text-base text-[var(--muted-foreground)]">
                Choose your account type to get started
            </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8">

            <div class="card bg-[var(--card)] rounded-lg border border-[var(--border)] shadow-lg">
                <div class="card-body p-4 sm:p-6 lg:p-8">
                    <form id="signup-form" class="space-y-6">

                        <div class="space-y-4">
                            <label class="label">
                                <span class="label-text text-[var(--foreground)] font-medium text-base">I am a:</span>
                            </label>
                            <div class="grid grid-cols-2 gap-3 sm:gap-4">
                                <button type="button" onclick="selectUserType('buyer')" id="btn-buyer"
                                    class="user-type-btn btn h-auto min-h-0 block p-3 sm:p-4 rounded-lg border-2 text-left transition-all border-[var(--accent)] bg-[var(--accent)]/10 hover:bg-[var(--accent)]/20 hover:border-[var(--accent)]">
                                    <div
                                        class="font-heading text-base sm:text-lg text-[var(--foreground)] mb-1 normal-case">
                                        Buyer</div>
                                    <div
                                        class="text-xs sm:text-sm text-[var(--muted-foreground)] font-normal normal-case whitespace-normal">
                                        Looking to purchase
                                        properties</div>
                                </button>
                                <button type="button" onclick="selectUserType('realtor')" id="btn-realtor"
                                    class="user-type-btn btn btn-outline h-auto min-h-0 block p-3 sm:p-4 rounded-lg border-2 border-[var(--border)] hover:border-[var(--accent)]/50 text-left transition-all">
                                    <div
                                        class="font-heading text-base sm:text-lg text-[var(--foreground)] mb-1 normal-case">
                                        Realtor
                                    </div>
                                    <div
                                        class="text-xs sm:text-sm text-[var(--muted-foreground)] font-normal normal-case whitespace-normal">
                                        Licensed real estate
                                        professional</div>
                                </button>
                                <button type="button" onclick="selectUserType('seller')" id="btn-seller"
                                    class="user-type-btn btn btn-outline h-auto min-h-0 block p-3 sm:p-4 rounded-lg border-2 border-[var(--border)] hover:border-[var(--accent)]/50 text-left transition-all">
                                    <div
                                        class="font-heading text-base sm:text-lg text-[var(--foreground)] mb-1 normal-case">
                                        Seller
                                    </div>
                                    <div
                                        class="text-xs sm:text-sm text-[var(--muted-foreground)] font-normal normal-case whitespace-normal">
                                        Want to sell your
                                        property</div>
                                </button>
                                <button type="button" onclick="selectUserType('partner')" id="btn-partner"
                                    class="user-type-btn btn btn-outline h-auto min-h-0 block p-3 sm:p-4 rounded-lg border-2 border-[var(--border)] hover:border-[var(--accent)]/50 text-left transition-all">
                                    <div
                                        class="font-heading text-base sm:text-lg text-[var(--foreground)] mb-1 normal-case">
                                        Partner
                                    </div>
                                    <div
                                        class="text-xs sm:text-sm text-[var(--muted-foreground)] font-normal normal-case whitespace-normal">
                                        Business partner or
                                        service provider</div>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text text-[var(--foreground)] font-medium">First Name *</span>
                                </label>
                                <input type="text" placeholder="Enter your first name" required
                                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                            </div>
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text text-[var(--foreground)] font-medium">Last Name *</span>
                                </label>
                                <input type="text" placeholder="Enter your last name" required
                                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                            </div>
                        </div>

                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text text-[var(--foreground)] font-medium">Email Address *</span>
                            </label>
                            <input type="email" placeholder="Enter your email address" required
                                class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text text-[var(--foreground)] font-medium">Password *</span>
                                </label>
                                <input type="password" placeholder="Create a password" required
                                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                            </div>
                            <div class="form-control w-full">
                                <label class="label">
                                    <span class="label-text text-[var(--foreground)] font-medium">Confirm Password
                                        *</span>
                                </label>
                                <input type="password" placeholder="Confirm your password" required
                                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                            </div>
                        </div>

                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text text-[var(--foreground)] font-medium">Phone Number *</span>
                            </label>
                            <input type="tel" placeholder="Enter your phone number" required
                                class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                        </div>

                        <div id="dynamic-fields-container">
                        </div>

                        <button type="submit" id="submit-btn"
                            class="btn btn-block font-heading text-base bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-[var(--bg)] border-none rounded transition-all font-semibold cursor-pointer">
                            Verify and Create Account
                        </button>

                        <div class="text-center text-sm text-[var(--muted-foreground)]">
                            Already have an account?
                            <a href="{% url 'login' %}"
                                class="link link-hover text-[var(--accent)] hover:text-[var(--accent-hover)] transition-colors font-medium">
                                Sign in here
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="flex flex-col">
                <div class="mb-4 text-center lg:text-left">
                    <h2 class="font-heading text-2xl sm:text-3xl text-[var(--foreground)] mb-2">Pricing Plan</h2>
                    <p class="text-sm text-[var(--muted-foreground)]">
                        See what you'll pay for your <span id="pricing-user-type-label">buyer</span> account
                    </p>
                </div>
                <div class="relative w-full" id="pricing-plan-container">
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- OTP Modal -->
<dialog id="otp_modal" class="modal">
    <div class="modal-box bg-[var(--card)] border border-[var(--border)]">
        <h3 class="font-heading text-lg font-bold text-[var(--foreground)]">Verify Your Email</h3>
        <p class="py-4 text-[var(--muted-foreground)]">Please enter the 8-digit code sent to your email address.</p>
        <div class="form-control w-full">
            <input type="text" id="otp-input" placeholder="Enter 8-digit code" maxlength="8"
                class="input input-bordered w-full text-center tracking-[0.5em] text-xl font-mono bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
        </div>
        <div id="otp-error" class="text-error text-sm mt-2 hidden"></div>
        <div class="modal-action">
            <button type="button" onclick="verifyOTP()" id="verify-btn"
                class="btn bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-[var(--bg)] border-none">Verify</button>
        </div>
    </div>
</dialog>

<script>
    // --- API CONFIG ---
    const CSC_API_KEY = 'WnVWTGlEejlKbzMyOXd4c2VmdVQzZzFWTVJTb0xXWk1pNExvWVFzZQ==';
    const CSC_BASE_URL = 'https://api.countrystatecity.in/v1';
    let cachedStates = null;
    let cachedCities = {};

    async function fetchUSStates() {
        if (cachedStates) return cachedStates;
        try {
            const res = await fetch(`${CSC_BASE_URL}/countries/US/states`, {
                headers: { 'X-CSCAPI-KEY': CSC_API_KEY }
            });
            if (!res.ok) throw new Error('Failed to fetch states');
            const data = await res.json();
            data.sort((a, b) => a.name.localeCompare(b.name));
            cachedStates = data;
            return data;
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function fetchCities(stateIso) {
        if (cachedCities[stateIso]) return cachedCities[stateIso];
        try {
            const res = await fetch(`${CSC_BASE_URL}/countries/US/states/${stateIso}/cities`, {
                headers: { 'X-CSCAPI-KEY': CSC_API_KEY }
            });
            if (!res.ok) throw new Error('Failed to fetch cities');
            const data = await res.json();
            data.sort((a, b) => a.name.localeCompare(b.name));
            cachedCities[stateIso] = data;
            return data;
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function initLocationSelectors(container) {
        const stateSels = container.querySelectorAll('.state-select');

        if (stateSels.length === 0) return;

        // Load States for all selectors found
        const states = await fetchUSStates();
        const stateOptions = '<option value="">Select State</option>' +
            states.map(s => `<option value="${s.iso2}">${s.name}</option>`).join('');

        stateSels.forEach(stateSel => {
            stateSel.innerHTML = stateOptions;

            // Find corresponding city select
            // We assume it's in the same dynamic container and uniquely identifiable relative to the state select or just by class if only one set exists
            const citySel = container.querySelector('.city-select');

            if (!citySel) return;

            stateSel.addEventListener('change', async () => {
                const stateCode = stateSel.value;
                citySel.disabled = true;
                citySel.innerHTML = '<option value="">Loading...</option>';

                if (stateCode) {
                    const cities = await fetchCities(stateCode);
                    if (cities.length === 0) {
                        citySel.innerHTML = '<option value="">No cities found</option>';
                    } else {
                        citySel.innerHTML = '<option value="">Select City</option>' +
                            cities.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                        citySel.disabled = false;
                    }
                } else {
                    citySel.innerHTML = '<option value="">Select City</option>';
                    citySel.disabled = true;
                }
            });
        });
    }

    // --- STATE ---
    let currentUserType = 'buyer';
    let selectedBuyerPlan = 'pro'; // Default to pro
    let signedUpEmail = '';

    // --- PRICING DATA FETCH ---
    async function initPricing() {
        try {
            const [pricingRes, passRes] = await Promise.all([
                fetch('/api/v1/pricing-plans/'),
                fetch('/api/v1/access-pass-types/')
            ]);

            if (pricingRes.ok) {
                const data = await pricingRes.json();
                updatePlanConfigs(data);
            }
            if (passRes.ok) {
                const passData = await passRes.json();
                updateAccessPassConfig(passData);
            }
        } catch (e) {
            console.error("Failed to load dynamic pricing, using defaults", e);
        }

        // Initial Render
        renderPricingPlan(currentUserType);
    }

    function updatePlanConfigs(data) {
        data.forEach(p => {
            if (p.plan_type === 'buyer') {
                if (planConfigs.buyer && planConfigs.buyer.membership) {
                    planConfigs.buyer.membership.upfrontPrice = parseFloat(p.buyer_upfront_price);
                    planConfigs.buyer.membership.monthlyPrice = parseFloat(p.buyer_monthly_price);
                }
                // Legacy access pass price ignored here, handled by updateAccessPassConfig
            } else if (p.plan_type === 'seller' && planConfigs.seller) {
                planConfigs.seller.setupFee = parseFloat(p.setup_fee);
                planConfigs.seller.listingFee = parseFloat(p.listing_fee);
                planConfigs.seller.total = parseFloat(p.setup_fee) + parseFloat(p.listing_fee);
            } else if (p.plan_type === 'realtor' && planConfigs.realtor) {
                planConfigs.realtor.setupFee = parseFloat(p.setup_fee);
                planConfigs.realtor.accessFee = parseFloat(p.access_fee);
                planConfigs.realtor.monthly = parseFloat(p.monthly_fee);
            } else if (p.plan_type === 'partner' && planConfigs.partner) {
                planConfigs.partner.setupFee = parseFloat(p.setup_fee);
                planConfigs.partner.accessFee = parseFloat(p.access_fee);
                planConfigs.partner.monthly = parseFloat(p.monthly_fee);
            }
        });
    }

    function updateAccessPassConfig(data) {
        if (!data || data.length === 0) return;

        // Find 'basic' or default to first
        let pass = data.find(p => p.slug === 'basic') || data[0];

        if (pass && planConfigs.buyer && planConfigs.buyer.accessPass) {
            planConfigs.buyer.accessPass.name = pass.name;
            planConfigs.buyer.accessPass.price = parseFloat(pass.price);
            planConfigs.buyer.accessPass.duration = `${pass.days_duration} Days`;
            planConfigs.buyer.accessPass.description = `Required to unlock, contact & submit offers (${pass.properties_limit} unlocks)`;
        }
    }

    // --- DOM ELEMENTS ---
    const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
    const pricingPlanContainer = document.getElementById('pricing-plan-container');
    const pricingUserTypeLabel = document.getElementById('pricing-user-type-label');
    const userTypeButtons = document.querySelectorAll('.user-type-btn');

    // --- TEMPLATES (HTML Strings) ---
    // Added text-base to inputs to prevent iOS zoom
    // Added grid-cols-1 md:grid-cols-2 to ensure stacking on mobile

    const formTemplates = {
        buyer: `
            <div class="space-y-4 p-4 bg-[var(--muted)]/30 rounded-lg border border-[var(--border)]">
                <h3 class="font-heading text-lg text-[var(--foreground)]">Buyer Preferences</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Preferred State *</span>
                        </label>
                        <select class="state-select select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Preferred City *</span>
                        </label>
                        <select class="city-select select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]" required disabled>
                            <option value="">Select State First</option>
                        </select>
                    </div>
                    <div class="form-control w-full md:col-span-2">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Budget Range *</span>
                        </label>
                        <select required class="select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                            <option value="">Select budget range</option>
                            <option value="0-200000">$0 - $200,000</option>
                            <option value="200000-400000">$200,000 - $400,000</option>
                            <option value="400000-600000">$400,000 - $600,000</option>
                            <option value="600000-800000">$600,000 - $800,000</option>
                            <option value="800000-1000000">$800,000 - $1,000,000</option>
                            <option value="1000000+">$1,000,000+</option>
                        </select>
                    </div>
                </div>
            </div>`,
        realtor: `
            <div class="space-y-4 p-4 bg-[var(--muted)]/30 rounded-lg border border-[var(--border)]">
                <h3 class="font-heading text-lg text-[var(--foreground)]">Professional Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">License Number *</span>
                        </label>
                        <input type="text" placeholder="Real estate license number" required class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Company/Brokerage *</span>
                        </label>
                        <input type="text" placeholder="Company or brokerage name" required class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    </div>
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text text-[var(--foreground)] font-medium">Years of Experience *</span>
                    </label>
                    <select class="select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                        <option value="">Select experience level</option>
                        <option value="ENTRY">0-2 years</option>
                        <option value="INTERMEDIATE">3-5 years</option>
                        <option value="EXPERIENCED">6-10 years</option>
                        <option value="EXPERT">10+ years</option>
                    </select>
                </div>
            </div>`,
        seller: `
            <div class="space-y-4 p-4 bg-[var(--muted)]/30 rounded-lg border border-[var(--border)]">
                <h3 class="font-heading text-lg text-[var(--foreground)]">Property Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Property Type *</span>
                        </label>
                        <select required class="select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                            <option value="">Select property type</option>
                            <option value="SINGLE_FAMILY">Single family</option>
                            <option value="CONDO">Condo</option>
                            <option value="TOWNHOME">Townhome</option>
                            <option value="APARTMENT_UNIT">Apartment unit</option>
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Estimated Value *</span>
                        </label>
                        <input type="text" name="estimated_value" placeholder="Property value estimate" required class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">State *</span>
                        </label>
                        <select class="state-select select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">City *</span>
                        </label>
                        <select class="city-select select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]" required disabled>
                            <option value="">Select State First</option>
                        </select>
                    </div>
                </div>
            </div>`,
        partner: `
            <div class="space-y-4 p-4 bg-[var(--muted)]/30 rounded-lg border border-[var(--border)]">
                <h3 class="font-heading text-lg text-[var(--foreground)]">Business Partnership Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Company/Business Name *</span>
                        </label>
                        <input type="text" placeholder="Your business or company name" required class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Partnership Type *</span>
                        </label>
                        <select required class="select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                            <option value="">Select partnership type</option>
                            <option value="REAL_ESTATE_AGENT">Real Estate Agency</option>
                            <option value="MORTGAGE">Mortgage Lender</option>
                            <option value="HOME_INSPECTION">Home Inspector</option>
                            <option value="CONTRACTOR">Contractor</option>
                            <option value="MOVING_COMPANY">Moving Company</option>
                            <option value="PROPERTY_APPRAISER">Property Appraiser</option>
                            <option value="TITLE_COMPANY">Title Company</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text text-[var(--foreground)] font-medium">Business License Number *</span>
                    </label>
                    <input type="text" placeholder="Business license number" required class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Service State *</span>
                        </label>
                        <select class="state-select select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text text-[var(--foreground)] font-medium">Service City *</span>
                        </label>
                        <select class="city-select select select-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]" required disabled>
                            <option value="">Select State First</option>
                        </select>
                    </div>
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text text-[var(--foreground)] font-medium">Website URL (Optional)</span>
                    </label>
                    <input type="url" placeholder="https://yourwebsite.com" class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                </div>
            </div>`
    };

    // --- PRICING RENDERERS ---

    const planConfigs = {
        buyer: {
            // Setup fee removed as per new logic $120 upfront covers the 3 months.
            subtitle: "See what you'll pay for your buyer membership",
            membership: {
                name: 'Buyer Membership',
                monthlyPrice: 40,
                commitmentMonths: 3,
                upfrontPrice: 120, // 40 * 3
                description: "Required to browse listings & view details",
                afterCommitment: "After 3 months: Month-to-month at $40 or cancel anytime"
            },
            accessPass: {
                name: 'Buyer Access Pass',
                price: 650,
                duration: '30 Days',
                description: "Required to unlock, contact & submit offers",
                note: "Purchase inside platform"
            }
        },
        seller: {
            setupFee: 99,
            listingFee: 199,
            total: 298,
            subtitle: "See what you'll pay for your seller account"
        },
        realtor: {
            setupFee: 99,
            accessFee: 99,
            monthly: 49,
            subtitle: "See what you'll pay for your realtor account"
        },
        partner: {
            setupFee: 199,
            accessFee: 299,
            monthly: 99,
            subtitle: "See what you'll pay for your partner account"
        }
    };

    function renderPricingPlan(type) {
        const config = planConfigs[type];

        // Changed padding from p-6 to p-4 sm:p-6 for better mobile view
        let html = `<div class="card bg-[var(--card)] rounded-lg border border-[var(--border)] shadow-lg overflow-visible"><div class="card-body p-4 sm:p-6">`;

        // Header
        html += `
            <div class="text-center mb-6">
                <h3 class="font-heading text-2xl sm:text-3xl text-[var(--foreground)] mb-2 capitalize">Pricing Plan</h3>
                <p class="text-sm text-[var(--muted-foreground)]">
                    ${config.subtitle}
                </p>
            </div>
        `;

        // Setup Fee Notice (Only for non-buyer types now, or handled differently)
        if (type !== 'buyer') {
            html += `
                <div class="mb-6 p-3 bg-[var(--muted)]/30 rounded-lg border border-[var(--border)] text-center">
                    <p class="text-sm font-medium text-[var(--foreground)]">
                        <span class="text-[var(--accent)] font-bold">Note:</span> One-time setup fee of $${config.setupFee} applies
                    </p>
                </div>
            `;
        }

        // Plans Grid or Single Plan
        if (type === 'buyer') {
            html += renderBuyerPlans(config);
        } else {
            html += renderSinglePlan(type, config);
        }

        // Features List
        html += renderFeaturesList(type);

        html += `</div></div>`;
        pricingPlanContainer.innerHTML = html;

        // Re-init icons for the new content
        lucide.createIcons();
    }

    function renderBuyerPlans(config) {
        const m = config.membership;
        const ap = config.accessPass;

        return `
            <div class="space-y-6">
                <!-- 1. Membership Card (Primary Selection) -->
                <div class="relative rounded-lg border-2 border-[var(--accent)] bg-[var(--accent)]/5 p-5 transition-all shadow-md">
                    <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                        <span class="bg-gradient-to-r from-[var(--accent)] to-[var(--accent-hover)] text-white text-[10px] uppercase font-bold px-3 py-1 rounded-full shadow-sm">
                            Step 1: Membership
                        </span>
                    </div>
                    
                    <div class="text-center mt-2">
                        <div class="font-heading text-xl text-[var(--foreground)] mb-1">${m.name}</div>
                        <div class="flex items-center justify-center gap-1 mb-1">
                             <span class="text-3xl font-bold text-[var(--accent)]">$${m.upfrontPrice}</span>
                             <span class="text-sm text-[var(--muted-foreground)] font-medium self-end mb-1">billed upfront</span>
                        </div>
                        <div class="text-xs text-[var(--muted-foreground)] font-medium bg-[var(--card)] inline-block px-2 py-1 rounded border border-[var(--border)] mb-2">
                            $${m.monthlyPrice}/mo (3 Month Commitment)
                        </div>
                        <p class="text-xs text-[var(--muted-foreground)] italic mb-2">${m.afterCommitment}</p>
                        
                         <div class="text-sm text-[var(--foreground)] font-medium border-t border-[var(--border)] pt-3 mt-3">
                            ${m.description}
                        </div>
                    </div>
                     <div class="absolute top-2 right-2 text-[var(--accent)]"><i data-lucide="check-circle" class="w-5 h-5"></i></div>
                </div>

                <!-- 2. Access Pass Info (Informational) -->
                <div class="rounded-lg border border-[var(--border)] border-dashed p-4 bg-[var(--muted)]/10 opacity-90">
                     <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-bold uppercase text-[var(--muted-foreground)] tracking-wider">Step 2: Access Pass</span>
                        <span class="text-xs bg-[var(--muted)] text-[var(--muted-foreground)] px-2 py-0.5 rounded">Optional / As Needed</span>
                     </div>
                     <div class="flex justify-between items-end">
                        <div>
                             <div class="font-heading text-base text-[var(--foreground)]">${ap.name}</div>
                             <div class="text-xs text-[var(--muted-foreground)]">${ap.description}</div>
                        </div>
                        <div class="text-right">
                             <div class="text-lg font-bold text-[var(--foreground)]">$${ap.price}</div>
                             <div class="text-xs text-[var(--muted-foreground)]">/ ${ap.duration}</div>
                        </div>
                     </div>
                     <div class="mt-2 text-[10px] text-[var(--accent)] font-medium text-center bg-[var(--accent)]/5 rounded py-1">
                        * ${ap.note}
                     </div>
                </div>
            </div>

            <!-- Total Section -->
             <div class="mt-6 p-4 bg-[var(--accent)]/10 rounded-lg border border-[var(--accent)]/20">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm text-[var(--foreground)] font-medium">Due Today (Membership):</span>
                    <span class="text-lg font-bold text-[var(--accent)]">$${m.upfrontPrice}</span>
                </div>
                 <p class="text-xs text-[var(--muted-foreground)] text-right">
                    Includes 3 months of access
                </p>
            </div>

            <!-- Important Notes -->
            <div class="mt-6 pt-4 border-t border-[var(--border)]">
                <h4 class="font-medium text-[var(--foreground)] text-lg mb-2">Important Notes:</h4>
                <ul class="text-sm text-[var(--muted-foreground)] space-y-1">
                    <li>• <strong>Membership Required:</strong> Must maintain active membership to access platform.</li>
                    <li>• <strong>Access Pass:</strong> Purchase separately ($${ap.price}/30 days) to unlock contacts.</li>
                    <li>• <strong>No Guarantees:</strong> Access Pass does not guarantee seller response or deal success.</li>
                    <li>• <strong>Scope:</strong> Fee is for contact access only. We are not a brokerage.</li>
                    <li>• <strong>Extensions:</strong> Up to 2 extensions (+15 days) available if listings are scarce.</li>
                    <li>• Unused time or unlocks do not roll over.</li>
                </ul>
            </div>
        `;
    }

    function selectBuyerPlan(plan) {
        // No-op for now as there's only one path, but functional reference kept safe.
        // Console log removed to clean up
    }

    function renderSinglePlan(type, config) {
        let content = '';

        if (type === 'seller') {
            content = `
                <div class="text-center space-y-3">
                    <div class="flex justify-between items-center text-sm border-b border-[var(--border)] pb-2">
                        <span class="text-[var(--muted-foreground)]">Listing Fee</span>
                        <span class="font-medium text-[var(--foreground)]">$${config.listingFee}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm border-b border-[var(--border)] pb-2">
                        <span class="text-[var(--muted-foreground)]">Setup Fee</span>
                        <span class="font-medium text-[var(--foreground)]">$${config.setupFee}</span>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="font-bold text-[var(--foreground)]">Total Due</span>
                        <span class="text-3xl font-bold text-[var(--accent)]">$${config.total}</span>
                    </div>
                    <div class="mt-4 pt-2">
                         <span class="inline-block px-3 py-1 bg-[var(--muted)]/50 rounded-full text-xs font-medium text-[var(--muted-foreground)]">
                            No monthly subscription
                        </span>
                    </div>
                </div>
            `;
        } else if (type === 'realtor') {
            content = `
                <div class="text-center space-y-3">
                    <div class="flex justify-between items-center text-sm border-b border-[var(--border)] pb-2">
                         <span class="text-[var(--muted-foreground)]">Access Fee</span>
                        <span class="font-medium text-[var(--foreground)]">$${config.accessFee}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm border-b border-[var(--border)] pb-2">
                         <span class="text-[var(--muted-foreground)]">Setup Fee</span>
                        <span class="font-medium text-[var(--foreground)]">$${config.setupFee}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm border-b border-[var(--border)] pb-2">
                         <span class="text-[var(--muted-foreground)]">First Month</span>
                        <span class="font-medium text-[var(--foreground)]">$${config.monthly}</span>
                    </div>
                     <div class="flex justify-between items-center pt-2">
                        <span class="font-bold text-[var(--foreground)]">Initial Total</span>
                        <span class="text-2xl font-bold text-[var(--foreground)]">$${config.accessFee + config.setupFee + config.monthly}</span>
                    </div>
                    <div class="mt-4 p-3 bg-[var(--accent)]/5 rounded-lg border border-[var(--accent)]/20">
                         <p class="text-sm text-[var(--muted-foreground)]">Monthly Subscription</p>
                         <p class="text-3xl font-bold text-[var(--accent)]">$${config.monthly}<span class="text-sm font-normal text-[var(--muted-foreground)]">/mo</span></p>
                         <p class="text-xs text-[var(--muted-foreground)] mt-1">(Included in initial total)</p>
                    </div>
                </div>
            `;
        } else if (type === 'partner') {
            content = `
                <div class="text-center space-y-3">
                    <div class="flex justify-between items-center text-sm border-b border-[var(--border)] pb-2">
                         <span class="text-[var(--muted-foreground)]">Access Fee</span>
                        <span class="font-medium text-[var(--foreground)]">$${config.accessFee}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm border-b border-[var(--border)] pb-2">
                         <span class="text-[var(--muted-foreground)]">Setup Fee</span>
                        <span class="font-medium text-[var(--foreground)]">$${config.setupFee}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm border-b border-[var(--border)] pb-2">
                         <span class="text-[var(--muted-foreground)]">First Month</span>
                        <span class="font-medium text-[var(--foreground)]">$${config.monthly}</span>
                    </div>
                     <div class="flex justify-between items-center pt-2">
                        <span class="font-bold text-[var(--foreground)]">Initial Total</span>
                        <span class="text-2xl font-bold text-[var(--foreground)]">$${config.accessFee + config.setupFee + config.monthly}</span>
                    </div>
                    <div class="mt-4 p-3 bg-[var(--accent)]/5 rounded-lg border border-[var(--accent)]/20">
                         <p class="text-sm text-[var(--muted-foreground)]">Monthly Subscription</p>
                         <p class="text-3xl font-bold text-[var(--accent)]">$${config.monthly}<span class="text-sm font-normal text-[var(--muted-foreground)]">/mo</span></p>
                        <p class="text-xs text-[var(--muted-foreground)] mt-1">(Included in initial total)</p>
                    </div>
                </div>
            `;
        }

        return `
            <div class="mb-6 mt-2">
                <div class="bg-gradient-to-br from-[var(--card)] to-[var(--muted)]/20 rounded-lg border border-[var(--border)] p-6 shadow-sm">
                   ${content}
                </div>
            </div>
        `;
    }

    function renderFeaturesList(type) {
        const featuresMap = {
            buyer: [
                "Browse all public property listings",
                "View photos, details & descriptions",
                "Save & track favorite properties",
                "Receive alerts & updates",
                "View unlocked seller contacts",
                "Access Pass required for new contacts"
            ],
            realtor: ["Professional realtor dashboard", "Advanced property search", "Client CRM", "Lead generation tools", "Market analysis reports", "Commission tools"],
            seller: ["Professional listing creation", "High-quality photo uploads", "Virtual tour creation", "Market analysis and pricing", "Direct buyer connection", "Marketing exposure"],
            partner: ["Partner dashboard and analytics", "Lead generation tools", "Client referral system", "Service booking", "Business profile page", "Marketing tools"]
        };

        const features = featuresMap[type] || [];
        const visibleFeatures = features.slice(0, 3).map(f => `<li>• ${f}</li>`).join('');

        if (features.length <= 3) {
            return `
                <div class="mt-6 space-y-2">
                    <h4 class="font-medium text-[var(--foreground)] text-lg">What's Included:</h4>
                    <ul class="text-sm text-[var(--muted-foreground)] space-y-1">
                        ${visibleFeatures}
                    </ul>
                </div>
            `;
        }

        const remainingCount = features.length - 3;
        const hiddenFeatures = features.slice(3).map(f => `<li>• ${f}</li>`).join('');
        const blurredFeature = features[3];

        return `
            <div class="mt-6 space-y-2">
                <h4 class="font-medium text-[var(--foreground)] text-lg">What's Included:</h4>
                <ul class="text-sm text-[var(--muted-foreground)] space-y-1">
                    ${visibleFeatures}
                    
                    <div id="features-collapsed">
                        <li class="relative">
                            <span class="blur-text">• ${blurredFeature}</span>
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-white/10"></div>
                        </li>
                    </div>
                    
                    <div id="features-expanded" class="hidden">
                        ${hiddenFeatures}
                    </div>

                    <li class="pt-2">
                        <button onclick="toggleFeatures(${remainingCount})" class="btn btn-ghost btn-xs flex items-center gap-2 text-[var(--accent)] hover:text-[var(--accent-hover)] transition-colors font-medium text-sm p-0 h-auto min-h-0 hover:bg-transparent">
                            <span id="features-btn-text">Show ${remainingCount} More</span>
                            <i id="features-btn-icon" data-lucide="chevron-down" class="w-4 h-4 transition-transform duration-200"></i>
                        </button>
                    </li>
                </ul>
            </div>
        `;
    }

    function toggleFeatures(count) {
        const collapsed = document.getElementById('features-collapsed');
        const expanded = document.getElementById('features-expanded');
        const btnText = document.getElementById('features-btn-text');
        const btnIcon = document.getElementById('features-btn-icon');

        if (expanded.classList.contains('hidden')) {
            // Expand
            expanded.classList.remove('hidden');
            collapsed.classList.add('hidden');
            btnText.textContent = "Show Less";
            btnIcon.style.transform = "rotate(180deg)";
        } else {
            // Collapse
            expanded.classList.add('hidden');
            collapsed.classList.remove('hidden');
            btnText.textContent = `Show ${count} More`;
            btnIcon.style.transform = "rotate(0deg)";
        }
    }

    // --- ACTIONS ---

    function formatNumberInput(input) {
        let val = input.value.replace(/,/g, '').replace(/[^0-9.]/g, '');
        const parts = val.split('.');
        if (parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
        if (val === '') {
            input.value = '';
            return;
        }
        const sides = val.split('.');
        sides[0] = sides[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = sides.join('.');
    }

    function selectUserType(type) {
        currentUserType = type;

        // Update User Type Buttons Styles
        userTypeButtons.forEach(btn => {
            if (btn.id === `btn-${type}`) {
                btn.classList.add('border-[var(--accent)]', 'bg-[var(--accent)]/10');
                btn.classList.remove('border-[var(--border)]');
                btn.classList.remove('btn-outline');
            } else {
                btn.classList.remove('border-[var(--accent)]', 'bg-[var(--accent)]/10');
                btn.classList.add('border-[var(--border)]');
                btn.classList.add('btn-outline');
            }
        });

        // Update Dynamic Form Section
        dynamicFieldsContainer.innerHTML = formTemplates[type];

        // Initialize Location Dropdowns
        initLocationSelectors(dynamicFieldsContainer);

        // Attach formatter if Seller
        if (type === 'seller') {
            const estInput = dynamicFieldsContainer.querySelector('input[placeholder="Property value estimate"]');
            if (estInput) {
                estInput.addEventListener('input', (e) => formatNumberInput(e.target));
            }
        }

        // Update Pricing Section
        pricingUserTypeLabel.textContent = type;
        renderPricingPlan(type);
    }

    // --- INIT & EVENT LISTENERS ---

    // Mobile Menu
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const closeMenuBtn = document.getElementById('close-menu-btn');
    const toggleMenu = () => mobileMenu.classList.toggle('hidden');
    if (mobileMenuBtn) mobileMenuBtn.addEventListener('click', toggleMenu);
    if (closeMenuBtn) closeMenuBtn.addEventListener('click', toggleMenu);

    // Form Submit Logic
    document.getElementById('signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        const originalBtnText = btn.innerHTML;

        // Reset previous errors
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));

        // Basic validation
        const password = document.querySelector('input[type="password"]').value;
        const confirmPassword = document.querySelectorAll('input[type="password"]')[1].value;

        if (password !== confirmPassword) {
            Toastify({
                text: "Passwords do not match!",
                duration: 3000,
                close: true,
                gravity: "bottom", // `top` or `bottom`
                position: "right", // `left`, `center` or `right`
                stopOnFocus: true, // Prevents dismissing of toast on hover
                style: {
                    background: "var(--destructive)",
                    color: "white"
                }
            }).showToast();
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Creating Account...';
        btn.classList.add('opacity-70');

        try {
            // Collect form data
            const formData = {
                first_name: document.querySelector('input[placeholder="Enter your first name"]').value,
                last_name: document.querySelector('input[placeholder="Enter your last name"]').value,
                email: document.querySelector('input[type="email"]').value,
                password: password,
                phone_number: document.querySelector('input[type="tel"]').value,
                role: currentUserType.toUpperCase()
            };

            // Add role-specific fields
            if (currentUserType === 'buyer') {
                const state = document.querySelector('.state-select');
                const city = document.querySelector('.city-select');
                const budget = document.querySelector('select:not(.state-select):not(.city-select)');

                if (state && city && state.value && city.value) {
                    formData.preferred_location = `${city.value}, ${state.value}`;
                }
                if (budget) formData.budget_range = budget.value;
                formData.selected_plan = selectedBuyerPlan; // Send selected plan
            } else if (currentUserType === 'realtor') {
                const license = document.querySelector('input[placeholder="Real estate license number"]');
                const company = document.querySelector('input[placeholder="Company or brokerage name"]');
                const experience = document.querySelector('select');
                if (license) formData.license_number = license.value;
                if (company) formData.company_brokerage = company.value;
                if (experience) formData.years_of_experience = experience.value;
            } else if (currentUserType === 'seller') {
                const type = document.querySelector('select:not(.state-select):not(.city-select)');
                const value = document.querySelector('input[name="estimated_value"]'); // Changed selector to name
                const state = document.querySelector('.state-select');
                const city = document.querySelector('.city-select');

                if (type) formData.property_type = type.value.toUpperCase();
                if (value) formData.estimated_value = value.value.replace(/,/g, '');
                if (state && city && state.value && city.value) {
                    formData.property_location = `${city.value}, ${state.value}`;
                }
            } else if (currentUserType === 'partner') {
                const company = document.querySelector('input[placeholder="Your business or company name"]');
                const type = document.querySelector('select:not(.state-select):not(.city-select)');
                const state = document.querySelector('.state-select');
                const city = document.querySelector('.city-select');
                const website = document.querySelector('input[placeholder="https://yourwebsite.com"]');
                const license = document.querySelector('input[placeholder="Business license number"]');

                if (company) formData.company_name = company.value;
                if (type) formData.partnership_type = type.value.toUpperCase().replace(/-/g, '_');
                if (state && city && state.value && city.value) {
                    formData.service_areas = `${city.value}, ${state.value}`;
                }
                if (website) formData.website_url = website.value;
                if (license) formData.business_license_number = license.value;
            }

            const response = await fetch('/api/v1/auth/signup/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                // Success - Show OTP Modal
                btn.innerHTML = originalBtnText;
                btn.classList.remove('opacity-70');
                btn.disabled = false;

                signedUpEmail = formData.email;
                document.getElementById('otp_modal').showModal();

                Toastify({
                    text: "Account created! Please verify your email.",
                    duration: 3000,
                    close: true,
                    gravity: "bottom",
                    position: "right",
                    style: {
                        background: "var(--accent)",
                        color: "var(--bg)"
                    }
                }).showToast();

            } else {
                // Handle errors
                btn.disabled = false;
                btn.innerHTML = originalBtnText;
                btn.classList.remove('opacity-70');

                // Display field errors
                if (typeof data === 'object') {
                    for (const [key, value] of Object.entries(data)) {
                        const errorText = Array.isArray(value) ? value.join(', ') : value;
                        // Not formatting key here to keep it simple, or capitalize it
                        const formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');

                        Toastify({
                            text: `${formattedKey}: ${errorText}`,
                            duration: 5000,
                            close: true,
                            gravity: "bottom",
                            position: "right",
                            stopOnFocus: true,
                            style: {
                                background: "var(--destructive)",
                                color: "white"
                            }
                        }).showToast();
                    }
                } else {
                    Toastify({
                        text: "Registration failed. Please try again.",
                        duration: 3000,
                        close: true,
                        gravity: "bottom",
                        position: "right",
                        stopOnFocus: true,
                        style: {
                            background: "var(--destructive)",
                            color: "white"
                        }
                    }).showToast();
                }
            }
        } catch (error) {
            console.error('Error:', error);
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
            btn.classList.remove('opacity-70');

            Toastify({
                text: "An error occurred. Please try again later.",
                duration: 3000,
                close: true,
                gravity: "bottom",
                position: "right",
                stopOnFocus: true,
                style: {
                    background: "var(--destructive)",
                    color: "white"
                }
            }).showToast();
        }
    });

    // Helper to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function verifyOTP() {
        const otpInput = document.getElementById('otp-input');
        const verifyBtn = document.getElementById('verify-btn');
        const errorDiv = document.getElementById('otp-error');
        const otp = otpInput.value.trim();

        if (otp.length !== 8) {
            errorDiv.textContent = "Please enter a valid 8-digit code.";
            errorDiv.classList.remove('hidden');
            return;
        }

        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Verifying...';
        errorDiv.classList.add('hidden');

        try {
            const response = await fetch('/api/v1/auth/verify-otp/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    email: signedUpEmail,
                    otp: otp
                })
            });

            const data = await response.json();

            if (response.ok) {
                // Success
                document.getElementById('otp_modal').close();

                Toastify({
                    text: "Email verified! Redirecting to payment...",
                    duration: 3000,
                    close: true,
                    gravity: "bottom",
                    position: "right",
                    style: {
                        background: "var(--accent)",
                        color: "var(--bg)"
                    }
                }).showToast();

                // Call Stripe Checkout
                if (data.url) {
                    setTimeout(() => {
                        window.location.href = data.url;
                    }, 1000);
                } else {
                    // Fallback if no URL but successful (shouldn't happen with payment flow)
                    setTimeout(() => {
                        window.location.href = "{% url 'login' %}";
                    }, 1000);
                }

            } else {
                errorDiv.textContent = data.error || "Verification failed. Please try again.";
                errorDiv.classList.remove('hidden');
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify';
            }
        } catch (error) {
            console.error('Error:', error);
            errorDiv.textContent = "An error occurred. Please try again.";
            errorDiv.classList.remove('hidden');
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verify';
        }
    }

    // Initialize with default 'buyer'
    document.addEventListener('DOMContentLoaded', () => {
        selectUserType('buyer');
        initPricing();
    });

</script>
{% endblock %}