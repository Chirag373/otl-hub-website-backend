{% extends 'buyer_base.html' %}

{% block title %}Property Search | OTL Platform{% endblock %}

{% block sidebar %}
{% include 'partials/buyer_sidebar.html' with active_page='search' %}
{% endblock %}

{% block content %}
<div class="space-y-2">
    <h1 class="text-3xl font-bold text-[var(--foreground)]">Property Search</h1>
    <p class="text-[var(--muted-foreground)]">Find your perfect property with advanced filters</p>
</div>

<div class="bg-[var(--card)] rounded-lg border border-[var(--border)] p-6 space-y-6">

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="space-y-2">
            <label class="text-sm font-medium text-[var(--foreground)]">Keywords</label>
            <input type="text" id="filter-keywords" placeholder="e.g., condo, downtown, pool"
                class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
        </div>
        <div class="space-y-2">
            <label class="text-sm font-medium text-[var(--foreground)]">Location</label>
            <div class="flex gap-2" id="location-filters">
                <select id="filter-state"
                    class="state-select w-1/2 px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    <option value="">State</option>
                </select>
                <select id="filter-city"
                    class="city-select w-1/2 px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
                    <option value="">City</option>
                </select>
            </div>
        </div>
        <div class="space-y-2">
            <label class="text-sm font-medium text-[var(--foreground)]">Property Type</label>
            <select id="filter-type"
                class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                <option value="">Any Type</option>
                <option value="house">House</option>
                <option value="condo">Condo</option>
                <option value="townhouse">Townhouse</option>
                <option value="apartment">Apartment</option>
                <option value="land">Land</option>
            </select>
        </div>
        <div class="flex items-end space-x-2">
            <button id="btn-search"
                class="flex-1 flex items-center justify-center px-4 py-2 bg-[var(--accent)] text-[var(--bg)] rounded-md hover:bg-[var(--accent-hover)] transition-colors font-medium">
                <i data-lucide="search" class="mr-2 h-4 w-4"></i> Search
            </button>
            <button id="btn-toggle-filters"
                class="p-2 border border-[var(--border)] rounded-md text-[var(--foreground)] hover:bg-[var(--muted)] transition-colors"
                title="Advanced Filters">
                <i data-lucide="sliders-horizontal" class="h-5 w-5"></i>
            </button>
        </div>
    </div>

    <div id="advanced-filters" class="hidden pt-4 border-t border-[var(--border)]">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-[var(--foreground)]">Advanced Filters</h3>
            <button id="btn-clear-filters"
                class="flex items-center px-3 py-1 text-sm border border-[var(--border)] rounded-md text-[var(--foreground)] hover:bg-[var(--muted)] transition-colors">
                <i data-lucide="x" class="mr-2 h-4 w-4"></i> Clear All
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="space-y-2">
                <label class="text-sm font-medium text-[var(--foreground)]">Price Range</label>
                <select id="filter-price"
                    class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    <option value="">Any Price</option>
                    <option value="0-200000">Under $200,000</option>
                    <option value="200000-400000">$200,000 - $400,000</option>
                    <option value="400000-600000">$400,000 - $600,000</option>
                    <option value="600000-800000">$600,000 - $800,000</option>
                    <option value="800000-1000000">$800,000 - $1,000,000</option>
                    <option value="1000000+">$1,000,000+</option>
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-sm font-medium text-[var(--foreground)]">Bedrooms</label>
                <select id="filter-beds"
                    class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    <option value="">Any</option>
                    <option value="1">1+</option>
                    <option value="2">2+</option>
                    <option value="3">3+</option>
                    <option value="4">4+</option>
                    <option value="5">5+</option>
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-sm font-medium text-[var(--foreground)]">Bathrooms</label>
                <select id="filter-baths"
                    class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    <option value="">Any</option>
                    <option value="1">1+</option>
                    <option value="2">2+</option>
                    <option value="3">3+</option>
                    <option value="4">4+</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="flex items-center justify-between">
    <h2 class="text-xl font-semibold text-[var(--foreground)]">
        Search Results (<span id="results-count">0</span> properties)
    </h2>
    <div class="flex items-center space-x-2">
        <span class="text-sm text-[var(--muted-foreground)] hidden sm:inline">Sort by:</span>
        <select id="sort-order"
            class="bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] rounded px-2 py-1 text-sm focus:outline-none">
            <option value="relevant">Most Relevant</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="newest">Newest First</option>
        </select>
    </div>
</div>

<div id="property-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- API CONFIG ---
    const CSC_API_KEY = 'WnVWTGlEejlKbzMyOXd4c2VmdVQzZzFWTVJTb0xXWk1pNExvWVFzZQ==';
    const CSC_BASE_URL = 'https://api.countrystatecity.in/v1';
    let cachedStates = null;
    let cachedCities = {};

    async function fetchUSStates() {
        if (cachedStates) return cachedStates;
        try {
            const res = await fetch(`${CSC_BASE_URL}/countries/US/states`, {
                headers: { 'X-CSCAPI-KEY': CSC_API_KEY }
            });
            if (!res.ok) throw new Error('Failed to fetch states');
            const data = await res.json();
            data.sort((a, b) => a.name.localeCompare(b.name));
            cachedStates = data;
            return data;
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function fetchCities(stateIso) {
        if (cachedCities[stateIso]) return cachedCities[stateIso];
        try {
            const res = await fetch(`${CSC_BASE_URL}/countries/US/states/${stateIso}/cities`, {
                headers: { 'X-CSCAPI-KEY': CSC_API_KEY }
            });
            if (!res.ok) throw new Error('Failed to fetch cities');
            const data = await res.json();
            data.sort((a, b) => a.name.localeCompare(b.name));
            cachedCities[stateIso] = data;
            return data;
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function initLocationSelectors(container) {
        const stateSels = container.querySelectorAll('.state-select');

        if (stateSels.length === 0) return;

        // Load States
        const states = await fetchUSStates();
        const stateOptions = '<option value="">Select State</option>' +
            states.map(s => `<option value="${s.iso2}">${s.name}</option>`).join('');

        stateSels.forEach(stateSel => {
            stateSel.innerHTML = stateOptions;

            // Find corresponding city select
            const citySel = container.querySelector('.city-select');

            if (!citySel) return;

            stateSel.addEventListener('change', async () => {
                const stateCode = stateSel.value;
                citySel.disabled = true;
                citySel.innerHTML = '<option value="">Loading...</option>';

                if (stateCode) {
                    const cities = await fetchCities(stateCode);
                    if (cities.length === 0) {
                        citySel.innerHTML = '<option value="">No cities found</option>';
                    } else {
                        citySel.innerHTML = '<option value="">Select City</option>' +
                            cities.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                        citySel.disabled = false;
                    }
                } else {
                    citySel.innerHTML = '<option value="">Select City</option>';
                    citySel.disabled = true;
                }
            });
        });
    }

    // --- STATE ---
    let favorites = []; // Array of favorite IDs
    let currentFilters = {
        keywords: "",
        location: "",
        type: "",
        priceMin: "",
        priceMax: "",
        beds: "",
        baths: "",
        sort: "relevant"
    };

    // --- DOM ELEMENTS ---
    const dom = {
        grid: document.getElementById('property-grid'),
        resultsCount: document.getElementById('results-count'),

        // Filters
        inputKeywords: document.getElementById('filter-keywords'),
        inputState: document.getElementById('filter-state'),
        inputCity: document.getElementById('filter-city'),
        inputType: document.getElementById('filter-type'),
        inputPrice: document.getElementById('filter-price'),
        inputBeds: document.getElementById('filter-beds'),
        inputBaths: document.getElementById('filter-baths'),
        inputSort: document.getElementById('sort-order'),

        // Buttons
        btnSearch: document.getElementById('btn-search'),
        btnToggleFilters: document.getElementById('btn-toggle-filters'),
        btnClearFilters: document.getElementById('btn-clear-filters'),
        advancedFilters: document.getElementById('advanced-filters')
    };

    // --- INITIALIZATION ---
    function init() {
        if (window.lucide) lucide.createIcons();

        // Parse URL params
        const urlParams = new URLSearchParams(window.location.search);

        // Map params to UI
        // Map params to UI (State/City mapping from URL is complex due to async load, skipping for now as per simple integration request)
        // If needed, we'd need to wait for states to load, set state, wait for cities, set city.
        // For now, we omit pre-filling location from URL to keep it simple and robust.

        if (dom.inputType && urlParams.has('type')) dom.inputType.value = urlParams.get('type');
        if (dom.inputBeds && urlParams.has('beds')) dom.inputBeds.value = urlParams.get('beds');
        if (dom.inputBaths && urlParams.has('baths')) dom.inputBaths.value = urlParams.get('baths');
        /* Price mapping if necessary, though URL usually sends min/max or nothing if complex */

        // Fetch favorites first, then properties via updateFilters to sync state
        fetchFavoriteIds().finally(() => {
            updateFilters();
        });

        initLocationSelectors(document.body);
        setupEventListeners();
    }

    // --- UTILS ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- API CALLS ---
    async function fetchFavoriteIds() {
        try {
            const response = await fetch(`/api/v1/buyer/favorites/`);
            if (response.ok) {
                const data = await response.json();
                favorites = data.map(p => p.id);
            }
        } catch (e) {
            console.error("Failed to fetch favorites", e);
        }
    }

    async function fetchProperties() {
        if (dom.grid) {
            dom.grid.innerHTML = `
                <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-12">
                     <span class="loading loading-spinner loading-lg text-[var(--accent)]"></span>
                </div>
            `;
        }

        // Build Query Params
        const params = new URLSearchParams();
        if (currentFilters.keywords) params.append('keywords', currentFilters.keywords);
        if (currentFilters.location) params.append('location', currentFilters.location);
        if (currentFilters.type) params.append('type', currentFilters.type);
        if (currentFilters.priceMin) params.append('price_min', currentFilters.priceMin);
        if (currentFilters.priceMax && currentFilters.priceMax !== Infinity) params.append('price_max', currentFilters.priceMax);
        if (currentFilters.beds) params.append('beds', currentFilters.beds);
        if (currentFilters.baths) params.append('baths', currentFilters.baths);
        if (currentFilters.sort && currentFilters.sort !== 'relevant') params.append('sort', currentFilters.sort);

        try {
            const response = await fetch(`/api/v1/buyer/property-search/?${params.toString()}`);
            if (!response.ok) {
                if (response.status === 403 || response.status === 401) {
                    console.warn("User not authenticated. Redirecting...");
                    window.location.href = "{% url 'login' %}";
                    return;
                }
                throw new Error('Failed to fetch properties');
            }
            const properties = await response.json();
            renderProperties(properties);
        } catch (error) {
            console.error(error);
            if (dom.grid) {
                dom.grid.innerHTML = `
                   <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-12 text-red-500">
                        <p>Error loading properties. Please try again later.</p>
                   </div>
                `;
            }
        }
    }

    window.toggleFavorite = async (id, btnElement) => {
        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch(`/api/v1/buyer/favorites/${id}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            });

            if (response.ok) {
                const data = await response.json();
                const heartIcon = document.getElementById(`heart-icon-${id}`);

                if (data.is_favorite) {
                    favorites.push(id);
                    if (heartIcon) {
                        heartIcon.classList.remove('text-white');
                        heartIcon.classList.add('fill-red-500', 'text-red-500');
                    }
                } else {
                    favorites = favorites.filter(fid => fid !== id);
                    if (heartIcon) {
                        heartIcon.classList.remove('fill-red-500', 'text-red-500');
                        heartIcon.classList.add('text-white');
                    }
                }
            } else {
                console.error("Failed to toggle favorite");
            }
        } catch (e) {
            console.error(e);
        }
    };

    // --- LOGIC ---

    function formatPrice(price) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            maximumFractionDigits: 0
        }).format(price);
    }

    // --- CAROUSEL STATE ---
    let carouselState = {}; // Stores current index for each property ID: { 1: 0, 2: 1 }

    function renderProperties(properties) {
        if (dom.resultsCount) dom.resultsCount.textContent = properties.length;
        if (dom.grid) dom.grid.innerHTML = "";

        if (!dom.grid) return;

        if (properties.length === 0) {
            dom.grid.innerHTML = `
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-12">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-[var(--muted)]/20 mb-4">
                            <i data-lucide="search-x" class="w-8 h-8 text-[var(--muted-foreground)]"></i>
                        </div>
                        <h3 class="text-lg font-medium text-[var(--foreground)]">No properties found</h3>
                        <p class="text-[var(--muted-foreground)]">Try adjusting your filters to find what you're looking for.</p>
                    </div>
                `;
            if (window.lucide) lucide.createIcons();
            return;
        }

        properties.forEach(p => {
            const isFav = favorites.includes(p.id);
            // Default images handling
            let images = p.images || [];
            if (images.length === 0) {
                if (p.image) images = [p.image];
                else images = ["https://placehold.co/600x400?text=No+Image"];
            }

            // Initialize state if new
            if (carouselState[p.id] === undefined) {
                carouselState[p.id] = 0;
            }
            // Ensure index is valid
            if (carouselState[p.id] >= images.length) carouselState[p.id] = 0;

            const currentImg = images[carouselState[p.id]];
            const hasMultiple = images.length > 1;

            const card = document.createElement('div');
            card.className = "bg-[var(--card)] rounded-lg border border-[var(--border)] overflow-hidden hover:shadow-lg transition-shadow group";
            card.innerHTML = `
                    <div class="relative">
                        <div class="aspect-video bg-gray-700 relative overflow-hidden group/image">
                            <img src="${currentImg}" alt="${p.title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" id="img-${p.id}">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-60 pointer-events-none"></div>
                            
                            <button onclick="toggleFavorite(${p.id})" class="absolute top-2 right-2 p-2 rounded-full hover:bg-white/20 transition-colors z-10">
                                <i id="heart-icon-${p.id}" data-lucide="heart" class="w-5 h-5 ${isFav ? 'fill-red-500 text-red-500' : 'text-white'} transition-colors"></i>
                            </button>

                            ${hasMultiple ? `
                                <button onclick="prevImage(${p.id}, ${images.length})" 
                                    class="absolute left-2 top-1/2 -translate-y-1/2 p-1.5 rounded-full bg-black/50 text-white hover:bg-black/70 transition-opacity opacity-0 group-hover/image:opacity-100 z-10"
                                    title="Previous Image">
                                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                                </button>
                                <button onclick="nextImage(${p.id}, ${images.length})" 
                                    class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 rounded-full bg-black/50 text-white hover:bg-black/70 transition-opacity opacity-0 group-hover/image:opacity-100 z-10"
                                    title="Next Image">
                                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                </button>
                                <div class="absolute bottom-2 right-2 px-2 py-0.5 bg-black/60 rounded text-[10px] text-white font-medium pointer-events-none z-10">
                                    <span id="counter-${p.id}">${carouselState[p.id] + 1}</span>/${images.length}
                                </div>
                            ` : ''}
                        </div>
                        <div class="absolute bottom-2 left-2 pointer-events-none z-10">
                            <span class="px-2 py-1 bg-[var(--accent)] text-[var(--bg)] text-xs font-bold rounded capitalize shadow-md">
                                ${p.type || 'Property'}
                            </span>
                        </div>
                    </div>

                    <div class="p-4 space-y-3">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-semibold text-[var(--foreground)] line-clamp-1 text-lg" title="${p.title}">
                                    ${p.title}
                                </h3>
                            </div>
                            <div class="flex items-center text-sm text-[var(--muted-foreground)] mt-1">
                                <i data-lucide="map-pin" class="h-3 w-3 mr-1"></i>
                                ${p.location}
                            </div>
                        </div>

                        <div class="flex items-center justify-between border-t border-[var(--border)] pt-3 mt-2">
                            <span class="text-xl font-bold text-[var(--accent)]">
                                ${formatPrice(p.price || 0)}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm text-[var(--muted-foreground)]">
                            <div class="flex items-center gap-1"><i data-lucide="bed" class="w-4 h-4"></i> <span>${p.bedrooms} bed</span></div>
                            <div class="flex items-center gap-1"><i data-lucide="bath" class="w-4 h-4"></i> <span>${p.bathrooms} bath</span></div>
                            <div class="flex items-center gap-1"><i data-lucide="square" class="w-4 h-4"></i> <span>${p.sqft.toLocaleString()} sqft</span></div>
                        </div>

                        <div class="flex flex-wrap gap-1 pt-1">
                            ${p.features && p.features.length > 0 ? p.features.slice(0, 3).map(f => `
                                <span class="px-2 py-1 bg-[var(--muted)]/20 text-[var(--muted-foreground)] text-xs rounded border border-[var(--border)]">
                                    ${f}
                                </span>
                            `).join('') : '<span class="text-xs text-[var(--muted-foreground)]">No features listed</span>'}
                        </div>

                        <div class="flex space-x-2 pt-2">
                            <button class="flex-1 px-3 py-2 text-sm font-medium border border-[var(--border)] rounded-md text-[var(--foreground)] hover:bg-[var(--muted)] transition-colors">
                                View Details
                            </button>
                            <button class="flex-1 px-3 py-2 text-sm font-medium bg-[var(--accent)] text-[var(--bg)] rounded-md hover:bg-[var(--accent-hover)] transition-colors font-semibold">
                                Contact Agent
                            </button>
                        </div>
                    </div>
                `;

            window.propertyData = window.propertyData || {};
            window.propertyData[p.id] = images;

            dom.grid.appendChild(card);
        });
        if (window.lucide) lucide.createIcons();
    }

    // --- ACTIONS ---

    window.nextImage = (id, total) => {
        if (!carouselState[id]) carouselState[id] = 0;
        carouselState[id] = (carouselState[id] + 1) % total;
        updateCardImage(id);
    };

    window.prevImage = (id, total) => {
        if (!carouselState[id]) carouselState[id] = 0;
        carouselState[id] = (carouselState[id] - 1 + total) % total;
        updateCardImage(id);
    };

    function updateCardImage(id) {
        const imgEl = document.getElementById(`img-${id}`);
        const counterEl = document.getElementById(`counter-${id}`);
        const images = window.propertyData[id];

        if (imgEl && images) {
            imgEl.src = images[carouselState[id]];
        }
        if (counterEl) {
            counterEl.textContent = carouselState[id] + 1;
        }
    }

    function updateFilters() {
        // Price parsing
        let min = "", max = "";
        if (dom.inputPrice && dom.inputPrice.value) {
            if (dom.inputPrice.value.includes('+')) {
                min = parseInt(dom.inputPrice.value.replace('+', ''));
            } else {
                const parts = dom.inputPrice.value.split('-');
                if (parts.length === 2) {
                    min = parseInt(parts[0]);
                    max = parseInt(parts[1]);
                }
            }
        }

        let loc = "";
        if (dom.inputState && dom.inputCity) {
            const s = dom.inputState.value;
            const c = dom.inputCity.value;
            if (s && c) loc = `${c}, ${s}`;
            else if (s) loc = s;
        }

        currentFilters = {
            keywords: dom.inputKeywords ? dom.inputKeywords.value : "",
            location: loc,
            type: dom.inputType ? dom.inputType.value : "",
            priceMin: min,
            priceMax: max === "" ? Infinity : max,
            beds: dom.inputBeds ? (parseInt(dom.inputBeds.value) || "") : "",
            baths: dom.inputBaths ? (parseInt(dom.inputBaths.value) || "") : "",
            sort: dom.inputSort ? dom.inputSort.value : "relevant"
        };

        fetchProperties();
    }

    function clearFilters() {
        if (dom.inputKeywords) dom.inputKeywords.value = "";
        if (dom.inputState) dom.inputState.value = "";
        if (dom.inputCity) {
            dom.inputCity.value = "";
            dom.inputCity.innerHTML = '<option value="">City</option>';
            dom.inputCity.disabled = true;
        }
        if (dom.inputType) dom.inputType.value = "";
        if (dom.inputPrice) dom.inputPrice.value = "";
        if (dom.inputBeds) dom.inputBeds.value = "";
        if (dom.inputBaths) dom.inputBaths.value = "";

        updateFilters();
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Filter UI Toggle
        if (dom.btnToggleFilters) {
            dom.btnToggleFilters.addEventListener('click', () => {
                dom.advancedFilters.classList.toggle('hidden');
            });
        }

        // Search Button
        if (dom.btnSearch) {
            dom.btnSearch.addEventListener('click', updateFilters);
        }

        // Clear Filters
        if (dom.btnClearFilters) {
            dom.btnClearFilters.addEventListener('click', clearFilters);
        }

        // Sort Change
        if (dom.inputSort) {
            dom.inputSort.addEventListener('change', updateFilters);
        }

        // Enter key on inputs
        [dom.inputKeywords].forEach(input => {
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') updateFilters();
                });
            }
        });
    }

    // Run
    init();
</script>
{% endblock %}