{% extends 'buyer_base.html' %}

{% block title %}Property Search | OTL Platform{% endblock %}

{% block sidebar %}
{% include 'partials/buyer_sidebar.html' with active_page='search' %}
{% endblock %}

{% block content %}
<div class="space-y-2">
    <h1 class="text-3xl font-bold text-[var(--foreground)]">Property Search</h1>
    <p class="text-[var(--muted-foreground)]">Find your perfect property with advanced filters</p>
</div>

<div class="bg-[var(--card)] rounded-lg border border-[var(--border)] p-6 space-y-6">

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="space-y-2">
            <label class="text-sm font-medium text-[var(--foreground)]">Keywords</label>
            <input type="text" id="filter-keywords" placeholder="e.g., condo, downtown, pool"
                class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
        </div>
        <div class="space-y-2">
            <label class="text-sm font-medium text-[var(--foreground)]">Location</label>
            <input type="text" id="filter-location" placeholder="City, State or ZIP"
                class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
        </div>
        <div class="space-y-2">
            <label class="text-sm font-medium text-[var(--foreground)]">Property Type</label>
            <select id="filter-type"
                class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                <option value="">Any Type</option>
                <option value="house">House</option>
                <option value="condo">Condo</option>
                <option value="townhouse">Townhouse</option>
                <option value="apartment">Apartment</option>
                <option value="land">Land</option>
            </select>
        </div>
        <div class="flex items-end space-x-2">
            <button id="btn-search"
                class="flex-1 flex items-center justify-center px-4 py-2 bg-[var(--accent)] text-[var(--bg)] rounded-md hover:bg-[var(--accent-hover)] transition-colors font-medium">
                <i data-lucide="search" class="mr-2 h-4 w-4"></i> Search
            </button>
            <button id="btn-toggle-filters"
                class="p-2 border border-[var(--border)] rounded-md text-[var(--foreground)] hover:bg-[var(--muted)] transition-colors"
                title="Advanced Filters">
                <i data-lucide="sliders-horizontal" class="h-5 w-5"></i>
            </button>
        </div>
    </div>

    <div id="advanced-filters" class="hidden pt-4 border-t border-[var(--border)]">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-[var(--foreground)]">Advanced Filters</h3>
            <button id="btn-clear-filters"
                class="flex items-center px-3 py-1 text-sm border border-[var(--border)] rounded-md text-[var(--foreground)] hover:bg-[var(--muted)] transition-colors">
                <i data-lucide="x" class="mr-2 h-4 w-4"></i> Clear All
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="space-y-2">
                <label class="text-sm font-medium text-[var(--foreground)]">Price Range</label>
                <select id="filter-price"
                    class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    <option value="">Any Price</option>
                    <option value="0-200000">Under $200,000</option>
                    <option value="200000-400000">$200,000 - $400,000</option>
                    <option value="400000-600000">$400,000 - $600,000</option>
                    <option value="600000-800000">$600,000 - $800,000</option>
                    <option value="800000-1000000">$800,000 - $1,000,000</option>
                    <option value="1000000+">$1,000,000+</option>
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-sm font-medium text-[var(--foreground)]">Bedrooms</label>
                <select id="filter-beds"
                    class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    <option value="">Any</option>
                    <option value="1">1+</option>
                    <option value="2">2+</option>
                    <option value="3">3+</option>
                    <option value="4">4+</option>
                    <option value="5">5+</option>
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-sm font-medium text-[var(--foreground)]">Bathrooms</label>
                <select id="filter-baths"
                    class="w-full px-3 py-2 bg-[var(--input)] border border-[var(--border)] rounded-md text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                    <option value="">Any</option>
                    <option value="1">1+</option>
                    <option value="2">2+</option>
                    <option value="3">3+</option>
                    <option value="4">4+</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="flex items-center justify-between">
    <h2 class="text-xl font-semibold text-[var(--foreground)]">
        Search Results (<span id="results-count">0</span> properties)
    </h2>
    <div class="flex items-center space-x-2">
        <span class="text-sm text-[var(--muted-foreground)] hidden sm:inline">Sort by:</span>
        <select id="sort-order"
            class="bg-[var(--input)] border border-[var(--border)] text-[var(--foreground)] rounded px-2 py-1 text-sm focus:outline-none">
            <option value="relevant">Most Relevant</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="newest">Newest First</option>
        </select>
    </div>
</div>

<div id="property-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- MOCK DATA ---
    const mockProperties = [
        {
            id: 1,
            title: "Modern Downtown Condo",
            location: "Downtown, City Center",
            price: 450000,
            bedrooms: 2,
            bathrooms: 2,
            sqft: 1200,
            image: "https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?auto=format&fit=crop&q=80&w=300&h=200",
            type: "condo",
            status: "active",
            features: ["Balcony", "Gym Access", "Parking"],
            dateAdded: "2025-01-10"
        },
        {
            id: 2,
            title: "Spacious Family Home",
            location: "Suburb Valley",
            price: 650000,
            bedrooms: 4,
            bathrooms: 3,
            sqft: 2400,
            image: "https://images.unsplash.com/photo-1568605114967-8130f3a36994?auto=format&fit=crop&q=80&w=300&h=200",
            type: "house",
            status: "active",
            features: ["Garden", "Garage", "Fireplace"],
            dateAdded: "2025-01-12"
        },
        {
            id: 3,
            title: "Cozy Townhouse",
            location: "Riverside District",
            price: 380000,
            bedrooms: 3,
            bathrooms: 2,
            sqft: 1600,
            image: "https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&q=80&w=300&h=200",
            type: "townhouse",
            status: "active",
            features: ["Patio", "Storage", "Community Pool"],
            dateAdded: "2025-01-05"
        },
        {
            id: 4,
            title: "Luxury Apartment",
            location: "Arts District",
            price: 720000,
            bedrooms: 2,
            bathrooms: 2,
            sqft: 1400,
            image: "https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&q=80&w=300&h=200",
            type: "apartment",
            status: "active",
            features: ["City Views", "Concierge", "Rooftop Access"],
            dateAdded: "2025-01-15"
        },
        {
            id: 5,
            title: "Countryside Villa",
            location: "Green Hills",
            price: 850000,
            bedrooms: 5,
            bathrooms: 4,
            sqft: 3500,
            image: "https://images.unsplash.com/photo-1600596542815-2a4d9fddace7?auto=format&fit=crop&q=80&w=300&h=200",
            type: "house",
            status: "active",
            features: ["Large Lot", "Pool", "Solar Panels"],
            dateAdded: "2025-01-01"
        },
        {
            id: 6,
            title: "Studio Loft",
            location: "Old Town",
            price: 250000,
            bedrooms: 1,
            bathrooms: 1,
            sqft: 800,
            image: "https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?auto=format&fit=crop&q=80&w=300&h=200",
            type: "apartment",
            status: "active",
            features: ["High Ceilings", "Exposed Brick", "Near Transit"],
            dateAdded: "2025-01-14"
        }
    ];

    // --- STATE ---
    let favorites = [1, 3]; // Mock initial favorites
    let currentFilters = {
        keywords: "",
        location: "",
        type: "",
        priceMin: 0,
        priceMax: Infinity,
        beds: 0,
        baths: 0,
        sort: "relevant"
    };

    // --- DOM ELEMENTS ---
    const dom = {
        // Sidebar buttons REMOVED from here, but still need to define grid etc

        grid: document.getElementById('property-grid'),
        resultsCount: document.getElementById('results-count'),

        // Filters
        inputKeywords: document.getElementById('filter-keywords'),
        inputLocation: document.getElementById('filter-location'),
        inputType: document.getElementById('filter-type'),
        inputPrice: document.getElementById('filter-price'),
        inputBeds: document.getElementById('filter-beds'),
        inputBaths: document.getElementById('filter-baths'),
        inputSort: document.getElementById('sort-order'),

        // Buttons
        btnSearch: document.getElementById('btn-search'),
        btnToggleFilters: document.getElementById('btn-toggle-filters'),
        btnClearFilters: document.getElementById('btn-clear-filters'),
        advancedFilters: document.getElementById('advanced-filters')
    };

    // --- INITIALIZATION ---
    function init() {
        // Lucide created by Base
        renderProperties();
        setupEventListeners();
    }

    // --- LOGIC ---

    function formatPrice(price) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            maximumFractionDigits: 0
        }).format(price);
    }

    function getFilteredProperties() {
        return mockProperties.filter(p => {
            // Keyword match
            const keywordMatch = !currentFilters.keywords ||
                p.title.toLowerCase().includes(currentFilters.keywords.toLowerCase()) ||
                p.features.some(f => f.toLowerCase().includes(currentFilters.keywords.toLowerCase()));

            // Location match
            const locationMatch = !currentFilters.location ||
                p.location.toLowerCase().includes(currentFilters.location.toLowerCase());

            // Type match
            const typeMatch = !currentFilters.type || p.type === currentFilters.type;

            // Price match
            const priceMatch = p.price >= currentFilters.priceMin && p.price <= currentFilters.priceMax;

            // Beds/Baths match
            const bedsMatch = p.bedrooms >= currentFilters.beds;
            const bathsMatch = p.bathrooms >= currentFilters.baths;

            return keywordMatch && locationMatch && typeMatch && priceMatch && bedsMatch && bathsMatch;
        }).sort((a, b) => {
            switch (currentFilters.sort) {
                case "price-asc": return a.price - b.price;
                case "price-desc": return b.price - a.price;
                case "newest": return new Date(b.dateAdded) - new Date(a.dateAdded);
                default: return 0; // relevance (id order)
            }
        });
    }

    function renderProperties() {
        const properties = getFilteredProperties();
        if (dom.resultsCount) dom.resultsCount.textContent = properties.length;
        if (dom.grid) dom.grid.innerHTML = "";

        if (!dom.grid) return;

        if (properties.length === 0) {
            dom.grid.innerHTML = `
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-12">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-[var(--muted)]/20 mb-4">
                            <i data-lucide="search-x" class="w-8 h-8 text-[var(--muted-foreground)]"></i>
                        </div>
                        <h3 class="text-lg font-medium text-[var(--foreground)]">No properties found</h3>
                        <p class="text-[var(--muted-foreground)]">Try adjusting your filters to find what you're looking for.</p>
                    </div>
                `;
            if (window.lucide) lucide.createIcons();
            return;
        }

        properties.forEach(p => {
            const isFav = favorites.includes(p.id);
            const card = document.createElement('div');
            card.className = "bg-[var(--card)] rounded-lg border border-[var(--border)] overflow-hidden hover:shadow-lg transition-shadow group";
            card.innerHTML = `
                    <div class="relative">
                        <div class="aspect-video bg-gray-700 relative overflow-hidden">
                            <img src="${p.image}" alt="${p.title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-60"></div>
                            
                            <button onclick="toggleFavorite(${p.id})" class="absolute top-2 right-2 p-2 rounded-full hover:bg-white/20 transition-colors z-10">
                                <i data-lucide="heart" class="w-5 h-5 ${isFav ? 'fill-red-500 text-red-500' : 'text-white'} transition-colors"></i>
                            </button>
                        </div>
                        <div class="absolute bottom-2 left-2">
                            <span class="px-2 py-1 bg-[var(--accent)] text-[var(--bg)] text-xs font-bold rounded capitalize shadow-md">
                                ${p.type}
                            </span>
                        </div>
                    </div>

                    <div class="p-4 space-y-3">
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="font-semibold text-[var(--foreground)] line-clamp-1 text-lg" title="${p.title}">
                                    ${p.title}
                                </h3>
                            </div>
                            <div class="flex items-center text-sm text-[var(--muted-foreground)] mt-1">
                                <i data-lucide="map-pin" class="h-3 w-3 mr-1"></i>
                                ${p.location}
                            </div>
                        </div>

                        <div class="flex items-center justify-between border-t border-[var(--border)] pt-3 mt-2">
                            <span class="text-xl font-bold text-[var(--accent)]">
                                ${formatPrice(p.price)}
                            </span>
                        </div>
                        
                        <div class="flex items-center justify-between text-sm text-[var(--muted-foreground)]">
                            <div class="flex items-center gap-1"><i data-lucide="bed" class="w-4 h-4"></i> <span>${p.bedrooms} bed</span></div>
                            <div class="flex items-center gap-1"><i data-lucide="bath" class="w-4 h-4"></i> <span>${p.bathrooms} bath</span></div>
                            <div class="flex items-center gap-1"><i data-lucide="square" class="w-4 h-4"></i> <span>${p.sqft.toLocaleString()} sqft</span></div>
                        </div>

                        <div class="flex flex-wrap gap-1 pt-1">
                            ${p.features.slice(0, 3).map(f => `
                                <span class="px-2 py-1 bg-[var(--muted)]/20 text-[var(--muted-foreground)] text-xs rounded border border-[var(--border)]">
                                    ${f}
                                </span>
                            `).join('')}
                        </div>

                        <div class="flex space-x-2 pt-2">
                            <button class="flex-1 px-3 py-2 text-sm font-medium border border-[var(--border)] rounded-md text-[var(--foreground)] hover:bg-[var(--muted)] transition-colors">
                                View Details
                            </button>
                            <button class="flex-1 px-3 py-2 text-sm font-medium bg-[var(--accent)] text-[var(--bg)] rounded-md hover:bg-[var(--accent-hover)] transition-colors font-semibold">
                                Contact Agent
                            </button>
                        </div>
                    </div>
                `;
            dom.grid.appendChild(card);
        });
        if (window.lucide) lucide.createIcons();
    }

    // --- ACTIONS ---

    window.toggleFavorite = (id) => {
        if (favorites.includes(id)) {
            favorites = favorites.filter(favId => favId !== id);
        } else {
            favorites.push(id);
        }
        renderProperties(); // Re-render to update icon
    };

    function updateFilters() {
        // Price parsing
        let min = 0, max = Infinity;
        if (dom.inputPrice && dom.inputPrice.value) {
            if (dom.inputPrice.value.includes('+')) {
                min = parseInt(dom.inputPrice.value.replace('+', ''));
            } else {
                const parts = dom.inputPrice.value.split('-');
                min = parseInt(parts[0]);
                max = parseInt(parts[1]);
            }
        }

        currentFilters = {
            keywords: dom.inputKeywords ? dom.inputKeywords.value : "",
            location: dom.inputLocation ? dom.inputLocation.value : "",
            type: dom.inputType ? dom.inputType.value : "",
            priceMin: min,
            priceMax: max,
            beds: dom.inputBeds ? (parseInt(dom.inputBeds.value) || 0) : 0,
            baths: dom.inputBaths ? (parseInt(dom.inputBaths.value) || 0) : 0,
            sort: dom.inputSort ? dom.inputSort.value : "relevant"
        };

        renderProperties();
    }

    function clearFilters() {
        if (dom.inputKeywords) dom.inputKeywords.value = "";
        if (dom.inputLocation) dom.inputLocation.value = "";
        if (dom.inputType) dom.inputType.value = "";
        if (dom.inputPrice) dom.inputPrice.value = "";
        if (dom.inputBeds) dom.inputBeds.value = "";
        if (dom.inputBaths) dom.inputBaths.value = "";

        updateFilters();
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Sidebar Toggle REMOVED - managed by buyer_base.html

        // Filter UI Toggle
        if (dom.btnToggleFilters) {
            dom.btnToggleFilters.addEventListener('click', () => {
                dom.advancedFilters.classList.toggle('hidden');
            });
        }

        // Search Button
        if (dom.btnSearch) {
            dom.btnSearch.addEventListener('click', updateFilters);
        }

        // Clear Filters
        if (dom.btnClearFilters) {
            dom.btnClearFilters.addEventListener('click', clearFilters);
        }

        // Sort Change
        if (dom.inputSort) {
            dom.inputSort.addEventListener('change', updateFilters);
        }

        // Enter key on inputs
        [dom.inputKeywords, dom.inputLocation].forEach(input => {
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') updateFilters();
                });
            }
        });
    }

    // Run
    init();
</script>
{% endblock %}