{% extends 'base.html' %}
{% load static %}

{% block title %}Property Details | OTL Platform{% endblock %}

{% block extra_head %}
<!-- Swiper CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<style>
    .property-detail-swiper {
        width: 100%;
        height: 500px;
        border-radius: 1rem;
    }

    .property-detail-swiper .swiper-slide {
        text-align: center;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .property-detail-swiper .swiper-slide img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .swiper-button-next,
    .swiper-button-prev {
        color: white;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        width: 3rem;
        height: 3rem;
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 1.2rem;
        font-weight: bold;
    }

    .feature-card {
        transition: transform 0.2s;
    }

    .feature-card:hover {
        transform: translateY(-2px);
    }

    /* Share Modal Styles */
    #share-modal {
        animation: modalFadeIn 0.2s ease-out;
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bg-[var(--bg)] min-h-screen pb-16">
    <!-- Breadcrumb -->
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="text-sm breadcrumbs text-[var(--muted-foreground)]">
            <ul>
                <li><a href="/" class="hover:text-[var(--accent)]">Home</a></li>
                <li><a href="/buyer/property-search" class="hover:text-[var(--accent)]">Properties</a></li>
                <li class="text-[var(--foreground)]">Property Details</li>
            </ul>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="flex justify-center items-center h-[50vh]">
        <span class="loading loading-spinner loading-lg text-[var(--accent)]"></span>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden flex flex-col justify-center items-center h-[50vh] text-center px-4">
        <i data-lucide="alert-circle" class="w-16 h-16 text-red-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-[var(--foreground)] mb-2">Unavailable</h2>
        <p class="text-[var(--muted-foreground)] mb-6">This property could not be found or has been removed.</p>
        <a href="/buyer/property-search"
            class="btn btn-outline text-[var(--foreground)] hover:bg-[var(--accent)] hover:text-white hover:border-[var(--accent)]">
            Return to Search
        </a>
    </div>

    <!-- Content (Hidden initially) -->
    <main id="property-content" class="hidden max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header Section -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <div class="flex items-center flex-wrap gap-3 mb-2">
                    <h1 id="prop-price" class="font-heading text-4xl md:text-5xl font-bold text-[var(--accent)]">$0</h1>
                    <span class="text-[var(--muted-foreground)] text-3xl leading-none hidden md:inline">â€¢</span>
                    <span id="prop-location-header"
                        class="text-[var(--muted-foreground)] text-2xl font-medium">Loading...</span>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="share-btn"
                    class="btn btn-outline gap-2 text-[var(--foreground)] hover:bg-[var(--muted)] border-[var(--border)]">
                    <i data-lucide="share-2" class="w-4 h-4"></i> Share
                </button>
                <button
                    class="btn btn-outline gap-2 text-[var(--foreground)] hover:bg-[var(--muted)] border-[var(--border)]">
                    <i data-lucide="heart" class="w-4 h-4"></i> Save
                </button>
            </div>
        </div>

        <!-- Image Gallery & Stats -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            <!-- Left: Image Slider -->
            <div class="lg:col-span-2 space-y-4">
                <div class="swiper property-detail-swiper">
                    <div class="swiper-wrapper" id="swiper-wrapper">
                        <!-- Slides injected via JS -->
                    </div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-pagination"></div>
                </div>
            </div>

            <!-- Right: Quick Stats & Contact -->
            <div class="space-y-6">
                <!-- Key Details Card -->
                <div class="card bg-[var(--card)] border border-[var(--border)] p-6 shadow-sm">
                    <h3 class="font-heading text-xl font-bold text-[var(--foreground)] mb-6">Property Overview</h3>

                    <div class="grid grid-cols-2 gap-y-6">
                        <div class="flex flex-col">
                            <span class="text-[var(--muted-foreground)] text-sm mb-1">Bedrooms</span>
                            <div class="flex items-center gap-2 text-[var(--foreground)] font-bold text-xl">
                                <i data-lucide="bed" class="w-5 h-5 text-[var(--accent)]"></i> <span
                                    id="prop-beds">-</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[var(--muted-foreground)] text-sm mb-1">Bathrooms</span>
                            <div class="flex items-center gap-2 text-[var(--foreground)] font-bold text-xl">
                                <i data-lucide="bath" class="w-5 h-5 text-[var(--accent)]"></i> <span
                                    id="prop-baths">-</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[var(--muted-foreground)] text-sm mb-1">Square Feet</span>
                            <div class="flex items-center gap-2 text-[var(--foreground)] font-bold text-xl">
                                <i data-lucide="square" class="w-5 h-5 text-[var(--accent)]"></i> <span
                                    id="prop-sqft">-</span>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[var(--muted-foreground)] text-sm mb-1">Type</span>
                            <div class="flex items-center gap-2 text-[var(--foreground)] font-bold text-xl">
                                <i data-lucide="home" class="w-5 h-5 text-[var(--accent)]"></i> <span
                                    id="prop-type">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="flex gap-2 mb-2">
                        <span class="badge badge-lg bg-green-100 text-green-700 border-none font-bold">For Sale</span>
                        <span
                            class="badge badge-lg bg-[var(--muted)] text-[var(--muted-foreground)] border-none font-medium"
                            id="prop-added">-</span>
                    </div>
                </div>

                <!-- Contact Card -->
                <div class="card bg-[var(--card)] border border-[var(--border)] p-6 shadow-sm">
                    <h3 class="font-heading text-xl font-bold text-[var(--foreground)] mb-4">Interested?</h3>
                    <p class="text-[var(--muted-foreground)] text-sm mb-6">Contact the seller directly to schedule a
                        viewing or ask questions.</p>
                    <button id="btn-contact-seller"
                        class="btn btn-lg w-full bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white border-none">
                        Contact Seller
                    </button>
                </div>
            </div>
        </div>

        <!-- Description & Details -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-16">
            <div class="lg:col-span-2 space-y-8">
                <!-- Description -->
                <div class="space-y-4">
                    <h2 class="font-heading text-2xl font-bold text-[var(--foreground)]">About this home</h2>
                    <p id="prop-description" class="text-[var(--muted-foreground)] leading-relaxed text-lg">
                        <!-- Description injected here -->
                    </p>
                </div>

                <!-- Features Grid -->
                <div>
                    <h2 class="font-heading text-2xl font-bold text-[var(--foreground)] mb-6">Features and Amenities
                    </h2>
                    <div id="prop-features" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <!-- Features injected here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar: Map or Extra Info -->
            <div class="lg:col-span-1">
                <div class="card bg-[var(--muted)]/10 border border-[var(--border)] p-6 rounded-xl">
                    <h3 class="font-heading text-lg font-bold text-[var(--foreground)] mb-4">Location</h3>
                    <div id="property-map" class="bg-gray-800 rounded-lg h-64 w-full mb-4 z-0 relative"></div>
                    <p id="prop-location-detail" class="text-[var(--muted-foreground)] text-sm"></p>
                </div>
            </div>
        </div>

        <!-- Leaflet CSS & JS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    </main>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-[var(--card)] rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-heading text-lg font-bold text-[var(--foreground)]">Share Property</h3>
                <button id="close-share-modal" class="btn btn-ghost btn-sm">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-4">
                <p class="text-[var(--muted-foreground)] text-sm">Copy the link below to share this property:</p>

                <div class="flex gap-2">
                    <input type="text" id="share-url" readonly
                        class="input input-bordered flex-1 text-sm bg-[var(--muted)]/10 border-[var(--border)]"
                        value="">
                    <button id="copy-link-btn" class="btn btn-primary gap-2">
                        <i data-lucide="copy" class="w-4 h-4"></i>
                        Copy
                    </button>
                </div>

                <div id="copy-success" class="hidden text-green-600 text-sm font-medium flex items-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i>
                    Link copied to clipboard!
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Access Pass Modal -->
<div id="access-modal"
    class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-[var(--card)] rounded-lg shadow-2xl max-w-md w-full border border-[var(--border)] overflow-hidden scale-95 opacity-0 transition-all duration-200"
        id="access-modal-content">
        <div class="p-6 relative">
            <button onclick="closeAccessModal()"
                class="absolute top-4 right-4 text-[var(--muted-foreground)] hover:text-[var(--foreground)] transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <div class="flex flex-col items-center text-center mb-6">
                <div
                    class="w-16 h-16 bg-[var(--accent)]/10 rounded-full flex items-center justify-center mb-4 text-[var(--accent)]">
                    <i data-lucide="lock" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-bold text-[var(--foreground)]">Unlock Property Access</h3>
                <p class="text-[var(--muted-foreground)] mt-2">Get full access to property details, seller contacts, and
                    direct messaging.</p>
            </div>

            <div class="bg-[var(--accent)]/5 border border-[var(--accent)]/20 p-5 rounded-xl mb-6">
                <div class="flex justify-between items-end mb-3">
                    <span class="font-bold text-[var(--accent)] text-3xl">$650</span>
                    <span class="text-sm font-medium text-[var(--muted-foreground)]">/ 30 Days</span>
                </div>
                <ul class="text-sm text-[var(--muted-foreground)] space-y-2.5">
                    <li class="flex items-start gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-[var(--accent)] mt-0.5 shrink-0"></i>
                        <span>Reveal hidden property addresses</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-[var(--accent)] mt-0.5 shrink-0"></i>
                        <span>Unlock seller phone numbers & emails</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4 text-[var(--accent)] mt-0.5 shrink-0"></i>
                        <span>Direct offer submission tools</span>
                    </li>
                </ul>
            </div>

            <button id="btn-buy-access-pass-modal" onclick="purchaseAccessPass()"
                class="w-full py-3.5 bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white font-bold rounded-lg transition-all transform active:scale-[0.98] shadow-lg shadow-[var(--accent)]/20">
                Purchase Access Pass
            </button>
            <p class="text-xs text-center text-[var(--muted-foreground)] mt-4">Secure payment via Stripe. Cancel
                anytime.</p>
        </div>
    </div>
</div>

<!-- Seller Contact Modal -->
<div id="seller-modal"
    class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-[var(--card)] rounded-xl shadow-2xl max-w-md w-full border border-[var(--border)] overflow-hidden scale-95 opacity-0 transition-all duration-200"
        id="seller-modal-content">
        <div class="p-6 relative">
            <button onclick="closeSellerModal()"
                class="absolute top-4 right-4 text-[var(--muted-foreground)] hover:text-[var(--foreground)] transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <div class="flex items-center gap-4 mb-6">
                <div
                    class="w-12 h-12 bg-[var(--accent)]/10 rounded-full flex items-center justify-center text-[var(--accent)]">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-[var(--foreground)]">Seller Information</h3>
                    <p class="text-sm text-[var(--muted-foreground)]">Contact the seller directly</p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="p-4 bg-[var(--muted)]/20 rounded-lg border border-[var(--border)]">
                    <span
                        class="text-xs font-semibold text-[var(--muted-foreground)] uppercase tracking-wider">Name</span>
                    <p id="seller-name" class="text-lg font-medium text-[var(--foreground)] mt-1">--</p>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <a id="seller-email-link" href="#"
                        class="flex items-center gap-3 p-4 bg-[var(--card)] hover:bg-[var(--accent)]/5 border border-[var(--border)] hover:border-[var(--accent)] rounded-lg transition-all group">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-100/10 text-blue-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="mail" class="w-5 h-5"></i>
                        </div>
                        <div class="overflow-hidden">
                            <span class="text-xs font-semibold text-[var(--muted-foreground)] block">Email
                                Address</span>
                            <span id="seller-email"
                                class="text-[var(--foreground)] font-medium truncate block">--</span>
                        </div>
                    </a>

                    <a id="seller-phone-link" href="#"
                        class="flex items-center gap-3 p-4 bg-[var(--card)] hover:bg-[var(--accent)]/5 border border-[var(--border)] hover:border-[var(--accent)] rounded-lg transition-all group">
                        <div
                            class="w-10 h-10 rounded-full bg-green-100/10 text-green-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="phone" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <span class="text-xs font-semibold text-[var(--muted-foreground)] block">Phone Number</span>
                            <span id="seller-phone" class="text-[var(--foreground)] font-medium">--</span>
                        </div>
                    </a>
                </div>
            </div>

            <div class="mt-6 text-center">
                <p class="text-xs text-[var(--muted-foreground)]">Please mention that you found this property on OTL
                    Platform.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
    // --- DOM ELEMENTS ---
    const dom = {
        accessModal: document.getElementById('access-modal'),
        accessModalContent: document.getElementById('access-modal-content'),

        // Seller Modal
        sellerModal: document.getElementById('seller-modal'),
        sellerModalContent: document.getElementById('seller-modal-content'),
        sellerName: document.getElementById('seller-name'),
        sellerEmail: document.getElementById('seller-email'),
        sellerPhone: document.getElementById('seller-phone'),
        sellerEmailLink: document.getElementById('seller-email-link'),
        sellerPhoneLink: document.getElementById('seller-phone-link')
    };

    // --- UTILS ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- MODAL LOGIC ---
    window.openAccessModal = () => {
        if (dom.accessModal) {
            dom.accessModal.classList.remove('hidden');
            // Trigger animation
            setTimeout(() => {
                dom.accessModalContent.classList.remove('scale-95', 'opacity-0');
                dom.accessModalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
    };

    window.closeAccessModal = () => {
        if (dom.accessModal) {
            dom.accessModalContent.classList.remove('scale-100', 'opacity-100');
            dom.accessModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                dom.accessModal.classList.add('hidden');
            }, 200);
        }
    };

    // Seller Modal Logic
    window.openSellerModal = (p) => {
        if (!p || !dom.sellerModal) return;

        // Populate Data
        if (p.seller_info) {
            dom.sellerName.textContent = `${p.seller_info.first_name} ${p.seller_info.last_name}`;
            dom.sellerEmail.textContent = p.seller_info.email;
            dom.sellerPhone.textContent = p.seller_info.phone;

            dom.sellerEmailLink.href = `mailto:${p.seller_info.email}`;
            dom.sellerPhoneLink.href = `tel:${p.seller_info.phone}`;
        } else {
            dom.sellerName.textContent = "Seller Info Unavailable";
            dom.sellerEmail.textContent = "--";
            dom.sellerPhone.textContent = "--";
        }

        dom.sellerModal.classList.remove('hidden');
        setTimeout(() => {
            dom.sellerModalContent.classList.remove('scale-95', 'opacity-0');
            dom.sellerModalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
    };

    window.closeSellerModal = () => {
        if (dom.sellerModal) {
            dom.sellerModalContent.classList.remove('scale-100', 'opacity-100');
            dom.sellerModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                dom.sellerModal.classList.add('hidden');
            }, 200);
        }
    };

    // Close modal on outside click
    window.addEventListener('click', (e) => {
        if (e.target === dom.accessModal) closeAccessModal();
        if (e.target === dom.sellerModal) closeSellerModal();
    });

    async function purchaseAccessPass() {
        const btn = document.getElementById('btn-buy-access-pass-modal');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = `<span class="loading loading-spinner loading-xs text-white"></span> Redirecting...`;
        }

        try {
            const response = await fetch('/api/v1/payment/create-access-pass-session/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();
            if (response.ok && data.url) {
                window.location.href = data.url;
            } else {
                alert('Failed to initiate checkout: ' + (data.error || 'Unknown error'));
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = "Purchase Access Pass";
                }
            }
        } catch (e) {
            console.error(e);
            alert('Error connecting to server');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = "Purchase Access Pass";
            }
        }
    }


    async function loadPropertyDetails() {
        // Parse ID from URL query params
        const urlParams = new URLSearchParams(window.location.search);
        const propertyId = urlParams.get('id');

        if (!propertyId) {
            showError();
            return;
        }

        try {
            // Re-use the existing search endpoint but filter by specific ID if possible, 
            // OR fetch list and find. Since we don't have a public "Retrieve" endpoint for single property yet without auth,
            // we will utilize the existing list endpoint with a filter if supported, or just client-side filter.
            //Ideally, we should have /api/v1/public/properties/<id>, but for now:
            const response = await fetch('/api/v1/buyer/property-search/');
            if (!response.ok) throw new Error('API Error');

            const data = await response.json();
            // Find property in the list (Not efficient for prod, but works for MVP unless we add a specific retrieve endpoint)
            const property = data.find(p => p.id == propertyId);

            if (!property) {
                showError();
                return;
            }

            renderProperty(property);

        } catch (err) {
            console.error(err);
            showError();
        }
    }

    function renderProperty(p) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('property-content').classList.remove('hidden');

        // Basic Info
        document.getElementById('prop-price').textContent = p.price ? `$${Number(p.price).toLocaleString()}` : "$ -";
        document.getElementById('prop-location-header').textContent = p.location || "Location TBD";
        document.getElementById('prop-location-detail').textContent = p.location || "";

        // Stats
        document.getElementById('prop-beds').textContent = p.bedrooms || 0;
        document.getElementById('prop-baths').textContent = p.bathrooms || 0;
        document.getElementById('prop-sqft').textContent = p.sqft ? Number(p.sqft).toLocaleString() : "-";
        document.getElementById('prop-type').textContent = p.type || "Home";

        // Date
        const date = p.dateAdded ? new Date(p.dateAdded).toLocaleDateString() : 'Recently';
        document.getElementById('prop-added').textContent = `Listed ${date}`;

        // Description - Assuming 'description' field exists or we fallback
        // Description - Assuming 'description' field exists or we fallback
        const desc = p.description || p.property_description || "No description provided for this property.";
        const descContainer = document.getElementById('prop-description');
        const charLimit = 250;

        if (desc.length > charLimit) {
            const shortText = desc.substring(0, charLimit);

            // Initial render
            descContainer.innerHTML = `
                <span id="desc-content">${shortText}...</span>
                <button id="desc-toggle" class="text-[var(--accent)] font-bold cursor-pointer hover:underline ml-1 text-base">Show more</button>
            `;

            const toggleBtn = document.getElementById('desc-toggle');
            const contentSpan = document.getElementById('desc-content');
            let isExpanded = false;

            toggleBtn.addEventListener('click', function () {
                isExpanded = !isExpanded;
                if (isExpanded) {
                    contentSpan.textContent = desc;
                    this.textContent = "Show less";
                } else {
                    contentSpan.textContent = shortText + "...";
                    this.textContent = "Show more";
                }
            });
        } else {
            descContainer.textContent = desc;
        }

        // Images (Swiper)
        const swiperWrapper = document.getElementById('swiper-wrapper');
        let images = [];
        if (p.images && p.images.length > 0) {
            images = p.images;
        } else if (p.image) {
            images = [p.image];
        } else {
            images = ['/static/images/hero-bg.jpg'];
        }

        swiperWrapper.innerHTML = images.map(img => `
            <div class="swiper-slide">
                <img src="${img}" alt="Property Image" />
            </div>
        `).join('');

        // Initialize Swiper
        new Swiper('.property-detail-swiper', {
            loop: images.length > 1,
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
        });

        // Features
        // Assuming features is Array or JSON object
        const featuresContainer = document.getElementById('prop-features');
        let features = [];
        // Handle various potential formats for features
        if (Array.isArray(p.features)) {
            features = p.features;
        } else if (typeof p.features === 'object' && p.features !== null) {
            // Smart layout: if value is boolean true, use key. If string, use value.
            features = Object.entries(p.features).map(([k, v]) => {
                if (v === true || String(v).toLowerCase() === 'true') return k;
                if (v === false || String(v).toLowerCase() === 'false') return null;
                return v;
            }).filter(Boolean);
        }

        if (features.length === 0) features = ["Air Conditioning", "Heating", "Parking"]; // Mock if empty

        // Icon mapping helper
        const getFeatureIcon = (feature) => {
            const f = feature.toLowerCase();
            if (f.includes('air') || f.includes('ac') || f.includes('cool')) return 'wind';
            if (f.includes('heat') || f.includes('fire')) return 'flame';
            if (f.includes('park') || f.includes('garage')) return 'car-front';
            if (f.includes('pool') || f.includes('swim') || f.includes('spa')) return 'waves';
            if (f.includes('wifi') || f.includes('internet')) return 'wifi';
            if (f.includes('gym') || f.includes('fit')) return 'dumbbell';
            if (f.includes('security') || f.includes('safe') || f.includes('alarm')) return 'shield-check';
            if (f.includes('garden') || f.includes('yard') || f.includes('lawn')) return 'flower-2';
            if (f.includes('view')) return 'mountain';
            if (f.includes('wash') || f.includes('dry') || f.includes('laundry')) return 'washing-machine';
            if (f.includes('kitchen') || f.includes('dish')) return 'utensils';
            if (f.includes('balcony') || f.includes('patio') || f.includes('deck')) return 'sun';
            if (f.includes('elevator') || f.includes('lift')) return 'arrow-up-down';
            if (f.includes('pet') || f.includes('dog') || f.includes('cat')) return 'paw-print';
            if (f.includes('wheelchair') || f.includes('access')) return 'accessibility';
            if (f.includes('storage')) return 'package';
            return 'check-circle'; // Default
        };

        featuresContainer.innerHTML = features.map(f => {
            const iconName = getFeatureIcon(f.toString());
            return `
            <div class="flex items-center gap-3 p-3 bg-[var(--card)] border border-[var(--border)] rounded-lg feature-card">
                <i data-lucide="${iconName}" class="w-5 h-5 text-[var(--accent)]"></i>
                <span class="text-[var(--foreground)] font-medium text-sm capitalize">${f.toString().replace(/_/g, ' ')}</span>
            </div>
        `}).join('');

        // Re-init icons
        if (window.lucide) lucide.createIcons();

        // Contact Button Logic
        const contactBtn = document.getElementById('btn-contact-seller');
        if (contactBtn) {
            if (p.is_locked) {
                contactBtn.innerHTML = '<i data-lucide="lock" class="w-5 h-5 mr-2"></i> Unlock Info';

                // Set to Accent Color (Same as Purchase Pass) & ensure pointer
                contactBtn.classList.add('bg-[var(--accent)]', 'hover:bg-[var(--accent-hover)]', 'text-white', 'cursor-pointer');

                // Remove specific styles (muted/yellow) if present
                contactBtn.classList.remove('bg-[var(--muted)]', 'text-[var(--muted-foreground)]', 'cursor-not-allowed', 'bg-yellow-600', 'hover:bg-yellow-700');

                // Use the new modal
                contactBtn.onclick = () => window.openAccessModal();
            } else {
                contactBtn.textContent = 'Contact Seller';
                contactBtn.onclick = () => window.openSellerModal(p);

                // Restore standard styles
                contactBtn.classList.add('bg-[var(--accent)]', 'hover:bg-[var(--accent-hover)]', 'text-white');
                contactBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700', 'bg-[var(--muted)]', 'text-[var(--muted-foreground)]', 'cursor-not-allowed');
            }
            if (window.lucide) lucide.createIcons();
        }

        // --- MAP LOGIC ---
        // Construct address for geocoding
        let query = "";
        if (p.location) {
            // p.title is often the Street Address based on serializer logic
            // p.location is "City, State"
            if (p.title && !p.title.startsWith("Property in")) {
                query = `${p.title}, ${p.location}`;
            } else {
                query = p.location;
            }
        }

        if (query && typeof L !== 'undefined') {
            const mapContainer = document.getElementById('property-map');
            if (mapContainer) {
                // Determine if map instance already exists or needs reset
                // For simplicity in this single-page app style, we might just re-init or check key
                // Ideally assign to window variable or clear container
                if (window.propMap) {
                    window.propMap.remove();
                }

                // Default view
                window.propMap = L.map('property-map', {
                    scrollWheelZoom: false,
                    doubleClickZoom: false,
                    touchZoom: false,
                    zoomControl: false,
                    dragging: false
                }).setView([39.8283, -98.5795], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(window.propMap);

                // Geocode
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`, {
                    headers: { 'User-Agent': 'OTL-Platform/1.0' }
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lon = parseFloat(data[0].lon);
                            window.propMap.setView([lat, lon], 14);

                            // "Circle the zone" - adding a circle instead of a pin for privacy/zone indication
                            L.circle([lat, lon], {
                                color: '#16a34a', // Green-600
                                fillColor: '#16a34a',
                                fillOpacity: 0.15,
                                radius: 400 // 400 meters radius
                            }).addTo(window.propMap);

                            // Optional: Add a subtle center dot or keep it just as a zone
                            // L.circleMarker([lat, lon], { radius: 3, color: '#16a34a', fill: true }).addTo(window.propMap);
                        }
                    })
                    .catch(err => console.error("Map Geocode Error:", err));
            }
        }
    }

    function showError() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadPropertyDetails();
        initShareModal();
    });

    function initShareModal() {
        const shareBtn = document.getElementById('share-btn');
        const modal = document.getElementById('share-modal');
        const closeBtn = document.getElementById('close-share-modal');
        const copyBtn = document.getElementById('copy-link-btn');
        const shareUrlInput = document.getElementById('share-url');
        const copySuccess = document.getElementById('copy-success');

        // Show modal when share button is clicked
        shareBtn.addEventListener('click', function () {
            const currentUrl = window.location.href;
            shareUrlInput.value = currentUrl;
            modal.classList.remove('hidden');
            copySuccess.classList.add('hidden');
        });

        // Close modal when close button is clicked
        closeBtn.addEventListener('click', function () {
            modal.classList.add('hidden');
        });

        // Close modal when clicking outside
        modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });

        // Copy link to clipboard
        copyBtn.addEventListener('click', async function () {
            try {
                await navigator.clipboard.writeText(shareUrlInput.value);
                copySuccess.classList.remove('hidden');

                // Hide success message after 3 seconds
                setTimeout(() => {
                    copySuccess.classList.add('hidden');
                }, 3000);

                // Change button text temporarily
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Copied!';
                if (window.lucide) lucide.createIcons();

                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    if (window.lucide) lucide.createIcons();
                }, 2000);

            } catch (err) {
                console.error('Failed to copy: ', err);
                // Fallback for older browsers
                shareUrlInput.select();
                document.execCommand('copy');
                copySuccess.classList.remove('hidden');
                setTimeout(() => {
                    copySuccess.classList.add('hidden');
                }, 3000);
            }
        });
    }
</script>
{% endblock %}