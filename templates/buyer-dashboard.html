{% extends 'buyer_base.html' %}

{% block title %}Buyer Dashboard | OTL Platform{% endblock %}

{% block sidebar %}
{% include 'partials/buyer_sidebar.html' with active_page='dashboard' %}
{% endblock %}

{% block content %}
<div class="space-y-2">
    <h1 class="text-3xl font-bold text-[var(--foreground)]">Welcome back!</h1>
    <p class="text-[var(--muted-foreground)]">Find your perfect property today</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="card bg-[var(--card)] border border-[var(--border)] shadow-sm">
        <div class="card-body p-6 flex-row items-center space-x-4">
            <div class="p-3 bg-blue-100/10 rounded-lg text-blue-400">
                <i data-lucide="eye" class="h-6 w-6"></i>
            </div>
            <div>
                <p class="text-sm text-[var(--muted-foreground)]">Properties Viewed</p>
                <p id="stat-views-count" class="text-2xl font-bold text-[var(--foreground)]">0</p>
                <p id="stat-views-remaining" class="text-xs text-[var(--muted-foreground)]">Calculating...</p>
            </div>
        </div>
    </div>

    <div class="card bg-[var(--card)] border border-[var(--border)] shadow-sm">
        <div class="card-body p-6 flex-row items-center space-x-4">
            <div class="p-3 bg-green-100/10 rounded-lg text-green-400">
                <i data-lucide="bookmark" class="h-6 w-6"></i>
            </div>
            <div>
                <p class="text-sm text-[var(--muted-foreground)]">Saved Searches</p>
                <p class="text-2xl font-bold text-[var(--foreground)]">3</p>
            </div>
        </div>
    </div>


</div>

<div id="access-counter-container" class="card bg-[var(--card)] border border-[var(--border)] p-6 shadow-sm">
</div>

<div class="card bg-[var(--card)] border border-[var(--border)] shadow-xl">
    <div class="card-body p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
                <div class="avatar placeholder">
                    <div class="bg-[var(--accent)] text-[var(--bg)] rounded-full w-16">
                        <span id="profile-avatar-initials" class="text-xl font-bold">JD</span>
                    </div>
                    <button
                        class="absolute -bottom-1 -right-1 btn btn-circle btn-xs border border-[var(--border)] bg-[var(--card)] hover:bg-[var(--muted)]">
                        <i data-lucide="camera" class="h-3 w-3 text-[var(--foreground)]"></i>
                    </button>
                </div>
                <div>
                    <h3 id="profile-display-name" class="font-semibold text-[var(--foreground)] text-lg">
                        John Doe</h3>
                    <p class="text-sm text-[var(--muted-foreground)]">Home Buyer</p>
                    <div class="flex items-center space-x-1 text-xs text-[var(--muted-foreground)] mt-1">
                        <i data-lucide="calendar" class="h-3 w-3"></i>
                        <span id="profile-member-since">Member since Jan 2025</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center space-x-2">
                <button id="btn-edit-profile"
                    class="btn btn-outline border-[var(--border)] text-[var(--foreground)] hover:bg-[var(--muted)] hover:text-[var(--foreground)] btn-sm">
                    <i data-lucide="edit" class="mr-2 h-4 w-4"></i> Edit Profile
                </button>
                <div id="edit-actions" class="hidden flex space-x-2">
                    <button id="btn-cancel-profile" class="btn btn-ghost btn-sm text-[var(--foreground)]">
                        <i data-lucide="x" class="mr-2 h-4 w-4"></i> Cancel
                    </button>
                    <button id="btn-save-profile"
                        class="btn btn-primary btn-sm bg-[var(--accent)] text-[var(--bg)] border-none hover:bg-[var(--accent-hover)]">
                        <i data-lucide="save" class="mr-2 h-4 w-4"></i> Save
                    </button>
                </div>
            </div>
        </div>

        <h3 class="text-lg font-semibold text-[var(--foreground)] mb-4">Personal Information</h3>

        <form id="profile-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">First Name</span>
                </label>
                <input type="text" id="input-first-name"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Last Name</span>
                </label>
                <input type="text" id="input-last-name"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Email Address</span>
                </label>
                <input type="email" id="input-email"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Phone Number</span>
                </label>
                <input type="tel" id="input-phone"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full md:col-span-2">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Location</span>
                </label>
                <input type="text" id="input-location"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
        </form>

        <div id="save-notification" class="hidden mt-4 p-4 rounded-lg border"></div>
    </div>
</div>

<div class="card bg-[var(--card)] border border-[var(--border)] shadow-xl">
    <div class="card-body p-6">
        <h3 class="text-lg font-semibold text-[var(--foreground)] mb-4">Buyer's Agent</h3>

        <div id="agent-view-mode" class="space-y-3">
        </div>

        <div id="agent-edit-mode" class="hidden space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-control w-full md:col-span-2">
                    <label class="label">
                        <span class="label-text text-[var(--foreground)] font-medium">Agent Name</span>
                    </label>
                    <input type="text" id="agent-input-name" placeholder="Enter agent's full name"
                        class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text text-[var(--foreground)] font-medium">Agent Phone</span>
                    </label>
                    <input type="tel" id="agent-input-phone" placeholder="Enter agent's phone"
                        class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text text-[var(--foreground)] font-medium">Agent Email</span>
                    </label>
                    <input type="email" id="agent-input-email" placeholder="Enter agent's email"
                        class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                </div>
                <div class="form-control w-full md:col-span-2">
                    <label class="label">
                        <span class="label-text text-[var(--foreground)] font-medium">Brokerage Company</span>
                    </label>
                    <input type="text" id="agent-input-brokerage" placeholder="Enter brokerage company"
                        class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)]">
                </div>
            </div>
            <div class="alert bg-[var(--muted)]/20 border-none text-sm text-[var(--muted-foreground)]">
                <div>
                    <span class="font-medium">Note:</span> Leave fields empty if you don't have buyer representation.
                </div>
            </div>
        </div>
    </div>
</div>



<div class="card bg-[var(--card)] border border-[var(--border)] shadow-xl">
    <div class="card-body p-6">
        <h2 class="card-title text-xl font-semibold text-[var(--foreground)] mb-4">Recent Activity</h2>
        <ul class="steps steps-vertical">
            <li class="step step-success text-sm text-[var(--foreground)]" data-content="">You viewed "Modern Downtown
                Condo" 2 hours ago</li>
            <li class="step step-primary text-sm text-[var(--foreground)]" data-content="">Viewed "Spacious Family Home"
                1 day ago</li>
            <li class="step step-neutral text-sm text-[var(--foreground)]" data-content="">Updated search preferences
                for downtown area 3 days ago</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- DATA ---
    let profile = {
        first_name: "",
        last_name: "",
        email: "",
        phone_number: "",
        location: "",
        member_since: "",
        agent: null,

    };

    // Usage Stats (Mock - since API doesn't provide these yet, we might need a separate call or default them)
    // For now, we keep stats local as API response doesn't seem to have them in `stats` field, just profile data.
    // If stats are critical, they should be added to the serializer.
    let stats = {
        propertiesViewed: 0,
        planLimit: "unlimited"
    };

    // --- DOM ELEMENTS ---
    const dom = {
        // Stats
        statViewsCount: document.getElementById('stat-views-count'),
        statViewsRemaining: document.getElementById('stat-views-remaining'),

        accessCounterContainer: document.getElementById('access-counter-container'),

        // Profile View
        avatarInitials: document.getElementById('profile-avatar-initials'),
        sidebarInitials: document.getElementById('sidebar-avatar-initials'),
        displayName: document.getElementById('profile-display-name'),
        sidebarName: document.getElementById('sidebar-user-name'),
        memberSince: document.getElementById('profile-member-since'),

        // Inputs
        inputFirstName: document.getElementById('input-first-name'),
        inputLastName: document.getElementById('input-last-name'),
        inputEmail: document.getElementById('input-email'),
        inputPhone: document.getElementById('input-phone'),
        inputLocation: document.getElementById('input-location'),

        // Buttons
        btnEdit: document.getElementById('btn-edit-profile'),
        btnCancel: document.getElementById('btn-cancel-profile'),
        btnSave: document.getElementById('btn-save-profile'),
        editActions: document.getElementById('edit-actions'),
        saveNotification: document.getElementById('save-notification'),

        // Agent Section
        agentView: document.getElementById('agent-view-mode'),
        agentEdit: document.getElementById('agent-edit-mode'),
        agentInputName: document.getElementById('agent-input-name'),
        agentInputPhone: document.getElementById('agent-input-phone'),
        agentInputEmail: document.getElementById('agent-input-email'),
        agentInputBrokerage: document.getElementById('agent-input-brokerage'),


    };

    // --- INITIALIZATION ---
    function init() {
        if (window.lucide) lucide.createIcons();
        fetchProfile();
        setupEventListeners();
    }

    // --- API CALLS ---
    async function fetchProfile() {
        try {
            const response = await fetch('/api/v1/buyer/profile/');
            if (!response.ok) {
                if (response.status === 403 || response.status === 401) {
                    console.warn("User not authenticated or not a buyer. Redirecting to login...");
                    // Optional: window.location.href = "{% url 'login' %}";
                    return;
                }
                throw new Error('Failed to fetch profile');
            }
            const data = await response.json();

            // Map API data to our local profile structure
            profile = {
                first_name: data.first_name || "",
                last_name: data.last_name || "",
                email: data.email || "",
                phone_number: data.phone_number || "",
                location: data.location || "",
                member_since: data.member_since || "",
                agent: data.agent, // API returns {name, phone, email, brokerage_company} or null

            };

            populateData();
            calculateStats(); // Recalculate based on real subscription data if available

        } catch (error) {
            console.error('Error fetching profile:', error);
            // Show error toast?
        }
    }

    async function saveProfile() {
        // Show saving state
        dom.btnSave.innerHTML = `<span class="loading loading-spinner loading-xs"></span> Saving...`;

        const payload = {
            // Flattened structure required by update method in serializer?
            // Checking BuyerProfileSerializer.update:
            // It expects `user` nested dict for first_name, last_name, phone.
            // And top level fields for preferred_location, budget_range.

            // Wait, standard DRF ModelSerializer usually accepts flat structure if source is 'user.first_name' BUT `source` usually means read-only or requires custom update.
            // BuyerProfileSerializer.update explicitly handles `validated_data.pop('user', {})`.
            // So we need to send nested 'user' object? 
            // NO, `source='user.first_name'` on a generic field usually implies read-only unless overridden.
            // HOWEVER, the serializer has a custom `update` method that pops `user`.
            // Serializers with `source='dotted.field'` usually expect the input to be in the nested structure corresponding to the field name IF it's writable?
            // Actually, for writable dotted fields, DRF is tricky. 
            // BUT, let's look at the serializer fields:
            // first_name = serializers.CharField(source="user.first_name")
            // This usually means the input field name is `first_name`. DRF's default behavior for `source` on write is complicated.
            // But the custom `update` method: `user_data = validated_data.pop("user", {})`.
            // This implies `validated_data` will contain a 'user' key. 
            // To get a 'user' key in validated_data from a flat 'first_name' input, the field mapping must happen.

            // Let's assume the API expects the same JSON structure it outputs for updates:
            // { "first_name": "John", "location": "Houston" ... } 
            // If the serializer is set up correctly for Writable Nested Fields, it might handle it.
            // BUT, `BuyerProfileSerializer` defined `first_name` using `source`. 
            // If we send `{"first_name": "New"}`, does it end up in `validated_data['user']['first_name']`?
            // No, standard DRF doesn't auto-nest for source.
            // It likely expects: `{"user": {"first_name": "..."}}` if we want to update user. 
            // OR `first_name` if we treat it flat.

            // Let's try sending flat payload first as that's what `get_serializer` usually outputs.
            // If that fails, we might need to adjust.
            // Wait, the serializer has `first_name = ...`.
            first_name: dom.inputFirstName.value,
            last_name: dom.inputLastName.value,
            phone_number: dom.inputPhone.value,
            location: dom.inputLocation.value,
            // email is read-only in serializer usually, but present in form
            // Sending it shouldn't hurt, or we can omit it if read_only
        };

        try {
            const response = await fetch('/api/v1/buyer/profile/', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errData = await response.json();
                console.error("Server Error:", errData);
                throw new Error('Failed to update');
            }

            // Refresh data
            await fetchProfile();
            setEditMode(false);

            // Success Notification - Toastify
            Toastify({
                text: "Profile updated successfully!",
                duration: 3000,
                close: true,
                gravity: "bottom", // `top` or `bottom`
                position: "right", // `left`, `center` or `right`
                stopOnFocus: true, // Prevents dismissing of toast on hover
                style: {
                    background: "var(--accent)", // Use theme accent color
                    color: "var(--bg)" // Use theme text color for contrast
                }
            }).showToast();

            // Reset Save Button
            dom.btnSave.innerHTML = `<i data-lucide="save" class="mr-2 h-4 w-4"></i> Save`;
            if (window.lucide) lucide.createIcons();

        } catch (error) {
            console.error(error);
            dom.btnSave.innerHTML = `<i data-lucide="save" class="mr-2 h-4 w-4"></i> Save`;
            alert("Failed to save profile. Check console for details.");
        }
    }

    // --- LOGIC ---

    function populateData() {
        // Text Elements
        const fullName = `${profile.first_name} ${profile.last_name}`;
        const initials = (profile.first_name && profile.last_name) ? (profile.first_name[0] + profile.last_name[0]).toUpperCase() : "ME";

        if (dom.avatarInitials) dom.avatarInitials.textContent = initials;
        if (dom.sidebarInitials) dom.sidebarInitials.textContent = initials;
        if (dom.displayName) dom.displayName.textContent = fullName;
        if (dom.sidebarName) dom.sidebarName.textContent = fullName;
        if (dom.memberSince) dom.memberSince.textContent = `Member since ${profile.member_since}`;

        // Inputs
        if (dom.inputFirstName) dom.inputFirstName.value = profile.first_name;
        if (dom.inputLastName) dom.inputLastName.value = profile.last_name;
        if (dom.inputEmail) dom.inputEmail.value = profile.email;
        if (dom.inputPhone) dom.inputPhone.value = profile.phone_number;
        if (dom.inputLocation) dom.inputLocation.value = profile.location;



        // Agent Inputs (for edit mode)
        if (profile.agent) {
            if (dom.agentInputName) dom.agentInputName.value = profile.agent.name || "";
            if (dom.agentInputPhone) dom.agentInputPhone.value = profile.agent.phone || "";
            if (dom.agentInputEmail) dom.agentInputEmail.value = profile.agent.email || "";
            if (dom.agentInputBrokerage) dom.agentInputBrokerage.value = profile.agent.brokerage_company || "";
        }

        renderAgentView();
    }

    function renderAgentView() {
        if (!dom.agentView) return;

        if (profile.agent && profile.agent.name) {
            dom.agentView.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <span class="text-sm font-medium text-[var(--muted-foreground)]">Name</span>
                            <p class="text-[var(--foreground)]">${profile.agent.name}</p>
                        </div>
                        <div class="space-y-1">
                            <span class="text-sm font-medium text-[var(--muted-foreground)]">Phone</span>
                            <p class="text-[var(--foreground)]">${profile.agent.phone}</p>
                        </div>
                        <div class="space-y-1">
                            <span class="text-sm font-medium text-[var(--muted-foreground)]">Email</span>
                            <p class="text-[var(--foreground)]">${profile.agent.email}</p>
                        </div>
                        <div class="space-y-1">
                            <span class="text-sm font-medium text-[var(--muted-foreground)]">Brokerage</span>
                            <p class="text-[var(--foreground)]">${profile.agent.brokerage_company}</p>
                        </div>
                    </div>
                `;
        } else {
            dom.agentView.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-[var(--muted-foreground)] text-lg">None</p>
                    </div>
                `;
        }
    }

    function calculateStats() {
        // Mock calcs if subscription data missing
        if (!profile.subscription) return;

        // Days Remaining Calculation (approximate if format string)
        // If API returns "January 2025", Date.parse works
        const now = new Date();
        const expiry = new Date(profile.subscription.expiration_date);

        // Check if date valid
        if (isNaN(expiry.getTime())) return;

        const diffTime = expiry - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const daysLeft = Math.max(0, diffDays);

        // Access Calculation
        const remainingViews = stats.planLimit === "unlimited" ? "Unlimited" : Math.max(0, stats.planLimit - stats.propertiesViewed);

        // Update DOM Stats
        if (dom.statViewsCount) dom.statViewsCount.textContent = stats.propertiesViewed;
        if (dom.statViewsRemaining) dom.statViewsRemaining.textContent = remainingViews === "Unlimited" ? "Unlimited access" : `${remainingViews} views remaining`;
        if (dom.statDaysLeft) dom.statDaysLeft.textContent = `${daysLeft}d`;

        // Access Status Card Logic
        renderAccessStatus(daysLeft, remainingViews);
    }

    function renderAccessStatus(daysLeft, remainingViews) {
        if (!dom.accessCounterContainer) return;

        let statusClass = "alert-success";
        let statusIcon = "check-circle";
        let message = "";

        if (daysLeft <= 0) {
            statusClass = "alert-error";
            statusIcon = "alert-triangle";
            message = "⚠️ Your access has expired. Please renew to continue viewing properties.";
        } else if (daysLeft <= 7) {
            statusClass = "alert-warning";
            statusIcon = "alert-triangle";
            message = `⚠️ Your plan expires in ${daysLeft} days. Renew to maintain access.`;
        }

        const html = `
                <div class="flex items-center gap-2 mb-2 ${daysLeft <= 7 ? 'text-warning' : 'text-success'}">
                    <i data-lucide="${statusIcon}" class="h-4 w-4"></i>
                    <h4 class="font-medium text-sm">Pro Plan Status</h4>
                </div>
                <div class="space-y-2 text-sm text-[var(--muted-foreground)]">
                    <div class="flex items-center justify-between">
                        <span>Time Remaining:</span>
                        <span class="font-medium flex items-center space-x-1 text-[var(--foreground)]">
                            <i data-lucide="clock" class="h-3 w-3"></i>
                            <span>${daysLeft > 0 ? daysLeft + ' days' : 'Expired'}</span>
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>Properties Left:</span>
                        <span class="font-medium text-[var(--foreground)]">${remainingViews}</span>
                    </div>
                </div>
                ${message ? `<div class="mt-3 text-xs ${daysLeft <= 0 ? 'text-error' : 'text-warning'}">${message}</div>` : ''}
            `;

        dom.accessCounterContainer.innerHTML = html;
        if (window.lucide) lucide.createIcons();
    }

    // Helper to get cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        if (dom.btnEdit) {
            dom.btnEdit.addEventListener('click', () => {
                setEditMode(true);
            });
        }

        if (dom.btnCancel) {
            dom.btnCancel.addEventListener('click', () => {
                setEditMode(false);
                populateData(); // Reset inputs
            });
        }

        if (dom.btnSave) {
            dom.btnSave.addEventListener('click', (e) => {
                e.preventDefault();
                saveProfile();
            });
        }
    }

    function setEditMode(isEditing) {
        if (dom.btnEdit) dom.btnEdit.classList.toggle('hidden', isEditing);
        if (dom.editActions) dom.editActions.classList.toggle('hidden', !isEditing);

        const inputs = [dom.inputFirstName, dom.inputLastName, dom.inputEmail, dom.inputPhone, dom.inputLocation];
        inputs.forEach(input => {
            if (input) input.disabled = !isEditing;
        });

        // Agent edit not supported by API yet, so we keep reading logic but can't save agent updates fully via this endpoint
        // You might want to disable agent inputs or clarify functionality. 
        // For now, we leave them editable but they won't save unless backend supports it.
    }

    // Run
    init();
</script>
{% endblock %}