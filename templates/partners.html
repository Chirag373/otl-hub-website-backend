{% extends 'base.html' %}

{% block title %}Our Partners | OTL Platform{% endblock %}

{% block extra_head %}
<style>
    .line-clamp-1 {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <div class="text-center mb-8">
        <div class="flex items-center justify-center gap-3 mb-6">
            <i data-lucide="users" class="w-8 h-8 text-[var(--accent)]"></i>
            <h1 class="font-heading text-4xl text-[var(--foreground)]">
                Our Partners
            </h1>
        </div>
        <p class="font-heading text-xl text-[var(--accent)] mb-4 max-w-3xl mx-auto">
            Connect with experienced real estate professionals across Texas
        </p>
        <p class="text-lg text-[var(--muted-foreground)] max-w-2xl mx-auto mb-8">
            Our network of licensed professionals are here to help you find your
            perfect property, whether you're buying, selling, or investing
            in Texas real estate.
        </p>
    </div>

    <div class="card bg-[var(--card)] rounded-2xl border border-[var(--border)] p-6 mb-8 shadow-xl">
        <div class="flex flex-col md:flex-row gap-4 mb-4">
            <div class="relative flex-grow">
                <i data-lucide="search"
                    class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-[var(--muted-foreground)] z-10"></i>
                <input type="text" id="partner-search-input"
                    placeholder="Search partners by name, city, county, address, business description, or serving area..."
                    class="input input-bordered w-full pl-12 pr-4 py-3 bg-[var(--muted)] border-[var(--border)] rounded-xl text-[var(--foreground)] placeholder-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)] h-auto" />
            </div>
            
            <button id="toggle-filters-btn"
                class="btn btn-outline border-[var(--border)] text-[var(--foreground)] hover:bg-[var(--muted)] hover:text-[var(--foreground)] hover:border-[var(--border)] font-heading text-sm px-4 py-3 rounded-xl transition-colors h-auto min-h-0 flex-shrink-0">
                <i data-lucide="filter" class="w-4 h-4"></i>
                <span id="filter-btn-text">Filters</span>
            </button>
        </div>

        <div class="flex justify-end mb-2">
             <button id="clear-filters-btn"
                class="hidden btn btn-ghost text-[var(--accent)] hover:bg-[var(--accent)]/10 font-heading text-sm px-3 py-2 rounded-lg transition-colors h-auto min-h-0">
                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                Clear Filters
            </button>
        </div>

        <div id="filter-options"
            class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-[var(--border)]">
            <div class="form-control w-full">
                <label class="label font-heading text-sm font-medium text-[var(--foreground)]">
                    <span class="label-text text-[var(--foreground)]">Location</span>
                </label>
                <select id="location-select"
                    class="select select-bordered w-full px-3 py-2 bg-[var(--muted)] border-[var(--border)] rounded-lg text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)] h-auto">
                    <option value="">All Locations</option>
                    <option value="Houston">Houston</option>
                    <option value="Dallas">Dallas</option>
                    <option value="Austin">Austin</option>
                    <option value="San Antonio">San Antonio</option>
                    <option value="Fort Worth">Fort Worth</option>
                    <option value="Plano">Plano</option>
                </select>
            </div>

            <div class="form-control w-full">
                <label class="label font-heading text-sm font-medium text-[var(--foreground)]">
                    <span class="label-text text-[var(--foreground)]">Language</span>
                </label>
                <select id="language-select"
                    class="select select-bordered w-full px-3 py-2 bg-[var(--muted)] border-[var(--border)] rounded-lg text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)] h-auto">
                    <option value="">All Languages</option>
                    <option value="English">English</option>
                    <option value="Spanish">Spanish</option>
                    <option value="Mandarin">Mandarin</option>
                    <option value="Korean">Korean</option>
                    <option value="Vietnamese">Vietnamese</option>
                    <option value="French">French</option>
                </select>
            </div>
        </div>

        <div id="active-filters-display"
            class="hidden flex flex-wrap gap-2 mt-4 pt-4 border-t border-[var(--border)]">
            <span class="font-heading text-sm text-[var(--muted-foreground)] flex items-center">
                Active filters:
            </span>
            <span id="active-location"
                class="hidden badge badge-outline border-[var(--accent)]/20 bg-[#464646]/10 text-[var(--accent)] gap-1 px-3 py-3 h-auto"></span>
            <span id="active-language"
                class="hidden badge badge-outline border-[var(--accent)]/20 bg-[#464646]/10 text-[var(--accent)] gap-1 px-3 py-3 h-auto"></span>
        </div>
    </div>

    <div class="mb-6">
        <p class="text-lg text-[var(--foreground)]">
            <span id="result-count" class="font-semibold text-[var(--accent)]">0</span>
            <span id="result-text">partners</span> found
        </p>
    </div>

    <div id="partners-container">
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // --- DATA ---
    // Sourced from src/lib/partner-data.ts
    const samplePartners = [
        {
            id: "1",
            firstName: "Sarah",
            lastName: "Johnson",
            title: "Senior Partner",
            category: "Real Estate Agent",
            licensedIn: "TX",
            phone: "(713) 555-0123",
            email: "sarah.johnson@otl-partner.com",
            city: "Houston",
            county: "Harris County",
            companyAddress: "1234 Main Street, Houston, TX 77001",
            businessDescription: "Sarah Johnson is Houston's premier luxury real estate specialist...",
            review: "Outstanding service and market knowledge. Sarah helped us find our dream home in River Oaks!",
            servingCities: "Houston, Bellaire, West University Place, River Oaks, Memorial, Katy, Sugar Land, The Woodlands",
            office: "OTL Houston Central",
            experience: "15+ years",
            languages: ["English", "Spanish"],
            bio: "Sarah Johnson has been helping clients find their dream properties for over 15 years. Specializing in luxury homes..."
        },
        {
            id: "2",
            firstName: "Michael",
            lastName: "Rodriguez",
            title: "Associate Partner",
            category: "Real Estate Agent",
            licensedIn: "TX",
            phone: "(214) 555-0456",
            email: "michael.rodriguez@otl-partner.com",
            city: "Dallas",
            county: "Dallas County",
            companyAddress: "5678 Oak Avenue, Dallas, TX 75201",
            businessDescription: "Michael Rodriguez is a dedicated real estate professional specializing in first-time home buyers...",
            review: "Michael made our first home buying experience stress-free and enjoyable. Highly recommend!",
            servingCities: "Dallas, Fort Worth, Arlington, Plano, Irving, Garland, Grand Prairie, Mesquite, Carrollton",
            office: "OTL Dallas Metro",
            experience: "8+ years",
            languages: ["English", "Spanish"],
            bio: "Michael Rodriguez specializes in helping first-time buyers and families relocate to the Dallas area..."
        },
        {
            id: "3",
            firstName: "Emily",
            lastName: "Chen",
            title: "Associate Partner",
            category: "Real Estate Agent",
            licensedIn: "TX",
            phone: "(512) 555-0789",
            email: "emily.chen@otl-partner.com",
            city: "Austin",
            county: "Travis County",
            companyAddress: "9012 Tech Boulevard, Austin, TX 78701",
            businessDescription: "Emily Chen is Austin's leading tech district specialist...",
            review: "Emily understood exactly what we needed in Austin's competitive market. Found us the perfect tech-savvy home!",
            servingCities: "Austin, Round Rock, Cedar Park, Georgetown, Pflugerville, Leander, Manor, Buda, Kyle",
            office: "OTL Austin Tech",
            experience: "6+ years",
            languages: ["English", "Mandarin"],
            bio: "Emily Chen focuses on Austin's growing tech district and modern architectural homes..."
        },
        {
            id: "4",
            firstName: "David",
            lastName: "Thompson",
            title: "Senior Partner",
            category: "Real Estate Agent",
            licensedIn: "TX",
            phone: "(210) 555-0321",
            email: "david.thompson@otl-partner.com",
            city: "San Antonio",
            county: "Bexar County",
            companyAddress: "3456 Historic Plaza, San Antonio, TX 78201",
            businessDescription: "David Thompson is San Antonio's premier historic properties and military relocation expert...",
            review: "David's expertise in historic properties is unmatched. He helped us preserve and restore our 1920s home beautifully!",
            servingCities: "San Antonio, New Braunfels, Schertz, Cibolo, Converse, Live Oak, Universal City, Alamo Heights, Terrell Hills",
            office: "OTL San Antonio Historic",
            experience: "20+ years",
            languages: ["English"],
            bio: "With over 20 years of experience, David Thompson is the go-to expert for historic properties and military relocations..."
        },
        {
            id: "5",
            firstName: "Lisa",
            lastName: "Martinez",
            title: "Associate Partner",
            category: "Real Estate Agent",
            licensedIn: "TX",
            phone: "(817) 555-0654",
            email: "lisa.martinez@otl-partner.com",
            city: "Fort Worth",
            county: "Tarrant County",
            companyAddress: "7890 Western Drive, Fort Worth, TX 76101",
            businessDescription: "Lisa Martinez is Fort Worth's leading suburban and new construction specialist...",
            review: "Lisa guided us through the entire new construction process. Our home is exactly what we dreamed of!",
            servingCities: "Fort Worth, Arlington, Mansfield, Burleson, North Richland Hills, Hurst, Euless, Bedford, Keller",
            office: "OTL Fort Worth West",
            experience: "10+ years",
            languages: ["English", "Spanish"],
            bio: "Lisa Martinez specializes in suburban family homes and new construction. Her knowledge of Fort Worth's growing communities..."
        },
        {
            id: "6",
            firstName: "Robert",
            lastName: "Kim",
            title: "Associate Partner",
            category: "Real Estate Agent",
            licensedIn: "TX",
            phone: "(469) 555-0987",
            email: "robert.kim@otl-partner.com",
            city: "Plano",
            county: "Collin County",
            companyAddress: "1111 Corporate Center, Plano, TX 75001",
            businessDescription: "Robert Kim is Plano's premier corporate relocation and luxury property specialist...",
            review: "Robert handled our corporate relocation seamlessly. Professional, efficient, and truly understands business needs!",
            servingCities: "Plano, Frisco, McKinney, Allen, Richardson, Garland, Sachse, Murphy, Parker",
            office: "OTL Plano Corporate",
            experience: "12+ years",
            languages: ["English", "Korean"],
            bio: "Robert Kim works extensively with corporate clients and specializes in luxury condominiums and investment properties in Plano..."
        }
    ];

    const categoryOrder = [
        "Lender",
        "Title Company",
        "Home Inspector",
        "Insurance",
        "Contractor",
        "Real Estate Agent",
        "Other",
    ];

    // --- DOM ELEMENTS ---
    const searchInput = document.getElementById('partner-search-input');
    const locationSelect = document.getElementById('location-select');
    const languageSelect = document.getElementById('language-select');
    const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
    const filterBtnText = document.getElementById('filter-btn-text');
    const filterOptions = document.getElementById('filter-options');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const activeFiltersDisplay = document.getElementById('active-filters-display');
    const activeLocationBadge = document.getElementById('active-location');
    const activeLanguageBadge = document.getElementById('active-language');
    const partnersContainer = document.getElementById('partners-container');
    const resultCountSpan = document.getElementById('result-count');
    const resultTextSpan = document.getElementById('result-text');

    // --- STATE ---
    let filters = {
        search: "",
        location: "",
        language: ""
    };

    // --- INITIALIZATION ---
    function init() {
        if (window.lucide) {
            lucide.createIcons();
        }
        renderPartners();
        setupEventListeners();
    }

    // --- FILTER LOGIC ---
    function getFilteredPartners() {
        return samplePartners.filter(partner => {
            const searchLower = filters.search.toLowerCase();
            const matchesSearch =
                `${partner.firstName} ${partner.lastName}`.toLowerCase().includes(searchLower) ||
                partner.city.toLowerCase().includes(searchLower) ||
                partner.county.toLowerCase().includes(searchLower) ||
                partner.office.toLowerCase().includes(searchLower) ||
                partner.companyAddress.toLowerCase().includes(searchLower) ||
                partner.businessDescription.toLowerCase().includes(searchLower) ||
                partner.servingCities.toLowerCase().includes(searchLower) ||
                partner.bio.toLowerCase().includes(searchLower);

            const matchesLocation = !filters.location || filters.location === "All Locations" || partner.city === filters.location;
            const matchesLanguage = !filters.language || partner.languages.includes(filters.language);

            return matchesSearch && matchesLocation && matchesLanguage;
        });
    }

    function groupPartners(partners) {
        const groups = {};
        partners.forEach(partner => {
            const key = partner.category || "Other";
            if (!groups[key]) groups[key] = [];
            groups[key].push(partner);
        });
        return groups;
    }

    // --- RENDERING ---
    function renderPartners() {
        const filtered = getFilteredPartners();
        const grouped = groupPartners(filtered);

        // Update stats
        resultCountSpan.textContent = filtered.length;
        resultTextSpan.textContent = filtered.length === 1 ? 'partner' : 'partners';

        // Clear container
        partnersContainer.innerHTML = '';

        if (filtered.length === 0) {
            partnersContainer.innerHTML = `
                <div class="text-center py-16">
                    <div class="card bg-[var(--card)] rounded-2xl border border-[var(--border)] p-12 max-w-md mx-auto shadow-xl">
                        <i data-lucide="users" class="w-16 h-16 text-[var(--muted-foreground)] mx-auto mb-6"></i>
                        <h3 class="font-heading text-2xl text-[var(--foreground)] mb-4">No partners found</h3>
                        <p class="text-[var(--muted-foreground)] mb-6">Try adjusting your search criteria or filters to find the right partners for your needs.</p>
                    </div>
                </div>
            `;
            if (window.lucide) lucide.createIcons();
            return;
        }

        // Determine rendering order
        const availableCategories = Object.keys(grouped);
        const sortedCategories = [
            ...categoryOrder.filter(c => availableCategories.includes(c)),
            ...availableCategories.filter(c => !categoryOrder.includes(c))
        ];

        // Render Sections
        sortedCategories.forEach(category => {
            const categoryPartners = grouped[category];
            if (!categoryPartners || categoryPartners.length === 0) return;

            const section = document.createElement('section');
            section.className = 'mb-12';

            const gridHtml = categoryPartners.map(partner => createPartnerCardHtml(partner)).join('');

            section.innerHTML = `
                <div class="flex items-baseline justify-between mb-4">
                    <h2 class="font-heading text-2xl text-[var(--foreground)]">${category}</h2>
                    <span class="text-sm text-[var(--muted-foreground)]">
                        ${categoryPartners.length} ${categoryPartners.length === 1 ? 'partner' : 'partners'}
                    </span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    ${gridHtml}
                </div>
            `;
            partnersContainer.appendChild(section);
        });

        if (window.lucide) lucide.createIcons();
    }

    function createPartnerCardHtml(partner) {
        return `
            <article class="card bg-[var(--card)] rounded-xl overflow-hidden border border-[var(--border)] shadow-md hover:shadow-lg transition-all duration-300 hover:border-[var(--accent)]/30">
                <div class="card-body p-5">
                    <div class="flex gap-4 mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-[var(--accent)]/20 to-[var(--accent)]/10 flex items-center justify-center border-2 border-[var(--accent)]/30">
                                <i data-lucide="user" class="w-8 h-8 text-[var(--accent)]"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="card-title font-heading text-xl font-bold text-[var(--foreground)] mb-1">
                                ${partner.firstName} ${partner.lastName}
                            </h3>
                            <p class="font-medium text-[var(--accent)] text-sm mb-3">${partner.title}</p>
                            <div class="grid grid-cols-1 gap-2 mb-3">
                                <div class="flex items-center gap-2 text-sm text-[var(--muted-foreground)]">
                                    <i data-lucide="award" class="w-4 h-4"></i>
                                    <span>Licensed in ${partner.licensedIn}</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm text-[var(--muted-foreground)]">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                    <span>${partner.experience}</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm text-[var(--muted-foreground)]">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i>
                                    <span>${partner.city}, ${partner.county}</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="flex items-center gap-2 text-sm text-[var(--muted-foreground)]">
                                    <i data-lucide="building-2" class="w-4 h-4"></i>
                                    <span class="line-clamp-1">${partner.office}</span>
                                </div>
                            </div>
                            <div class="mb-4">
                                <p class="text-sm text-[var(--muted-foreground)]">
                                    <span class="font-medium">Languages:</span> ${partner.languages.join(", ")}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4 px-0">
                        <div class="bg-[var(--muted)]/10 rounded-lg p-3 border border-[var(--border)]">
                            <div class="text-sm text-[var(--foreground)] leading-relaxed line-clamp-2">
                                ${partner.bio}
                            </div>
                            <button class="btn btn-link btn-xs no-underline flex items-center gap-1 mt-2 text-[var(--accent)] hover:text-[var(--accent-hover)] transition-colors font-medium p-0 h-auto min-h-0">
                                <i data-lucide="file-text" class="w-3 h-3"></i> Show More
                            </button>
                        </div>
                    </div>
                    <div class="card-actions border-t border-[var(--border)] pt-4 mt-0">
                        <button class="btn btn-block font-heading text-sm font-semibold bg-gradient-to-r from-[var(--accent)] to-[var(--accent-hover)] text-white border-none rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center">
                            <i data-lucide="mail" class="w-4 h-4 mr-2"></i> Contact
                        </button>
                    </div>
                </div>
            </article>
        `;
    }

    function updateUIControls() {
        // Toggle Clear button logic
        const hasFilters = filters.location || filters.language;
        if (hasFilters) {
            clearFiltersBtn.classList.remove('hidden');
            activeFiltersDisplay.classList.remove('hidden');
            activeFiltersDisplay.classList.add('flex');
        } else {
            clearFiltersBtn.classList.add('hidden');
            activeFiltersDisplay.classList.add('hidden');
            activeFiltersDisplay.classList.remove('flex');
        }

        // Update Badges
        if (filters.location) {
            activeLocationBadge.textContent = `Location: ${filters.location}`;
            activeLocationBadge.classList.remove('hidden');
        } else {
            activeLocationBadge.classList.add('hidden');
        }

        if (filters.language) {
            activeLanguageBadge.textContent = `Language: ${filters.language}`;
            activeLanguageBadge.classList.remove('hidden');
        } else {
            activeLanguageBadge.classList.add('hidden');
        }
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Filter Toggle
        if (toggleFiltersBtn) {
            toggleFiltersBtn.addEventListener('click', () => {
                filterOptions.classList.toggle('hidden');
                // Removed dynamic text update to keep it simple "Filters" or icon only if preferred
                // filterBtnText.textContent = filterOptions.classList.contains('hidden') ? "Show Filters" : "Hide Filters";
            });
        }

        // Inputs
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                filters.search = e.target.value;
                renderPartners();
            });
        }

        if (locationSelect) {
            locationSelect.addEventListener('change', (e) => {
                filters.location = e.target.value;
                updateUIControls();
                renderPartners();
            });
        }

        if (languageSelect) {
            languageSelect.addEventListener('change', (e) => {
                filters.language = e.target.value;
                updateUIControls();
                renderPartners();
            });
        }

        // Clear Filters
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                filters.search = "";
                filters.location = "";
                filters.language = "";

                searchInput.value = "";
                locationSelect.value = "";
                languageSelect.value = "";

                updateUIControls();
                renderPartners();
            });
        }
    }

    // Run
    init();
</script>
{% endblock %}