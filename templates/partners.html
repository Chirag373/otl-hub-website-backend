{% extends 'base.html' %}

{% block title %}Our Partners | OTL Platform{% endblock %}

{% block extra_head %}
<style>
    .line-clamp-1 {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Modal Backdrop Blur */
    #contact_modal::backdrop,
    .modal-backdrop {
        backdrop-filter: blur(5px);
        background-color: rgba(0, 0, 0, 0.3) !important;
        /* Semi-transparent overlay */
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <div class="text-center mb-8">
        <div class="flex items-center justify-center gap-3 mb-6">
            <i data-lucide="users" class="w-8 h-8 text-[var(--accent)]"></i>
            <h1 class="font-heading text-4xl text-[var(--foreground)]">
                Our Partners
            </h1>
        </div>
        <p class="font-heading text-xl text-[var(--accent)] mb-4 max-w-3xl mx-auto">
            Connect with experienced real estate professionals across Texas
        </p>
        <p class="text-lg text-[var(--muted-foreground)] max-w-2xl mx-auto mb-8">
            Our network of licensed professionals are here to help you find your
            perfect property, whether you're buying, selling, or investing
            in Texas real estate.
        </p>
    </div>

    <div class="card bg-[var(--card)] rounded-2xl border border-[var(--border)] p-6 mb-8 shadow-xl">
        <div class="flex flex-col md:flex-row gap-4 mb-4">
            <div class="relative flex-grow">
                <i data-lucide="search"
                    class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-[var(--muted-foreground)] z-10"></i>
                <input type="text" id="partner-search-input"
                    placeholder="Search partners by name, city, county, address, business description, or serving area..."
                    class="input input-bordered w-full pl-12 pr-4 py-3 bg-[var(--muted)] border-[var(--border)] rounded-xl text-[var(--foreground)] placeholder-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)] h-auto" />
            </div>

            <button id="toggle-filters-btn"
                class="btn btn-outline border-[var(--border)] text-[var(--foreground)] hover:bg-[var(--muted)] hover:text-[var(--foreground)] hover:border-[var(--border)] font-heading text-sm px-4 py-3 rounded-xl transition-colors h-auto min-h-0 flex-shrink-0">
                <i data-lucide="filter" class="w-4 h-4"></i>
                <span id="filter-btn-text">Filters</span>
            </button>
        </div>

        <div class="flex justify-end mb-2">
            <button id="clear-filters-btn"
                class="hidden btn btn-ghost text-[var(--accent)] hover:bg-[var(--accent)]/10 font-heading text-sm px-3 py-2 rounded-lg transition-colors h-auto min-h-0">
                <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                Clear Filters
            </button>
        </div>

        <div id="filter-options"
            class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-[var(--border)]">
            <div class="form-control w-full">
                <label class="label font-heading text-sm font-medium text-[var(--foreground)]">
                    <span class="label-text text-[var(--foreground)]">Location</span>
                </label>
                <select id="location-select"
                    class="select select-bordered w-full px-3 py-2 bg-[var(--muted)] border-[var(--border)] rounded-lg text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)] h-auto">
                    <option value="">All Locations</option>
                    <option value="Houston">Houston</option>
                    <option value="Dallas">Dallas</option>
                    <option value="Austin">Austin</option>
                    <option value="San Antonio">San Antonio</option>
                    <option value="Fort Worth">Fort Worth</option>
                    <option value="Plano">Plano</option>
                </select>
            </div>

            <div class="form-control w-full">
                <label class="label font-heading text-sm font-medium text-[var(--foreground)]">
                    <span class="label-text text-[var(--foreground)]">Language</span>
                </label>
                <select id="language-select"
                    class="select select-bordered w-full px-3 py-2 bg-[var(--muted)] border-[var(--border)] rounded-lg text-[var(--foreground)] focus:outline-none focus:border-[var(--accent)] h-auto">
                    <option value="">All Languages</option>
                    <option value="English">English</option>
                    <option value="Spanish">Spanish</option>
                    <option value="Mandarin">Mandarin</option>
                    <option value="Korean">Korean</option>
                    <option value="Vietnamese">Vietnamese</option>
                    <option value="French">French</option>
                </select>
            </div>
        </div>

        <div id="active-filters-display" class="hidden flex flex-wrap gap-2 mt-4 pt-4 border-t border-[var(--border)]">
            <span class="font-heading text-sm text-[var(--muted-foreground)] flex items-center">
                Active filters:
            </span>
            <span id="active-location"
                class="hidden badge badge-outline border-[var(--accent)]/20 bg-[#464646]/10 text-[var(--accent)] gap-1 px-3 py-3 h-auto"></span>
            <span id="active-language"
                class="hidden badge badge-outline border-[var(--accent)]/20 bg-[#464646]/10 text-[var(--accent)] gap-1 px-3 py-3 h-auto"></span>
        </div>
    </div>

    <div class="mb-6">
        <p class="text-lg text-[var(--foreground)]">
            <span id="result-count" class="font-semibold text-[var(--accent)]">0</span>
            <span id="result-text">partners</span> found
        </p>
    </div>

    <div id="partners-container">
    </div>

    <!-- Contact Modal -->
    <dialog id="contact_modal" class="modal">
        <div class="modal-box bg-[var(--card)] border border-[var(--border)]">
            <h3 class="font-bold text-lg text-[var(--foreground)]" id="modal-partner-name">Contact Partner</h3>
            <div class="py-4 space-y-4">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-[var(--accent)]/10 rounded-lg">
                        <i data-lucide="mail" class="w-5 h-5 text-[var(--accent)]"></i>
                    </div>
                    <div>
                        <p class="text-sm text-[var(--muted-foreground)]">Email Address</p>
                        <a href="#" id="modal-partner-email"
                            class="text-[var(--foreground)] hover:text-[var(--accent)] transition-colors font-medium"></a>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-[var(--accent)]/10 rounded-lg">
                        <i data-lucide="phone" class="w-5 h-5 text-[var(--accent)]"></i>
                    </div>
                    <div>
                        <p class="text-sm text-[var(--muted-foreground)]">Phone Number</p>
                        <a href="#" id="modal-partner-phone"
                            class="text-[var(--foreground)] hover:text-[var(--accent)] transition-colors font-medium"></a>
                    </div>
                </div>
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn btn-ghost text-[var(--foreground)]">Close</button>
                    <a href="#" id="modal-email-btn"
                        class="btn bg-[var(--accent)] text-white hover:bg-[var(--accent-hover)] border-none">Send
                        Email</a>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // --- DATA ---
    let partners = [];

    const categoryOrder = [
        "Lender",
        "Title Company",
        "Home Inspector",
        "Insurance",
        "Contractor",
        "Real Estate Agent",
        "Other",
    ];

    // --- DOM ELEMENTS ---
    const searchInput = document.getElementById('partner-search-input');
    const locationSelect = document.getElementById('location-select');
    const languageSelect = document.getElementById('language-select');
    const toggleFiltersBtn = document.getElementById('toggle-filters-btn');
    const filterBtnText = document.getElementById('filter-btn-text');
    const filterOptions = document.getElementById('filter-options');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    const activeFiltersDisplay = document.getElementById('active-filters-display');
    const activeLocationBadge = document.getElementById('active-location');
    const activeLanguageBadge = document.getElementById('active-language');
    const partnersContainer = document.getElementById('partners-container');
    const resultCountSpan = document.getElementById('result-count');
    const resultTextSpan = document.getElementById('result-text');

    // --- STATE ---
    let filters = {
        search: "",
        location: "",
        language: ""
    };

    // --- INITIALIZATION ---
    function init() {
        if (window.lucide) {
            lucide.createIcons();
        }
        fetchPartners();
        setupEventListeners();
    }

    // --- API ---
    async function fetchPartners() {
        try {
            partnersContainer.innerHTML = '<div class="text-center py-8"><span class="loading loading-spinner loading-lg text-[var(--accent)]"></span></div>';

            const response = await fetch('/api/v1/partners/');
            if (!response.ok) throw new Error("Failed to fetch partners");

            const data = await response.json();

            // Map API data to frontend format
            partners = data.map(p => ({
                id: p.email, // Use email as unique ID if ID not available
                firstName: p.first_name,
                lastName: p.last_name,
                title: p.partnership_type_display, // Specific title
                category: p.partnership_type_display,
                licensedIn: p.business_license_number ? "TX" : "N/A", // Assume TX based on context
                phone: p.phone_number,
                email: p.email,
                city: p.service_areas ? p.service_areas.split(',')[0].trim() : "Unknown", // Naive parse
                county: "", // Not available
                companyAddress: p.website_url, // Use website as address fallback for display
                businessDescription: `Professional ${p.partnership_type_display} serving ${p.service_areas}`,
                review: "Top rated professional.", // Mock
                servingCities: p.service_areas,
                office: p.company_name,
                experience: `Member since ${p.member_since}`,
                languages: ["English"], // Default
                bio: `Contact ${p.first_name} for your ${p.partnership_type_display} needs.`,
                licenseNumber: p.business_license_number
            }));

            renderPartners();

        } catch (error) {
            console.error(error);
            partnersContainer.innerHTML = `<div class="alert alert-error">Failed to load partners. Please try again later.</div>`;
        }
    }

    // --- FILTER LOGIC ---
    function getFilteredPartners() {
        return partners.filter(partner => {
            const searchLower = filters.search.toLowerCase();
            const matchesSearch =
                `${partner.firstName} ${partner.lastName}`.toLowerCase().includes(searchLower) ||
                (partner.city && partner.city.toLowerCase().includes(searchLower)) ||
                (partner.office && partner.office.toLowerCase().includes(searchLower)) ||
                (partner.businessDescription && partner.businessDescription.toLowerCase().includes(searchLower)) ||
                (partner.servingCities && partner.servingCities.toLowerCase().includes(searchLower));

            const matchesLocation = !filters.location || filters.location === "All Locations" || (partner.city && partner.city.includes(filters.location)) || (partner.servingCities && partner.servingCities.includes(filters.location));

            // Simplified language filter since we don't have real language data yet
            const matchesLanguage = !filters.language || (partner.languages && partner.languages.includes(filters.language));

            return matchesSearch && matchesLocation && matchesLanguage;
        });
    }

    // --- RENDERING ---
    function renderPartners() {
        const filtered = getFilteredPartners();

        // Update stats
        resultCountSpan.textContent = filtered.length;
        resultTextSpan.textContent = filtered.length === 1 ? 'partner' : 'partners';

        // Clear container
        partnersContainer.innerHTML = '';

        if (filtered.length === 0) {
            partnersContainer.innerHTML = `
                <div class="text-center py-16">
                    <div class="card bg-[var(--card)] rounded-2xl border border-[var(--border)] p-12 max-w-md mx-auto shadow-xl">
                        <i data-lucide="users" class="w-16 h-16 text-[var(--muted-foreground)] mx-auto mb-6"></i>
                        <h3 class="font-heading text-2xl text-[var(--foreground)] mb-4">No partners found</h3>
                        <p class="text-[var(--muted-foreground)] mb-6">Try adjusting your search criteria or filters to find the right partners for your needs.</p>
                    </div>
                </div>
            `;
            if (window.lucide) lucide.createIcons();
            return;
        }

        const gridHtml = filtered.map(partner => createPartnerCardHtml(partner)).join('');

        partnersContainer.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                ${gridHtml}
            </div>
        `;

        if (window.lucide) lucide.createIcons();
    }

    function createPartnerCardHtml(partner) {
        // Safe stringify for onclick
        const partnerData = JSON.stringify({
            name: `${partner.firstName} ${partner.lastName}`,
            email: partner.email,
            phone: partner.phone
        }).replace(/"/g, '&quot;');

        return `
            <article class="card bg-[var(--card)] rounded-xl overflow-hidden border border-[var(--border)] shadow-md hover:shadow-lg transition-all duration-300 hover:border-[var(--accent)]/30">
                <div class="card-body p-5">
                    <div class="flex gap-4 mb-4">
                        <div class="flex-shrink-0">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-[var(--accent)]/20 to-[var(--accent)]/10 flex items-center justify-center border-2 border-[var(--accent)]/30">
                                <i data-lucide="user" class="w-8 h-8 text-[var(--accent)]"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="card-title font-heading text-xl font-bold text-[var(--foreground)] mb-1">
                                ${partner.firstName} ${partner.lastName}
                            </h3>
                            <p class="font-medium text-[var(--accent)] text-sm mb-3">${partner.title}</p>
                            <div class="grid grid-cols-1 gap-2 mb-3">
                                <div class="flex items-center gap-2 text-sm text-[var(--muted-foreground)]">
                                    <i data-lucide="award" class="w-4 h-4"></i>
                                    <span>Licensed in ${partner.licensedIn}</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm text-[var(--muted-foreground)]">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                    <span>${partner.experience}</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm text-[var(--muted-foreground)]">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i>
                                    <span>${partner.city} ${partner.county ? ', ' + partner.county : ''}</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="flex items-center gap-2 text-sm text-[var(--muted-foreground)]">
                                    <i data-lucide="building-2" class="w-4 h-4"></i>
                                    <span class="line-clamp-1">${partner.office}</span>
                                </div>
                            </div>
                            <!-- Languages Hidden if mock -->
                        </div>
                    </div>
                    <div class="mb-4 px-0">
                        <div class="bg-[var(--muted)]/10 rounded-lg p-3 border border-[var(--border)]">
                            <div class="text-sm text-[var(--foreground)] leading-relaxed line-clamp-2">
                                ${partner.bio}
                            </div>
                            <!-- Show More removed for brevity if no real modal -->
                        </div>
                    </div>
                    <div class="card-actions border-t border-[var(--border)] pt-4 mt-0">
                        <button onclick="handleContactClick(${partnerData})" class="btn btn-block font-heading text-sm font-semibold bg-gradient-to-r from-[var(--accent)] to-[var(--accent-hover)] text-white border-none rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center">
                            <i data-lucide="mail" class="w-4 h-4 mr-2"></i> Contact
                        </button>
                    </div>
                </div>
            </article>
        `;
    }

    function handleContactClick(data) {
        document.getElementById('modal-partner-name').textContent = `Contact ${data.name}`;

        const emailLink = document.getElementById('modal-partner-email');
        emailLink.textContent = data.email || "Not Available";
        emailLink.href = data.email ? `mailto:${data.email}` : "#";

        const phoneLink = document.getElementById('modal-partner-phone');
        phoneLink.textContent = data.phone || "Not Available";
        phoneLink.href = data.phone ? `tel:${data.phone}` : "#";

        const sendBtn = document.getElementById('modal-email-btn');
        sendBtn.href = data.email ? `mailto:${data.email}` : "#";
        if (!data.email) sendBtn.classList.add('btn-disabled');
        else sendBtn.classList.remove('btn-disabled');

        document.getElementById('contact_modal').showModal();
    }

    // Expose to global scope for onclick
    window.handleContactClick = handleContactClick;

    function updateUIControls() {
        // Toggle Clear button logic
        const hasFilters = filters.location || filters.language;
        if (hasFilters) {
            clearFiltersBtn.classList.remove('hidden');
            activeFiltersDisplay.classList.remove('hidden');
            activeFiltersDisplay.classList.add('flex');
        } else {
            clearFiltersBtn.classList.add('hidden');
            activeFiltersDisplay.classList.add('hidden');
            activeFiltersDisplay.classList.remove('flex');
        }

        // Update Badges
        if (filters.location) {
            activeLocationBadge.textContent = `Location: ${filters.location}`;
            activeLocationBadge.classList.remove('hidden');
        } else {
            activeLocationBadge.classList.add('hidden');
        }

        if (filters.language) {
            activeLanguageBadge.textContent = `Language: ${filters.language}`;
            activeLanguageBadge.classList.remove('hidden');
        } else {
            activeLanguageBadge.classList.add('hidden');
        }
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Filter Toggle
        if (toggleFiltersBtn) {
            toggleFiltersBtn.addEventListener('click', () => {
                filterOptions.classList.toggle('hidden');
            });
        }

        // Inputs
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                filters.search = e.target.value;
                renderPartners();
            });
        }

        if (locationSelect) {
            locationSelect.addEventListener('change', (e) => {
                filters.location = e.target.value;
                updateUIControls();
                renderPartners();
            });
        }

        if (languageSelect) {
            languageSelect.addEventListener('change', (e) => {
                filters.language = e.target.value;
                updateUIControls();
                renderPartners();
            });
        }

        // Clear Filters
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', () => {
                filters.search = "";
                filters.location = "";
                filters.language = "";

                searchInput.value = "";
                locationSelect.value = "";
                languageSelect.value = "";

                updateUIControls();
                renderPartners();
            });
        }
    }

    // Run
    init();
</script>
{% endblock %}