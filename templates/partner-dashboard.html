{% extends 'partner_base.html' %}

{% block title %}Partner Dashboard | OTL Platform{% endblock %}

{% block content %}
<div class="space-y-2">
    <h1 class="text-3xl font-bold text-[var(--foreground)]">Partner Dashboard</h1>
    <p class="text-[var(--muted-foreground)]">Manage your business partnership and track performance</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="card bg-[var(--card)] border border-[var(--border)] shadow-sm">
        <div class="card-body p-4 flex-row items-center space-x-4">
            <div class="p-3 bg-green-100/10 rounded-lg text-green-400">
                <i data-lucide="trending-up" class="h-6 w-6"></i>
            </div>
            <div>
                <p class="text-sm text-[var(--muted-foreground)]">Revenue This Month</p>
                <p class="text-xl font-bold text-[var(--foreground)]">$12,450</p>
            </div>
        </div>
    </div>

    <div class="card bg-[var(--card)] border border-[var(--border)] shadow-sm">
        <div class="card-body p-4 flex-row items-center space-x-4">
            <div class="p-3 bg-yellow-100/10 rounded-lg text-yellow-400">
                <i data-lucide="star" class="h-6 w-6"></i>
            </div>
            <div>
                <p class="text-sm text-[var(--muted-foreground)]">Average Rating</p>
                <p class="text-xl font-bold text-[var(--foreground)]">4.8â˜…</p>
            </div>
        </div>
    </div>
</div>

<div class="card bg-[var(--card)] border border-[var(--border)] shadow-xl">
    <div class="card-body p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
                <div class="avatar placeholder">
                    <div class="bg-[var(--accent)] text-[var(--bg)] rounded-full w-16">
                        <span id="profile-avatar-initials" class="text-xl font-bold">SJ</span>
                    </div>
                    <button
                        class="absolute -bottom-1 -right-1 btn btn-circle btn-xs border border-[var(--border)] bg-[var(--card)] hover:bg-[var(--muted)]">
                        <i data-lucide="camera" class="h-3 w-3 text-[var(--foreground)]"></i>
                    </button>
                </div>
                <div>
                    <h3 id="profile-display-name" class="font-semibold text-[var(--foreground)] text-lg">
                        Sarah Johnson</h3>
                    <p id="profile-role" class="text-sm text-[var(--muted-foreground)]">Home Inspector</p>
                    <div class="flex items-center space-x-1 text-xs text-[var(--muted-foreground)] mt-1">
                        <i data-lucide="calendar" class="h-3 w-3"></i>
                        <span id="profile-member-since">Partner since March 2022</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center space-x-2">
                <button id="btn-edit-profile"
                    class="btn btn-outline border-[var(--border)] text-[var(--foreground)] hover:bg-[var(--muted)] hover:text-[var(--foreground)] btn-sm">
                    <i data-lucide="edit" class="mr-2 h-4 w-4"></i> Edit Profile
                </button>
                <div id="edit-actions" class="hidden flex space-x-2">
                    <button id="btn-cancel-profile" class="btn btn-ghost btn-sm text-[var(--foreground)]">
                        <i data-lucide="x" class="mr-2 h-4 w-4"></i> Cancel
                    </button>
                    <button id="btn-save-profile"
                        class="btn btn-primary btn-sm bg-[var(--accent)] text-[var(--bg)] border-none hover:bg-[var(--accent-hover)]">
                        <i data-lucide="save" class="mr-2 h-4 w-4"></i> Save
                    </button>
                </div>
            </div>
        </div>

        <h3 class="text-lg font-semibold text-[var(--foreground)] mb-4">Business Information</h3>

        <form id="profile-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">First Name</span>
                </label>
                <input type="text" id="input-first-name"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Last Name</span>
                </label>
                <input type="text" id="input-last-name"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Email Address</span>
                </label>
                <input type="email" id="input-email"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Phone Number</span>
                </label>
                <input type="tel" id="input-phone"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>

            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Company Name</span>
                </label>
                <input type="text" id="input-company"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Partnership Type</span>
                </label>
                <input type="text" id="input-type"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Service Areas</span>
                </label>
                <input type="text" id="input-areas"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Business License</span>
                </label>
                <input type="text" id="input-license"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Website</span>
                </label>
                <input type="url" id="input-website"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Years of Experience</span>
                </label>
                <input type="text" id="input-experience"
                    class="input input-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)]"
                    disabled>
            </div>

            <div class="form-control w-full md:col-span-2">
                <label class="label">
                    <span class="label-text text-[var(--foreground)] font-medium">Business Description</span>
                </label>
                <textarea id="input-bio" rows="3"
                    class="textarea textarea-bordered w-full bg-[var(--input)] border-[var(--border)] text-[var(--foreground)] disabled:opacity-50 disabled:bg-[var(--input)] disabled:text-[var(--muted-foreground)] focus:outline-none focus:border-[var(--accent)] resize-none"
                    disabled></textarea>
            </div>
        </form>

        <div id="save-notification" class="hidden mt-4 p-4 rounded-lg border"></div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
    // --- DATA ---
    let profile = {};

    // --- DOM ELEMENTS ---
    const dom = {
        // Sidebar Initials handled by partial mostly, but for syncing
        sidebarInitials: document.getElementById('sidebar-avatar-initials'),
        sidebarName: document.getElementById('sidebar-user-name'),

        // Profile Display
        avatarInitials: document.getElementById('profile-avatar-initials'),
        displayName: document.getElementById('profile-display-name'),
        memberSince: document.getElementById('profile-member-since'),
        displayRole: document.getElementById('profile-role'),

        // Form Inputs
        inputFirstName: document.getElementById('input-first-name'),
        inputLastName: document.getElementById('input-last-name'),
        inputEmail: document.getElementById('input-email'),
        inputPhone: document.getElementById('input-phone'),
        inputCompany: document.getElementById('input-company'),
        inputType: document.getElementById('input-type'),
        inputAreas: document.getElementById('input-areas'),
        inputLicense: document.getElementById('input-license'),
        inputWebsite: document.getElementById('input-website'),
        // These fields are in template but not model yet
        inputExperience: document.getElementById('input-experience'),
        inputBio: document.getElementById('input-bio'),



        // Actions
        btnEdit: document.getElementById('btn-edit-profile'),
        btnCancel: document.getElementById('btn-cancel-profile'),
        btnSave: document.getElementById('btn-save-profile'),
        editActions: document.getElementById('edit-actions'),
        saveNotification: document.getElementById('save-notification')
    };

    // --- INITIALIZATION ---
    function init() {
        if (window.lucide) lucide.createIcons();
        fetchProfile();
        setupEventListeners();
    }

    // --- UTILS ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- API CALLS ---
    async function fetchProfile() {
        try {
            const response = await fetch('/api/v1/partner/profile/');
            if (!response.ok) {
                if (response.status === 403 || response.status === 401) {
                    window.location.href = "{% url 'login' %}";
                    return;
                }
                throw new Error('Failed to fetch profile');
            }
            const data = await response.json();

            // Map API data to local profile object
            profile = {
                firstName: data.first_name,
                lastName: data.last_name,
                email: data.email,
                phone: data.phone_number,
                companyName: data.company_name,
                partnershipType: data.partnership_type, // Use display value if needed
                partnershipTypeDisplay: data.partnership_type_display,
                serviceAreas: data.service_areas,
                website: data.website_url,
                businessLicense: data.business_license_number,
                joinDate: data.member_since,
                // Missing fields
                experience: "",
                bio: "",

            };

            populateData();
        } catch (error) {
            console.error("Error fetching profile:", error);
            // Optional: Show error toast
        }
    }

    async function saveProfile() {
        dom.btnSave.innerHTML = `<span class="loading loading-spinner loading-xs"></span> Saving...`;

        const payload = {
            user: {
                first_name: dom.inputFirstName.value,
                last_name: dom.inputLastName.value,
                phone_number: dom.inputPhone.value
            },
            company_name: dom.inputCompany.value,
            partnership_type: dom.inputType.value,
            service_areas: dom.inputAreas.value,
            website_url: dom.inputWebsite.value,
            business_license_number: dom.inputLicense.value,
            // bio/experience not in model yet
        };

        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch('/api/v1/partner/profile/', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                const data = await response.json();
                // Refresh data to ensure sync
                await fetchProfile();

                setEditMode(false);
                dom.btnSave.innerHTML = `<i data-lucide="save" class="mr-2 h-4 w-4"></i> Save`;
                if (window.lucide) lucide.createIcons();

                // Success Message
                dom.saveNotification.className = "mt-4 alert alert-success text-sm";
                dom.saveNotification.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5"></i> <span>Profile updated successfully!</span>`;
                dom.saveNotification.classList.remove('hidden');
                if (window.lucide) lucide.createIcons();

                setTimeout(() => {
                    dom.saveNotification.classList.add('hidden');
                }, 3000);
            } else {
                throw new Error("Failed to update");
            }

        } catch (e) {
            console.error(e);
            dom.btnSave.innerHTML = `<i data-lucide="save" class="mr-2 h-4 w-4"></i> Save`;
            if (window.lucide) lucide.createIcons();
            alert("Failed to save profile changes.");
        }
    }

    // --- LOGIC ---

    function populateData() {
        if (!profile.firstName) return;

        // Text Elements
        const fullName = `${profile.firstName} ${profile.lastName}`;
        const initials = ((profile.firstName?.[0] || '') + (profile.lastName?.[0] || '')).toUpperCase();

        if (dom.avatarInitials) dom.avatarInitials.textContent = initials;
        if (dom.sidebarInitials) dom.sidebarInitials.textContent = initials;
        if (dom.displayName) dom.displayName.textContent = fullName;
        if (dom.sidebarName) dom.sidebarName.textContent = fullName;
        if (dom.memberSince) dom.memberSince.textContent = `Partner since ${profile.joinDate}`;
        if (dom.displayRole) dom.displayRole.textContent = profile.partnershipTypeDisplay || profile.partnershipType;

        // Inputs
        if (dom.inputFirstName) dom.inputFirstName.value = profile.firstName;
        if (dom.inputLastName) dom.inputLastName.value = profile.lastName;
        if (dom.inputEmail) dom.inputEmail.value = profile.email;
        if (dom.inputPhone) dom.inputPhone.value = profile.phone;
        if (dom.inputCompany) dom.inputCompany.value = profile.companyName;
        if (dom.inputType) dom.inputType.value = profile.partnershipType;
        if (dom.inputAreas) dom.inputAreas.value = profile.serviceAreas;
        if (dom.inputLicense) dom.inputLicense.value = profile.businessLicense;
        if (dom.inputWebsite) dom.inputWebsite.value = profile.website;
        if (dom.inputExperience) dom.inputExperience.value = profile.experience || "";
        if (dom.inputBio) dom.inputBio.value = profile.bio || "";


    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Edit Profile
        if (dom.btnEdit) dom.btnEdit.addEventListener('click', () => setEditMode(true));
        if (dom.btnCancel) dom.btnCancel.addEventListener('click', () => {
            setEditMode(false);
            populateData(); // Reset
        });
        if (dom.btnSave) dom.btnSave.addEventListener('click', (e) => {
            e.preventDefault();
            saveProfile();
        });
    }

    function setEditMode(isEditing) {
        dom.btnEdit.parentElement.classList.toggle('hidden', isEditing);
        dom.editActions.classList.toggle('hidden', !isEditing);

        const inputs = document.querySelectorAll('#profile-form input, #profile-form textarea');
        inputs.forEach(input => input.disabled = !isEditing);

        // Email is usually read-only
        if (dom.inputEmail) dom.inputEmail.disabled = true;
    }

    init();
</script>
{% endblock %}